---
tags:
  - 数据库
---

# 数据库恢复技术

数据库恢复技术主要用于数据库异常终止导致的数据丢失问题，以确保 [[00_Inbox/数据库/数据库的完整性|数据库的完整性]]。

## 事务

> [!definition|事务] 用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位。

> [!note] 事务和程序
> 在关系数据库中，一个事务可以是一条 [[00_Inbox/数据库/SQL|SQL]] 语句，一组 SQL 语句或者整个程序。一个应用程序一般包含多个事务。
>
> 事务处理技术主要包括数据库恢复技术和 [[00_Inbox/数据库/数据库并发控制|数据库并发控制]]，*事务是数据库恢复和并发控制的基本单位*。

### 事务的定义

- 隐式方式：当用户没有显示地定义事务时，DBMS 按缺省规定自动划分事务。
- 显示定义方式：
```sql
BEGIN TRANSACTION
  SQL 语句1
  ......
COMMIT|ROLLBACK
```
- **COMMIT**： 提交事务，表示事务正常结束，提交事务的所有操作、对数据库的所有更新对数据库永久有效。
- **ROLLBACK**：回滚事务，表示事务异常终止，不能执行回滚事务的所有更新操作，恢复到事务开始时的状态。

### 事务的特征

事务的四个特征（即 ACID）：
- **原子性**(Atomicity)：事务是数据库的逻辑工作单位，事务中包括的诸操作要么都做，要么都不做。
- **一致性**(Consistency)：事务执行的结果必须是使数据库从一个一致性状态到另一个一致性状态
	- 一致性状态：数据库中只包含成功事务提交的结果。
	- 不一致状态：数据库中包括失败事务的结果。
- **隔离性**(Isolation)：对并发执行而言，一个事务的执行不能被其他事务干扰。
	- 一个事务内部的操作及使用的数据对其他并发事务是隔离的。
	- 并发执行的各个事务之间不能互相干扰。
- **持续性**(Durability)：也称永久性，一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。

> [!note]
> 保证事务 ACID 特征是事务处理的任务，以下因素会破坏事务 ACID 特性：
> - 多个事务并行运行时，不同事务的操作交叉执行，需要并发控制机制
> - 事务在运行过程中被强制停止，需要恢复机制

## 数据库恢复技术

> [!note] 数据库恢复技术的必要性
> 在数据库中故障是不可避免的，因此数据库系统必须提供对故障的对策以保证故障发生后，能把数据库中的数据从错误状态恢复到某种逻辑一致的状态，以此保证事务的 ACID。

恢复技术是衡量系统优劣的重要指标。数据库可能发生各种故障，大致可以分为：
1. **系统故障**：造成系统停止运转的任何事件，使系统需要重新启动。在这种情况下，整个系统的正常运行突然被破坏、所有正在运行的事务都非正常终止、内存中数据库缓冲区的信息全部丢失、外部存储设备上的数据未受影响。 ^a72d93
	- 常见原因：操作系统故障，DBMS 代码错误，特定类型的硬件错误，系统断电。
2. **事务内部的故障**：某个事务在运行过程中由于种种原因未运行至正常终止点就夭折了。 ^2024f2
	- 有的终止是**预期**中的，可以通过事务程序本身发现的，例如转账中余额不足。
	- 有的故障是**非预期**的，不能由应用程序处理，例如运算溢出、违反了某些完整性约束、并行事务发生死锁而被选中撤销等。*之后介绍的内部故障都是指非预期的*。
3. **介质故障**：存储在外存中的数据部分丢失或全部丢失，这类故障比系统故障和事务内部的故障可能性小得多，但破环性最大。 ^f3514d
	- 常见原因：磁盘损坏、磁头碰撞，瞬时强磁场干扰。
4. **其他原因**：某些恶意人为破坏，造成事务异常结束。例如病毒、恶意流氓软件等。

> [!note] 各类故障造成的影响
> - 数据库本身被破坏。
> - 数据库没有被破坏，但是数据可能不正确。

> [!definition|数据恢复基本原理] 利用存储在系统其他地方的冗余数据来重建数据库中已被破坏或不正确的那类数据。即利用**数据冗余**。

> [!note] 恢复机制涉及的关键问题
> 1. 如何利用冗余数据
> 	- 数据转储 (backup)
> 	- 登记日志文件 (logging)
> 2. 如何利用这些冗余数据实施数据库的恢复

### 数据转储

数据转储是数据库恢复中采用的基本技术，DBA 定期地将整个数据库复制到磁带、磁盘或者其他存储介质上保存起来的过程，这些备用的数据称为**后备副本**或**后援副本**。当数据库遭到破坏后可以将后备副本重新装入。

数据的转储方法可以按转储状态分为**动态转储**与**静态转储**，按转储方式分为**海量转储**和**增量转储**。

#### 静态转储

静态转储在系统中无运行事务时进行转储，当转储开始时数据库处于一致性状态，转储期间不允许对数据库的任何存取、修改活动。

> [!note]
> - 优点：实现简单
> - 缺点：
> 	- 降低数据库的可用性
> 	- 转储必须等用户事务结束
> 	- 新的事务必须等转储结束

#### 动态转储

动态转储是转储操作与用户事务并发进行，转储期间允许对数据库进行存取或修改。

> [!note]
> - 优点：
> 	- 不用等待正在运行的用户事务结束。
> 	- 不会影响新事务的运行。
> - 缺点：不能保证副本中的数据正确有效。

#### 海量转储与增量转储

- **海量转储**: 每次转储全部数据库。
- **增量转储**: 只转储上次转储后更新过的数据。

> [!note] 海量转储与增量转储比较
> - 使用海量转储得到的后备副本进行恢复往往更方便
> - 但如果数据库很大、事务处理十分频繁，则增量转储方式更实用更有效

### 日志

**数据库系统日志文件**是用来记录事务对数据库的更新操作的文件，日志文件的格式一般为：
- 以记录为单位的日志文件
	- 日志记录类型：事务的开始标记、结束标记以及所有的更新操作
	- 日志记录内容：事务标识、操作类型、操作对象、更新前后数据的久旧值和新值
- 以数据块为单位的日志文件
	- 日志记录内容：事务标识、被更新的数据块的新旧值

**事务故障恢复系统**和**系统故障恢复系统**必须使用日志文件，而介质故障恢复系统可以配合使用日志文件。

> [!note] 介质故障恢复
> - 在 [[#动态转储]] 方式中必须建立日志文件，后备副本与该日志文件综合起来才能将数据库恢复在一致性状态。
> - 与 [[#静态转储]] 后备副本配合进行介质故障恢复。
> 	- 静态转储的数据是转储结束时刻的一致性数据
> 	- 可利用这些日志文件对已完成的事务进行重做处理
> 	- 可以把数据库恢复到故障前某一时刻的一致性状态而不必重新运行哪些已完成的事务程序

#### 登记日志文件

为了保证数据库是可恢复的，登记日志文件时必须遵循两条原则：
- 登记的次序严格按并行事务执行的时间次序。
- 必须先写日志文件，后写数据库。

> [!note]
> - 写数据库和写日志文件是两个不同的操作，在这两个操作之间可能发生故障。
> - 如果先写数据库修改，而在日志文件中没有登记下这个修改，则以后就无法恢复这个修改了。
> - 如果先写日志，但没有修改数据库，按日志文件恢复时依然有迹可循，不会影响数据库的正确性。

#### 基于日志的恢复技术

基于日志的恢复技术主要有 Redo 技术和 Undo 技术：
- **Redo**：针对发生故障时已经完成的事务，可以用 Redo 操作重做，即 Redo 可以将已经撤销的事务重新进行。
- **Undo**：针对发生故障时还没有提交但是已经在过程中修改了数据库的事务，可以使用 Undo 操作撤销事务，如果需要 Undo 的操作有多个，那么 Undo 操作的顺序必须与写入日志时顺序相反。Undo 可以撤销事务对数据库的修改。

### 数据库恢复策略

#### 事务故障的恢复

[[#^2024f2|事务故障]] 恢复方法：利用日志文件撤销事务已对数据库进行的更改，系统回滚到事务执行前的状态。

事务故障的恢复可以由系统自动完成，不需要用户的干预，完成步骤如下：
1. 反向扫描日志文件，查找该事务的更新操作。
2. 对该事务的更新操作执行逆操作，即将日志记录中的*更新前的值*写入数据库。
3. 继续反向扫描日志文件，查找该事务的其他更新操作，并做同样处理。
4. 如此处理下去，直至得到此事务的开始标记。

#### 系统故障的恢复

> [!note] [[#^a72d93|系统故障]] 造成数据库的不一致状态的原因
> - 一些未完成的事务对数据库的更新已写入数据库。
> - 一些已完成事务对数据库的更新还留在缓冲区没来得及写入数据库。

恢复方法：[[#基于日志的恢复技术]]。
- Undo 故障发生时未完成的事务
- Redo 故障发生时已完成的事务

系统故障的恢复由系统在重新启动时自动完成，不需要用户的干预。故障的恢复步骤：
1. 正向扫描日志文件，创建 Redo 队列与 Undo 队列。
	- Redo 队列：故障发生时已经提交的事务。
	- Undo 队列：故障发生时尚未完成的事务。
2. 对 Undo 队列事务进行 Undo 处理.
	- 反向扫描日志文件，对每个 Undo 事务的更新操作执行逆操作。
3. 对 Redo 队列事务进行 Redo 处理。
	- 正向扫描日志文件，对每个 Redo 事务重新执行登记操作。

#### 介质故障的恢复

[[#^f3514d|介质故障]] 中磁盘上的物理数据和日志文件可能被破坏。恢复方法为：
- 重装数据库系统
- 重做已完成的事务

> [!note] 介质故障的恢复需要 DBA 介入
> - 重装最近转储的数据库副本和相关日志副本
> - 执行系统提供的恢复命令
> - 具体的恢复操作任由 DBMS 完成

介质故障恢复的步骤：
1. 装入最新的后备数据库副本，是数据库恢复到最近一次转储时的一致性状态
   - 对于 [[#静态转储]] 的数据库副本，装入后数据库即处于一致性状态。
   - 对于 [[#动态转储]] 的数据库副本，还须同时装入转储时刻的日志文件副本，结合 Redo+Undo 的方法，才能将数据库恢复到一致性状态。
2. 装入有关的日志文件副本，重做已完成的事务。
   - 首先扫描日志文件，找出故障发生时已提交的事务的标识，将其记入重做队列。
   - 然后正向扫描日志文件，对重做队列中的所有事务进行重做处理。

## 检查点恢复技术

利用 [[#基于日志的数据库恢复|日志技术]] 进行数据库恢复时，恢复子系统必须搜索日志，确定哪些事务需要 Redo 和 Undo，将耗费大量的时间，很多 Redo 处理的事务实际上已经将更新操作写入到数据库中了，然后恢复子系统又重新执行，浪费了大量时间。

检查点技术允许恢复子系统在登录日志期间动态维护日志，其具体措施是
- 在日志文件中增加检查点记录：建立检查点时刻所有正在执行的事务清单，记录这些事务最近一个日志记录的地址。
- 增加重新开始文件：记录每个检查点记录在日志中的位置。

> [!note] 恢复检查点建立的时间
> - 定期：按照预定的一个时间间隔。
> - 不定期：按照某种规则，如日志文件已写满一半时建立一个检查点。

### 检查点恢复技术策略

周期性的建立检查点，动态的维护日志文件：
1. 把日志缓冲区中的内容写入日志文件。
2. 把日志文件中写入一个检查点记录。
3. 把数据库缓冲区的内容写入数据库。
4. 把检查点记录在日志文件中的地址写入重新开始文件。

利用检查点恢复技术进行恢复的步骤：
1. 从重新开始文件中找到最后一个检查点记录
2. 得到检查点时刻的事务清单，把事务清单中的事务列表暂时放入 Undo 队列
3. 从检查点开始正向扫描日志文件
   - 如果有新开始的事务，暂时放入 Undo 队列
   - 如果有提交事务，将该事务从 Undo 队列移动到 Redo 队列
4. 对 Undo 队列事务进行 Undo，对 Redo 队列事务进行 Redo。

### 检查点恢复技术的优点

使用检查点方法可以改善恢复效率：
- 当事务在一个检查点之前完成提交，则该事务对数据库的修改已经写入了数据库，所以不需要进行恢复操作
- 当事务在故障发生时还没有完成提交，予以 Undo 操作
- 当事务在检查点之后才完成提交，他们对数据库的修改可能还在缓存区，尚未写入数据库，所以进行 Redo 操作

> [!example]
> ![[Assets/Pasted image 20230403203312.png]]
> - $T_{4}$ 和 $T_{5}$ 在故障发生时还未完成，所以予以撤销。
> - $T_{2}$ 和 $T_{4}$ 在检查点之后才提交，它们对数据库所做的修改在故障发生时可能还在缓冲区中，尚未写入数据库，所以要 REDO。

> [!note] 使用检查点记录方法使得恢复时不必扫描所有的日志文件，增加了恢复效率。

## 数据库镜像恢复技术

介质故障是对系统影响最为严重的一种故障，介质故障的恢复比较费时，为了预防介质故障，DBA 必须周期性的转储数据库。为了提高数据库的可用性，提出了数据库镜像。
- **数据库镜像**：DBMS 自动把整个数据库或其中的关键数据复制到另一个磁盘上，DBMS 将自动保证镜像数据与主数据的一致性，即每当主数据库更新时，DBMS 自动将更新后的数据复制过去。

> [!note] 镜像数据库的特点
> - 优点：
> 	- 当出现介质故障时，可以由镜像磁盘继续提供使用，同时 DBMS 使用镜像磁盘的数据进行数据库恢复而不需要关闭系统和重装数据库。
> 	- 在没有出现故障时，可以用于并发操作，即一个用户对数据加排他锁修改数据，其他用户可以使用镜像数据库中的数据。
> - 缺点：
> 	- 频繁的复制数据自然会降低系统的运行效率
> 	- 在实际应用中往往只选择对关键数据和日志文件进行镜像，而不是对整个数据库进行镜像

---
< [[00_Inbox/数据库/数据库的安全性|数据库的安全性]] | [[00_Inbox/数据库/数据库并发控制|数据库并发控制]] >
