## 4.数据聚合与分组操作

对数据进行分类、并在每一组上应用一个聚合函数或转换函数，这通常是数据分析工作流中的一个重要部分。pandas提供了一个灵活的Groupby接口，允许你以一种自然的方式对数据集进行切片、切块和总结。

### 1.GroupBy机制

组操作包括**拆分-应用-联合(split-apply-combine)**。

pandas 的 groupby 机制允许我们将数据集进行分组，体现在 groupby 对象中。我们可以通过这个对象进行多种操作。

#### GroupBy的创建

创建一个GroupBy对象可以通过groupby方法。
可以通过axis参数来设置在任意轴向上进行分组。
下面介绍几种创建GroupBy对象的方法。

- **使用列表、数组进行分组**
可以通过与需要分组的轴向长度一致的值列表或值数组进行分组。可以传入任何长度正确的数组，pandas将会一一对应然后进行分组。
- **使用DataFrame的列名进行分组**
可以传入一个列的名字，pandas将会根据该列的内容对数据进行分组。
- **使用字典与Series进行分组**
可以传入一个键值与DataFrame匹配的字典或者索引与DataFrame匹配的Series作为参数，pandas将会根据对应关系对DataFrame进行分组。
- **通过函数分组**
传入一个函数作为参数，该函数将会被每个索引值调用一次，同时返回值会被用作分组名进行分组。
- **根据索引层级进行分组**
分层索引的数据集可以直接根据索引在某个层级上进行聚合。将层级数值或层级名称传递给level关键字。

#### GroupBy的迭代机制

GroupBy对象支持迭代，会生成一个包含组名和数据块的二维元组序列。

#### GroupBy索引

将从DataFrame中创建的GroupBy对象用列名或者列名称数组进行索引时，会产生用于聚合的列子集的效果。
如果传递的是列表或者数组，索引的结果将会是分组的DataFrame，如果只有单个列名作为标量传递，则得到的是分组的Series。

通过参数as_index=False可以禁用分组键作为行索引的行为。

### 2.数据聚合

通过调用聚合方法可以使用GroupBy对象实现分组聚合的操作。下面列举了一些优化的groupby方法：

|函数名|描述|
|:--:|:--:|
|count|分组中的非NA值的数量|
|sum|非NA值的累计和|
|mean|非NA值的均值|
|median|非NA值的算术中位数|
|std、var|无偏的(n-1为分母)标准差与方差|
|min、max|非NA的最小值、最大值|
|prod|非NA值的乘积|
|first、last|非NA值的第一个和最后一个值|

除了上述的聚合方法，我们还可以使用自己定义的聚合函数，将函数以字符串的形式传递给aggregate或agg方法就可以应用到groupby对象中。

#### 逐列及多函数的应用

可以通过多个函数名字符串组成的列表传递多个聚合函数给GroupBy对象，这么做将会返回一个以函数名为列名的DataFrame（lambda函数具有名字\<lambda\>）

可以传递具有自定义名称的元组列表，以将不同的函数运用到不同的分组中。当多个函数应用到同一列时，将会产生一个具有分层列的DataFrame。

#### apply方法

对GroupBy对象使用apply方法传入参数function可以实现分别对每个组使用函数function。该方法在应用中使用的最多。

### 3.数据透视表与交叉表

#### 数据透视表

数据透视表是电子表格程序与其他数据分析软件中常见的数据汇总工具。它根据一个或多个键聚合一张表的数据，将数据在矩阵形式中排列，其中一些分组键是沿着行，一些是沿着列。
在pandas中可以通过pivot_table方法或者顶层的pandas.pivot_table函数实现。
pivot_table参数表

|参数|描述|
|:--:|:--:|
|values|需要聚合的列名；默认情况下聚合所有数值型的列|
|index|在结果透视表的行上进行分组的列名或其他分组键|
|columns|在结构透视表的列上进行分组的列名或其他分组键|
|aggfunc|聚合函数或函数列表（默认情况是'mean'）；可以是groupby上下文的任意有效函数|
|fill_value|在结果表中替换缺失值的值|
|margins|添加行\列小计和总计(默认为False)|

#### 交叉表

交叉表是透视表的特殊情况，计算的是分组中的频率。
可以通过pandas.crosstable来实现交叉表。
crosstable的参数同pivot_table
