---
aliases:
  - IO
  - IO system
tag:
  - 计算机组成原理
---

# 输入输出系统

IO 就是输入输出 (Input/Output)。IO 设备就是可以将数据输入到计算机，或者接手计算机输出数据的外部设备。

IO 接口又称为 IO 控制器、设备控制器，负责协调主机与外部设备之间的数据传输。IO 控制器多种多样，也会指定相应的标准。IO 控制器就是一块芯片，常被继承在主板上。

## IO 接口

### IO 接口的作用

1. 数据缓冲：通过数据缓冲寄存器 (DBR) 达到主机和外设工作速度匹配。
2. 错误与状态检测：通过状态寄存器反馈设备的各种错误、状态信息，供 CPU 查用。
3. 控制和定时：接收从控制总线发来的控制信号、时钟信号。
4. 数据格式转换：串-并、并-串等格式转换。
5. 与主机和设备通信：实现主机-IO 接口-IO 设备之间的通信。

### IO 接口的工作原理

1. 发命令：发送命令字到 IO 控制寄存器，向设备发送命令。(需要驱动程序的协助)
2. 读状态：从状态寄存器读取状态字，获得设备或 IO 控制器的状态信息。
3. 读写数据：从数据缓冲寄存器发送或读取数据，完成主机与外设的数据交换。

### 接口与端口

1. 统一编址：靠不同的地址码区分内存和 IO 设备。访存类的指令都可以访问 IO 端口。(RISC 机器常用)，又称为存储器映射方式。
	- 优点：不需要专门的输入输出指令，所有访存指令都可以直接访问端口，程序设计灵活性高。端口有较大的编址空间，读写控制逻辑电路简单。
	- 缺点：端口占用主存地址空间，使主存地址空间变小，外设寻址时间长 (地址位数多，地址译码慢)
1. 独立编址：靠不同的指令区分内存和 IO 设备。只能用专门的 IO 指令访问 IO 端口。又称为 IO 映射方式。
	- 优点：使用专门 IO 指令，程序编制清晰。IO 端口地址位数小，地址译码块。IO 端口的地址不占用主存地址空间。
	- 缺点：IO 指令类型少，一般只能对端口进行传送操作，程序设计灵活性差。需要 CPU 提供存储器读写，IO 设备读写两组控制信号，增加了控制逻辑电路的复杂性。

## IO 接口的类型

- 按数据传送方式：
	- 并行接口：一个字节或一个字所有位同时传送
	- 串行接口：一位一位地传送
- 按主机访问 IO 设备的控制方式：
	- 程序查询接口
	- 中断接口
	- DMA 接口
- 按功能选择的灵活性
	- 可编程接口
	- 不可编程接口

### 程序查询方式

程序查询方式：
1. CPU 执行初始化程序，并预置传送参数。设置计数器，设置数据首地址。
2. 向 IO 接口发送命令字，启动 IO 设备。
3. CPU 从接口读取设备状态信息
4. CPU 不断查询 IO 设备状态，直到外设准备就绪
5. 传送一次数据
6. 修改地址和计数器参数
7. 判断传送是否结束，未结束则回到 2

> 主要特点：CPU 一旦启动 IO，必须停止现行程序的运行，并在现行程序中插入一段程序。CPU 有踏步等待现象，CPU 与 IO 串行工作。

- 优点：接口设计简单，设备量少。
- 缺点：CPU 在信息传送过程中要花费很多时间用于查询和等待，而且在一段时间内只能和一台外设交换信息，效率大大降低。

### 程序中断方式

#### 中断的基本概念

程序中断指在计算机执行现行程序的过程中，出现某些急需处理的异常情况或特殊情况，CPU 暂时中止现行程序，而转去对这些异常情况或特殊请求进行处理，在处理完毕后 CPU 又自动返回现行程序的断点处，继续执行原程序。

工作流程：
1. 中断请求：中断源向 CPU 发送中断请求信号。
2. 中断响应：响应中断的条件。如果有多个中断源同时提出请求，使用中断判优来选择响应一个中断源。
3. 中断处理：中断隐指令、中断服务程序。

> 关中断作用：用于实现原子操作。
> - 非屏蔽中断：关中断时也会被响应 (如掉电)。
> - 可屏蔽中断：关中断时不会被响应。

#### 中断请求标记

每个中断源向 CPU 发出中断请求的时间是随机的。为了记录中断事件并区分不同的中断源，中断系统需对每个中断源设置中断请求标记触发器 INTR，这些触发器可组成中断请求标记寄存器。

对于外中断，CPU 在统一的时刻即每条指令执行阶段结束前向接口发出中断查询信号，以获取 IO 的中断请求。也就是说，CPU 响应中断的时间是在每条指令执行阶段的结束时刻。

CPU 响应中断必须满足：
1. 中断源有中断请求
2. CPU 允许中断即开中断
3. 一条指令执行完毕，且没用更紧迫的任务。

#### 中断判优

中断判优的实现方式：
- 硬件实现：通过硬件排队器实现，即可以设置在 CPU 中，也可以分散在各个中断源中。通过硬件排队器可以将优先级最高的中断输出。
- 软件实现：通过查询程序实现。比硬件实现慢很多。

中断判优的优先级设置原则：
1. 硬件故障中断属于最高级，其次是软件中断。
2. 非屏蔽中断优于可屏中断。
3. DMA 请求由于 IO 设备传送的中断请求。
4. 高速设备优于低速设备。
5. 输入设备优于输出设备。
6. 实时设备优于普通设备。

#### 中断处理过程

中断隐指令：保存原程序的 PC 值，并让 PC 指向中断服务程序的第一条指令。中断隐指令是在检测中断请求后，CPU 自动完成的一系列指令。中断隐指令的主要任务：
1. 关中断：在中断服务程序中，为了保护中断现场期间不被新的中断所打断，必须关中断。
2. 保存断点。为了保证在中断服务程序执行完毕后能正确的返回到原来的程序，必须将原来程序的断点保存起来，可以存入栈堆，也可以存入指定单元。
3. 引出中断服务程序。引出中断服务程序的实质就是取出中断服务程序的入口地址并传送给程序计数器。
	- 向量地址 (中断类型号)：通过中断向量地址形成部件，将排队器输出转换为了对应的中断服务程序的向量地址。
	- 中断向量：指向中断服务程序的入口地址。

中断服务程序的主要任务：
1. 保护现场：保存通用寄存器和状态寄存器的内容，以便返回原程序后可以恢复 CPU 环境。可以使用栈堆、也可以使用特定存储单元。
2. 中断服务 (设备服务)。
3. 恢复现场：通过出栈指令或取数指令把之前保存的信息送回寄存器中。
4. 中断返回：通过中断返回指令回到原程序断点处。

#### 多重中断

- 单重中断：执行中断服务程序时不响应新的中断请求。
- 多重中断：又称中断嵌套，执行中断服务程序时可响应新的中断请求。
	- 与单重中断不同的是，在保护现场和屏蔽字后，需要再开中断，使得在执行中断服务程序的时候可以接受其他中断。

> 中断屏蔽技术：每个中断源都有一个屏蔽触发器，所有屏蔽触发器组合在一起，便构成一个屏蔽寄存器，屏蔽字寄存器的内容称为屏蔽字。CPU 要具有多重中断的功能，需要满足：
> 1. 在中断服务程序中提前设置开中断指令
> 2. 优先级高的中断源有权中断优先级别低的中断源

> 屏蔽字的设置规律：
> 1. 一般用 1 表示屏蔽，0 表示正常申请
> 2. 每个中断源对应一个屏蔽字
> 3. 屏蔽字中的 1 越多，优先级越高。每个屏蔽字中至少有一个 1 (至少要能屏蔽自身的中断)

#### 程序中断方式

在 CPU 执行周期中，IO 设备在准备数据完成后会发送中断请求，CPU 响应中断指令后回到正常工作状态。

### DMA 方式

1. 接受外设发出的 DMA 请求 (外设传送一个字的请求)，并向 CPU 发出总线请求
2. CPU 响应此总线请求，发出总线响应信号，接管总线控制权，进入 DMA 操作周期
3. 确定传送数据的主存单元地址及长度，并能自动修改主存地址计数和传送长度计数
4. 规定数据在主存和外设间的传送方向，发出读写等控制信号，执行数据传送操作
5. 向 CPU 报告 DMA 操作的结果