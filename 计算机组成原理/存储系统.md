---
aliases:
  - storage 
tag:
  - 计算机组成原理
---

# 存储系统

## 存储器概述

存储器包含 CPU 中的**寄存器、Cachae、主存、辅存**。存储器的层次结构，从速度快到速度慢，从容量小到容量大，从价格高到价格低可以划分为：
- 寄存器：CPU 在进行计算时会将变量保存到寄存器中；
- Cache：高速缓冲存储器，用于缓冲主存和 CPU 速度不匹配的问题；
- 内存：可以直接被 CPU 读写的最大单位，后面的都不可以被 CPU 直接读写；
- 辅存：一般将磁盘称为辅存，包括机械硬盘和固态硬盘；
- 外存：光盘、U 盘等，辅存和外存一般看作一个东西，很少区分开；

> [!note] 存储器结构层次
> 存储器层次结构的主要思想是**上一层的存储器作为低一层存储器的高速缓存**。当 CPU 要从存储器中存取数据时，先访问 Cache，若不在 Cache 中，则访问主存，若不在主存中，则访问磁盘。
> - **Cache-主存层**主要解决 CPU 和主存速度不匹配的问题。主存和 Cache 之间的数据调动是由硬件自动完成的，*对所有的程序员均是透明的*。
> - **主存-辅存层**主要解决存储系统的容量问题，主存和辅存之间的数据调动是由硬件和操作系统共同完成的，*对应用程序员是透明的*。

> [!tip] 
> 在 Cache-主存层和主存-辅存层中，上一层中的内容都只是下一层中的内容的副本，也即 Cache (或者主存) 中的内容只是主存 (或者辅存) 中的内容的一部分。

### 存储器的分类

存储器种类繁多，可以从不同的角度对存储器进行分类。

> [!note] 按层次结构分类
> 1. 主存储器。简称主存，也称为内存，用来存放计算机运行期间所需的程序和数据。CPU 可以直接随机地对其进行访问，也可以通过和高速缓冲存储器 (Cache) 及辅助存储器交换数据。其特点是*容量较小，存储器速度较快，每位的价格较高*。
> 2. 辅助存储器。简称为辅存，也称为外存储器或外存，用来存放当前暂时不用的程序和数据，以及一些需要永久性保存的信息。辅存的内容需要调入主存后才能被 CPU 访问，其特点是*容量大，存取速度较慢，单位成本低*。
> 3. 高速缓冲存储器。简称 Cache，位于主存和 CPU 之间，用来存放当前 CPU 经常使用的指令和数据，以便 CPU 能够高速地访问它们。Cache 的存取速度可以与 CPU 的速度相匹配，但是*储存容量小、价格高*。现代计算机通常将它们制作在 CPU 中。

> [!note] 按存储介质分类
> 1. 半导体存储器，以半导体介质存储信息
> 2. 磁性表面存储器：以磁性材料存储信息
> 3. 光存储器：以光介质存储信息

> [!note] 按照存取方式分类
> 1. 随机存储器 (random Access Memory, RAM)。存储器读写任何一个存储单元所需的时间都相同，与单元的物理位置无关。其优点是*读写方便，使用灵活*，主要用于主存或者高速缓冲存储器。RAM 又分为静态 RAM 和动态 RAM。
> 2. 只读存储器 (Read Only Memory, ROM)。存储器的内容只能顺序读出而不能写入，信息一旦写入存储器就固定不变，即使断电，内容也不会丢失。因此，通常用它存放固定不变的程序、常数和汉字字库等。它与随机存储器一起作为主存的一部分，统一构成主存的地址域。
> 3. 串行访问存储器。对存储单元进行读写操作时，需按照其物理位置的写入顺序寻址，包括顺序存存取存储器和直接存取存储器。
> 	1. 顺序存取存储器 (Sequential Access Memory, SAM)：读写一个存储单元所需的时间取决于存储单元所在的物理位置。例如磁带。
> 	2. 直接存取存储器 (Direct Access Memory, DAM)：既有随机存取性也有顺序存储性。先直接选取信息所在的区域，然后按顺序方式存取。例如磁盘、光盘等。
> 4. **相联存储器** (Associative Memory)，既是可以**按内容访问**的存储器 (Content Addressed Memory, CAM)**，也可以按照内容检索到存储位置**进行读写。"快表"就是一种相联存储器。

> [!note] 按照信息的可保存性
> 1. 断掉后，存储信息消失的存储器，称为**易失性存存储器** (例如 RAM)。
> 2. 断电后，存储信息依然保持的存储器，称为**非易失性存储器** (磁盘，光盘，ROM)。
> 3. 信息读出后，原存储信息被破坏，称为破坏性读出。具有破坏性读出性能的存储器，每次读出操作后，必须紧接着一个再生的操作，以便恢复破坏的信息。
> 4. 信息读出后，原存储信息不被破坏，称为非破坏性读出。

### 存储器的性能指标

设计存储系统所追求的目标就是大容量、低成本和高速度，因此存储器的三个主要性能指标为：
1. **存储容量**：存储字数×存储字长 (例如 1M×8 位)。存储字数表示存储器的地址空间大小，字长表示一次存取操作的数据量。
2. **单位成本**：每位价格=总成本/总容量。
3. **存储速度**：数据传输速率 (每秒传送信息的位数) = 数据的宽度/存储周期 (数据的宽度即存储字长)
	1. 存取时间 ($T_{a}$)：存取时间是指从启动一次存储器操作到完成该操作所经历的时间，分为读出时间和写入时间。
	2. 存取周期 ($T_{m}$)：存取周期又称为读写周期或者访问周期，指存储器进行一次完整的读写操作所需的全部时间，即连续两次独立的访问存储器操作 (读或者写) 之间所需的最小时间间隔。
	3. 主存带宽 ($B_{m}$)：主存带宽又称为数据传输速率，表示每秒从主存进出信息的最大数量，单位为字/秒、字节/秒或者位/秒。

> [!note]
> **存取时间不等于存取周期，通常存取周期大于存取时间**。这是因为对任何一种存储器，在读、写操作后，总要有一段恢复内部状态的复原时间。对于破坏性读出的存储器，存取周期往往比存取时间大得多。

> [!example]- 存储器时间与存储周期的关系
> ![[image/storage-1.png|300|存取周期与存取时间的关系]]

## 主存储器的基本组成

### 基本半导体元件及原理

一个基本存储元有下面的两个部分组成：
1. MOS 管：半导体元件，输入电压到达某个阈值时，MOS 管就可以接通。
2. 电容：使用电容的充电与放电状态表示二进制的 01。

将多个存储元以合理的方式连接，可以构成一个存储体。一般存储一个字节的存储元集合称为一个存储单元。使用译码器可以从多个存储单元中选择一条读出一个字的数据。然后 CPU 可以从数据总线中得到的数据。

为了控制地址的输入，需要一个控制电路来控制译码器的使用与数据的读写。逻辑上可以将一个存储芯片分为下面的几个部分：
1. 片选线：表示该芯片目前是否可用，一般的内存条不止一块存储芯片
2. 地址线：表示需要读取的地址，将会被输入给译码器
3. 数据线：地址线表示的地址所在的数据单元的数据
4. 读写控制线：有时被分为两根线，表示数据的读取与写入
5. 译码驱动：译码器与驱动器电路
6. 存储矩阵：将多个存储元以合理的方式连接得到的存储体
7. 读写电路：控制电路中控制读与写的部分
8. 其他部分：包括供电、接地等功能

![[Pasted image 20231107160806.png]]

根据上面的原理，可以得到一个存储体的总容量的计算方式为：
$$
\tiny 总容量=存储单元个数\times 存储字长
$$
常见的描述 (存储单元×存储字长)：
- $8k\times 8$ 位，即 $2^{13}\times 8bit$
- $8k\times 1$ 位，即 $2^13\times 1bit$
- $64k\times 16$ 位，即 $2^16\times 16bit$

#### 寻址

现在计算机一般是按字节编址的。假设总容量为 $1k$，那么
1. 按字节寻址：$1 k$ 个单元，每个单元 $1B$
2. 按字寻址：$256$ 个单元，每个单元 $4B$
3. 按半字寻址：$512$ 个单元，每个单元 $2B$
4. 按双字寻址：$128$ 个单元，每个单元 $8B$

## 主存储器

我们通常把存放一个二进制位的物理器件称为**存储元**，它是存储器的最基本的构件。地址码相同的多个存储元构成一个存储单元，若干存储单元的集合构成存储体。

半导体存储器分为随机存储器 (RAM) 和只读存储器 (ROM)。而 RAM 又分为静态随机存储器 (SRAM) 和动态随机存储器 (DRAM)，主存储器主要由 DRAM 实现，而靠近处理器的那一层 (Cache) 则由 SRAM 实现。

> [!note] SRAM 和 DRAM 的区别
> 1. 存储元不一样 (核心区别)：
> 	1. DRAM 使用栅极电容存储信息：破坏性读出，读写后应该有重写的操作，称为再生。读写速度更**慢**。每个存储元的制造成本**更低**，集成度更**高**，功耗**低**。
> 	2. SRAM 使用双稳态触发器存储信息：读出数据，触发器状态保持稳定，是非破坏性读出，无需重写。读写速度更**快**。每个存储元制造成本更**高**，集成度**更低**，功耗**大**。
> 2. DRAM 常用作 Cache，SRAM 常用作内存。
> 3. DRAM 需要进行刷新，SRAM 不需要进行刷新。

> [!warning] SRAM 与 DRAM 都是易失性存储器。

### SRAM

静态随机存储器 SRAM 的存储元是用双稳态触发器 (六晶体管 MOS) 来记忆信息的，静态是指即使信息被读出后，它仍然保持其原状态而不需要再生 (**非破坏性读出**)。

> [!note] 
> SRAM 的读取速度快，但是集成度低，功耗较大，价格昂贵，一般用于高速缓冲存储器 (Cache)。

### DRAM

动态随机存储器 (DRAM) 是利用存储元电路中栅极电容上的电荷来存储信息的，DRAM 的基本存储元通常只使用一个晶体管，所以它比 SRAM 的密度要高很多。

> [!note] 
> 相对于 SRAM 来说，DRAM 具有集成度高、价位低和功耗低等有点，但是 DRAM 的存取速度比 SRAM 慢，且必须定时刷新和读后再生，一般用于大容量的主存系统。

#### DRAM 的刷新

DRAM 电容上的电荷一般只能维持 1~2ms，因此即使电源不断电，信息也会自动消失。此外，读操作会使其状态发生改变 (破坏性读出)，需要读后再生，因此其被称为动态存储器。

刷新可以采用读出的方法进行，根据读出的内容对相应的单元进行重写，即读后再生。对同一行进行相邻两次刷新的时间间隔称为**刷新周期**，通常使用 2ms。常用的刷新方式有以下 3 种：
1. 集中刷新：集中安排时间全部刷新。*在一个段固定的时间内，一次对存储器的所有行进行逐一再生，再次期间停止对存储器的读写操作，称为死时间，也称为访存死区*。
	- 优点：读写操作时不再受刷新工作的影响。
	- 缺点：在集中刷新区间不能访问存储器。
2. 分散刷新：将一个存储器系统的工作周期分为两部分：前半部分用于正常的读操作，后半部分用于刷新。*这种刷新方式大大增加了系统的存储周期，如果存储器芯片的存取周期为 0.5μs，则系统的存取周期为 1μs*。
	- 优点：没有死区。
	- 缺点：加长了系统的存取周期。
3. 异步刷新：结合了前两种方法，使得在一个刷新周期内每一行仅刷新一次。具体做法是将刷新周期除以行数，得到相邻两行之间刷新的时间间隔 t，每隔时间 t 产生一次刷新请求。
	- 优点：使得死区的分布分散，避免让 CPU 连续等待过长时间。

> [!note] 
> DRAM 刷新需要注意以下问题：
> 1. 刷新对于 CPU 是透明的，刷新不依赖于外部访问，是自动完成的。
> 2. DRAM 的刷新是以行为单位的，由芯片内部自行生成行地址。
> 3. 刷新操作类似于读操作，但是不同。
> 4. 刷新不需要选片，整个存储器的所有芯片同时被刷新。

> [!info] 使用行列地址的原因
> 将地址的前半部分作为行地址，送入行地址译码器，将后半部作为列地址，送入列地址译码器。**使用行列地址可以减少选通线的数量**。

#### DRAM 的地址线复用技术

将行地址与列地址分两次送，可以使地址线更少。

## ROM

ROM 为只读存储器。常用于存储计算机中的 Bios 等。

- MROM：掩模式只读存储器。厂家按照客户要求，在芯片的生产过程中直接写入信息，之后任何人不可重写。可靠性高，灵活性差，生产周期长，只适合批量定制。
- PROM：可编程只读存储器。用户可用专门的 PROM 写入器写入信息。写一次后就不可以更改。
- EPROM：可擦除可编程的只读存储器。允许用户写入信息，之后用某种方式擦除数据，可以多次重写。
	- UVEPROM：用紫外线照射，可以擦除所有的信息
	- EEPROM，可用电擦除的方式，擦除特定的字
- Flash Memory：闪速存储器 (U 盘、SD 卡就是闪存)。在 EEPROM 基础上发展而来，断电后也可以保存信息，且可以进行多次快速擦除重写。
- SSD：固态硬盘。由控制单元+存储单元构成。SSD 速度快、功耗低、价格高。

#### 计算机内的重要 ROM

断电后 RAM 内部数据全部丢失。所以引导开机的程序不能存储在 RAM 上。主板上的 BIOS 芯片存储的自具装入程序，负责引导操作系统 (开机)。

## 双端口 RAM 和多模块存储器

DRAM 芯片的恢复时间比较长，可能是存取时间的几倍。为了提升主存的速度，提出了双口 RAM 和多模块存储器的概念。

### 双端口 RAM

双端口 RAM 可以优化多核 CPU 访问一根内存条的速度。该技术需要有两组完全独立的数据线、地址线、控制线。CPU、RAM 中也要有更加复杂的控制电路。

两个端口对同一主存操作一般有下面的 4 中情况，其中：
1. 两个端口同时对不同的地址单元存取数据。
2. 两个端口同时对同一地址单元读出数据。
3. 两个端口同时对同一地址单元写入数据。该操作会导致冲突，不应该被允许。
4. 两个端口同时对同一地址单元，一个写入数据、另一个读出数据。该操作也会导致错误，不应该被允许。

为了解决同时访问的问题，使用下面的方法：
- 置忙信号为 0，有判断逻辑决定暂时关闭一个端口 (即被延时)，未被关闭的端口正常访问，被关闭的端口延长一个很短的时间段后再访问。对比操作系统中的 [[进程管理#读者写者问题]]。

### 多体并行存储器

每个模块都有相同的容量和存取速度。各模块都有独立的读写电路、地址寄存器和数据寄存器。他们既能并行工作，又能交叉工作。

访问多体并行的存储器有下面的两种策略，考虑连续访问的情况：
- 高位交叉编址的多体存储器：将最高的几位作为所在存储器的编码。使用这种方式大量的时间在等待存储器的其他操作，读取的时间占用的时间很短。
- 地位交叉编址的多体存储器：将最低的几位作为所在存取器的编码。使用这种方式可以在连续访问时交换的访问每个存储器，大部分时间花在读取时间。

采用流水线的方式并行存取。存取周期为 T，存取时间为 r，为了使流水线不间断，应当保证模块数 $m\geqslant T/r$。

> 单体多字存储器：每个存储单元存储 m 个字，总线宽度也为 m 个字，一次并行读出 m 个字。
> - 这种方式每次只能同时读取 m 个字，不能单独取其中某个字。因此指令和数据在内存中必须是连续存放的。平均下来提升的速度与上面的方法相同。

## 主存储与 CPU 的连接

![[Pasted image 20231107171820.png]]

为了便于描述，下面为存储器芯片的输入与输出进行命名：
- 地址线：$A_0\to A_7$
- 数据线：$D_0\to D_7$
- 片选线：低电平有效 $\overline{CS}$ 或者 $\overline{CE}$，高电平有效 $CS$ 或者 $CE$
- 读写控制线：低电平读，高电平写 $\overline{WE}$ 或者 $\overline{WE}$，也可以分开为 $\overline{WE}$ 与 $\overline{OE}$ 两根。

### 增加主存的字长

#### 位扩展

为扩展用于数据总线没有被用完的情况。将地址总线送入每个存储芯片，然后将每个信息的输入分别送到一个数据总线上，将数据总线占满。

![[Pasted image 20231107172515.png]]

#### 字扩展

字扩展用于 CPU 地址总线没有用完的情况。基本思路为将地址总线输入到每个存储芯片中，然后使用剩余的 CPU 地址线来控制每个存储芯片的片选信号 (CS)。
- 线选法：每个片选信号直接由一个地址位控制。这样得到的地址不能有重复的 1 或者都为 0。利用率过低。
- 译码器片选法：使用译码器来输出片选信号。n 条线对应 $2^n$ 个选片信号。这样得到的地址是连续的。

#### 字位同时扩展法

位扩展法更好的利用了 CPU 的数据总线传输能力，字扩展法更好的利用了 CPU 的寻址能力。

![[Pasted image 20231107174020.png]]

字位同时扩展法就是同时利用两种方法，分别在两个维度扩展。

## 外存储器

计算机中的外存储器又称为辅助存储器。本节内容与 [[操作系统/内存管理]] 进行联系。常用的是磁表面存储器，其特点为：
- 优点：
	1. 存储容量大，位价格低
	2. 记录介质可以重复使用
	3. 记录信息可以长期保存不丢失，甚至可以脱机存档
	4. 非破坏性读出，读出时不需要再生
- 缺点：
	1. 存取速度慢
	2. 机械结构复杂
	3. 对工作环境要求较高

> 磁表面存储器的输入与输出一次只能 1 bit 数据，且不能同时读写。因此需要一个电路将并行输入的数据转换为串行的数据。

外存储器即可用于输入也可以用于输出。

### 磁盘存储器

磁盘设备的组成：
1. 存储区域：一个磁盘有若干个记录面，每个记录面划分为若干个磁道，而每个磁道又划分为若干个扇区。扇区是磁盘读写的最小单位，也就是说磁盘按块存取。
	- 磁头数：即记录面数，表示硬盘总共有多少个磁头，磁头用于读取、写入盘片上记录面的信息。一个记录面对应一个磁头。
	- 柱面数：表示硬盘每一面盘面上有多少条磁道。在一个盘组中，不同记录面的相同编号的诸磁道。
	- 扇面区：表示每条磁道上有多少扇区
2. 硬盘存储器：硬盘存储器由磁盘驱动器、磁盘控制器和盘片组成。
	- 磁盘驱动器：核心部件是磁头组件和盘片组件。
	- 磁盘控制器：是硬盘存储器和主键的接口，主流的标准有 IDE、SCSI、SATA 等。

磁盘的性能指标：
1. 磁盘的容量：一个磁盘所能存储的字节总数称为磁盘容量。磁盘容量有非格式化容量和格式化容量之分。
	- 格式化容量：磁记录表面可以利用的磁化单元总数
	- 非格式化容量：按照某种特定的记录格式所能存储信息的总量
2. 记录密度：记录谜底指盘片单位面积上记录的二进制的信息量，通常以道密度、位密度和面密度表示。 
	- 道密度：沿磁盘半径方向单位长度上的磁道数。
	- 位密度：磁道单位长度上能记录的二进制代码位数。
	- 面密度：位密度和道密度的乘积。
 3. 平均存取时间：平均存取时间=寻道时间 (磁头移动到目的磁道)+旋转延迟时间 (磁头定位到所在盘区)+传输时间 (传输数据所花费的时间)+磁盘控制器的延迟时间。
 4. 数据传输率：磁盘存储器在单位内向主机传送数据的字节数。

磁盘的地址结构：主机向磁盘控制器发送寻址信息，磁盘的地址一般如图所示：
$$
\tiny 驱动器号+柱面(磁盘)号+盘面号+扇区号
$$

硬盘的工作过程：磁盘的主要操作是寻址、度盘、写盘。
1. 取控制字
2. 执行控制字

### 磁盘阵列

RAID (Redundant Array of Inexpensive Disks) 廉价冗余磁盘阵列，是将多个独立的物理磁盘组成一个独立的逻辑盘，数据在多个物理盘上分割交叉存储、并行访问，具有更好的存储性能、可靠性、安全性。RAID 的分级如下，级别越高的分级越可靠：
- RAID 0：无冗余和无校验的磁盘阵列，没有容错能力
- RAID 1：镜像磁盘阵列，由容错能力，但是两个磁盘当一个磁盘使用，容量较少一般
- RAID 2：采用纠错的海明码的磁盘阵列
- RAID 3：位交叉奇偶校验的磁盘阵列
- RAID 4：块交叉奇偶校验的磁盘阵列
- RAID 5：无独立校验的奇偶校验磁盘阵列

RAID 技术有以下特点：
- 通过同时使用多个磁盘，提高了传输率。
- 通过在多个磁盘上并行存取来大幅提高存储系统的数据吞吐量。
- 通过镜像的功能，可以提高安全可靠性。
- 通过数据校验，可以提供容错能力。

## 固态硬盘 SSD

期末不考，pass，后面补上

## Cache

Cache 是高速存储缓冲器，用于缓冲内存与 CPU 间的速度差异。Cache 通常被集成在 CPU 内部，使用 SRAM 实现，速度快，成本高。

Cache 的思想：基于局部性原理，可以把 CPU 目前访问的地址周围的部分数据放到 Cache 中。

常使用 Cache 的命中率和缺失率来计算 CPU 的性能：
- 命中率 $H$：CPU 欲访问的信息已经在 Cache 中的比率
- 缺失率 $M$：未命中的概率 $M=1-H$

Cache 主存系统的访问有两种策略：
- 先访问 Cache，若 Cache 未命中在访问主存：平均访问时间为 $t=Ht_c+(1-H)(t_c+t_m)$
- 同时访问 Cache 和主存，若 Cache 命中则立即停止访问主存：平均访问时间为 $t=Ht_c+(1-H)t_m$

> 如何界定周围的数据：将主存的存储空间分块，主存与 Cache 之间以块为单位进行数据交换。实际上就是 [[内存管理#基本分页存储管理的概念]] 为单位进行交换的。

#### Cache 与主存的映射方式

##### 全相联映射 (随意放)

主存块可以放在 Cache 的任意位置。在这种映射方式中，每个 Cache 的大小与主存块的大小是相同的。在这种方式中，Cache 块中除了要需要记录对应的主存块号，还需要记录一个有效位表示该位是否有效。

CPU 访问主存地址的步骤：
1. 将主存地址的主存块号与 Cache 中的所有块进行对比
2. 若匹配且有效位为 1，则 Cache 命中，访问对应的块内地址
3. 若未命中或有效位为 0，则正常访问主存

- 优点：Cache 存储空间利用充分，命中率高。
- 缺点：查找标记最慢，有可能需要对比所有的行的标记

##### 直接映射

每个主存块只能放到一个特定的位置。Cache 块号=主存块号\%Cache 总块数。

CPU 访问主存地址的步骤 (n 表示 Cache 共有 $2^n$ 行)：
1. 根据主存块号的后 n 位确定 Cache 的行
2. 若主存块号与 Cache 标记匹配且有效位为 1，则 Cache 命中。
3. 若未命中或有效位为 0，则正常访问主存。

- 优点：计算简便。只需要对比一个标记，速度最快。
- 缺点：每个块号只能使用对应的块，即使别的块有空闲，也不能使用。Cache 的存储空间利用不充分，命中率低。
##### 组相联映射

Cache 块分为若干组。每个主存块可放到特定分组的任意一个位置。组号=主存块号\%分组数。

CPU 访问主存地址的步骤 (n 表示 Cache 共有 $2^n$ 个组)：
1. 根据主存块号的后 n 位确定 Cache 的组
2. 对比主存块号与 Cache 的组内的所有标记，若有匹配且有效位为 1，则 Cache 命中。
3. 若未命中或有效位为 0，则正常访问主存。

优点：全相连映射与直接映射方式的折中，综合效果好。

> n 路组相联映射：表示每 n 个 Cache 行分为一组。

#### Cache 替换算法

由于每一次被访问的主存块都一定会被装入 Cache 中，因此 Cache 很容易被装满，需要找到一个方式在 Cache 已满的时候选择替换一块。
- 全相联映射：Cache 完全满了才替换需要再全局选择替换那一块。
- 直接映射：不需要选择替换哪一块，如果对应位置非空，则毫无选择的直接替换。
- 组相联映射：分组内满了才需要替换。需要在分组内选择替换哪一块。

Cache 替换算法与 [[内存管理#页面置换算法]] 有异曲同工之处。

##### 随机算法 (RAND)

算法：若 Cache 已满，则随机选择一块替换。

特点：实现简单，但完全没考虑局部性原理，命中率低，实际效果不稳定。

##### 先进先出算法 (FIFO)

算法：若 Cache 已满，则替换最先被调入 Cache 的块。

特点：实现简单，最开始按照 0,1,2,3 放入 Cache 中，之后轮流替换 0,1,2,3。FIFO 依然没有考虑局部性原理，最先被调入 Cache 的块也可能是被频繁访问的。

抖动现象：频繁的换入换出现象。

##### 近期最少使用算法 (LRU)

算法：为每个 Cache 块设置一个计数器，用于记录每个 Cache 块已经有多久没有被访问。当 Cache 满了之后替换计数器最大的。

实现方式：
1. 命中时，所命中的计数器清零，比其低的计数器加 1，其余不变。
2. 未命中且还有空闲行时，新装入的行的计数器置 0，其余空闲行全加 1
3. 为命中且无空闲行时，计数值最大的行的信息块被淘汰，新装入的块的计数器置 0，其余全加 1

这样的实现方式可以保证只需要对于大小为 $2^n$ 的 Cache 只需要 $n$ bit 的冗余信息就可以实现算法。

特点：基于局部性原理，LRU 算法是合理的。LRU 算法的实际运行效果优秀，Cache 的命中率高。

> 若被频繁访问的主存块数量>Cache 行的数量，则有可能发生抖动现象。

##### 最不经常使用算 (LFU)

算法：为每个 Cache 块设置一个计数器，用于记录每个 Cache 块被访问的次数。当 Cache 满后替换计数器最小的。若有多个计数器最小的行，可以按照行号递增、或按照 FIFO 策略进行选择。

特点：曾经经常访问的主存块在未来不一定会用到。因此 LFU 算法并没有很好的遵循局部性原理，因此实际运行效果不然 LRU。

#### Cache 写策略

CPU 修改了 Cache 中的数据副本，Cache 写策略来保证 Cache 与主存中的数据的一致性。

##### 写命中

- 写回法：当 CPU 对 Cache 写命中时，只修改 Cache 的内容，而不立即写入主存，只有当此块被换出时才写回主存。该策略需要添加**脏位**，表示该 Cache 块是否被修改。这种方式无法保证数据的一致性。
- 全写法 (写直通法)：当 CPU 对 Cache 写命中时，必须把数据同时写入 Cache 和主存，一般使用写缓冲。这种方式增加了访存次数，速度变慢，但是更能保证数据的一致性。使用写缓冲，CPU 写的速度很快，如果写操作不频繁，则效果很好。若写操作很频繁，可能会因为写缓冲饱和而发生阻塞。

##### 写不命中

- 写分配法：当 CPU 与 Cache 写不命中时，把主存中的块调入 Cache 中，在 Cache 中修改。通常搭配写会法使用。
- 非写分配法：当 CPU 对 Cache 写不命中时只写入主存，不调入 Cache，搭配全写法使用。

##### 多级 Cache

现代计算机通常采用多级 Cache，离 CPU 越近的速度越快，容量越小。离 CPU 越远的速度越慢，容量越大。
- 各级 Cache 之间常采用全写法+非写分配法
- Cache 与主存之间采用写会法+写分配法

## 页式存储器

本章内容与 [[内存管理#基本分页存储管理的概念]] 高度重合。

在页式存储系统中，一个进程在逻辑上被分为若干个大小相等的页面，页面的大小与块的大小相同，每个页面可以离散地放入不同的主存块中。

## 虚拟存储系统

本章内容详见 [[内存管理#虚拟内存]]。