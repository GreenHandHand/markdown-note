---
tags:
  - 计算机网络
---

# 应用层

|   应用层    | 传输层 | 熟知端口号 |
| :------: | :-: | :---: |
| FTP 数据连接 | TCP |  20   |
| FTP 控制连接 | TCP |  21   |
|  TELNET  | TCP |  23   |
|   SMTP   | TCP |  25   |
|   DNS    | UDP |  53   |
|   TFTP   | UDP |  69   |
|   HTTP   | TCP |  80   |
|   POP3   | TCP |  110  |
|   SNMP   | UDP |  161  |

## 客户/服务器模型

在**客户/服务器**(Client/Server, C/S) 模型中，有一个总是打开的主机称为**服务器**，它服务于许多来自其他称为**客户机**的主机请求。其工作流程如下：
1. 服务器处于接收请求的状态。
2. 客户机发出服务请求，并等待接受结果。
3. 服务器收到请求后，分析请求，进行必要的处理，得到结果并发送给客户机。

服务器上运行着专门用于提供某种服务的程序，可同时处理多个远程或本地客户的请求。客户程序必须知道服务器程序的地址。服务器启动后就一直不断地运行着，被动等待并接受来自各地客户的请求。因此，服务器程序不需要知道客户程序的地址。

> [!note] C/S 模型的主要特点
> 1. 客户服务请求方，服务器是服务提供方。
> 2. 网络中各计算机的地位不平等，服务器可通过对用户权限的限制来达到管理客户机的目的。整个网络的管理工作由少数服务器担当，因此网络的管理非常集中和方便。
> 3. 客户机相互之间不直接通信。
> 4. 可拓展性不佳。受服务器硬件和网络带宽的限制，服务器支持的客户机数有限。

## P2P 模型

P2P 模型的思想是整个网络中的传输内容不再被保存在中心服务器上，每个接点都可同时具有下载和上传的功能，其权利和义务是大体对等的。

在 P2P 模型中，各计算机没有固定的客户和服务器划分，相反，任意一对计算机 (**对等方**，Peer) 直接相互通信。实际上，P2P 从本质上来看仍然使用 C/S 模型，每个结点既作为客户访问其他结点的资源，又作为服务器提供资源给其他结点访问。

> [!note] P2P 模型的主要特点
> - 优点：
> 	1. 减轻了服务器的计算压力，消除了对某个服务器的完全依赖，可以将任务分配到各个结点上，因此大大提供了系统效率和资源利用率。
> 	2. 多个客户机之间可以直接共享文档。
> 	3. 可拓展性好，传统服务器有响应和带宽的限制，因此只能接收一定数量的请求。
> 	4. 网络健壮性强，单个结点的失效不会影响其他部分的结点。
> - 缺点：
> 	- 在获取服务的同时，还要给其他结点提供服务，因此会占用较多的内存，影响整机速度。

## 域名系统

**域名系统**(Domain Name System, DNS) 是因特网使用的命名系统，用来把便于人们记忆的具有特定含义的主机名转化为便于机器处理的 IP 地址。相对于 IP 地址，人们更喜欢使用具有特定含义的字符串来标识因特网上的计算机。

> [!tip] DNS 采用 C/S 模型，协议运行在 UDP 之上，使用 53 号端口

### 层次域名空间

因特网采用层次树状结构的命名方式。采用这种命名方法，任何一个连接到因特网的主机或路由器，都有一个唯一的层次结构名称，即**域名**(Domain Name)。
- **域**(Domain) 是名字空间中一个可被管理的划分。
- 域可以被划分为子域，而子域还可以继续划分为子域的子域，这样就形成了顶级域、二级域、三级域等。
- 每个域名由标号序列组成，而各个标号之间用 `.` 隔开。一个典型的域名为 `www.baidu.com`，它由三个标号组成，其中标号 `com` 是顶级域名，标号 `baidu` 是二级域名，标号 `www` 是三级域名。

> [!tip] 域名
> 1. 标号中的英文不区分大小写。
> 2. 标号中除连字符 `-` 外不能使用其他标点符号。
> 3. 每个标号不超过 63 个字符，多标号组成的完整域名最长不超过 255 个字符。
> 4. 级别最低的域名写在左边，级别最高的域名写在右边。

> [!note] 顶级域名的分类
> 1. **国家 (地区) 顶级域名**(nTLD)。国家和某些地区的域名，例如 `cn` 表示中国，`us` 表示美国，`uk` 表示英国。
> 2. **通用顶级域名**(gTLD)。常见的有 `com` 表示公司，`net` 表示网络服务机构，`org` 表示非盈利性组织，`edu` 表示教育机构，`gov` 表示国家政府部门等。
> 3. **基础结构域名**(arpa)。用于反向域名解析，即 IP 地址反向解析为域名。

在域名系统中，各级域名由上一级的域名管理机构管理，顶级域名由因特网名称和数字地址分配机构 ICANN 管理。国家顶级域名下注册的二级域名均由该国家自行确定，而迷宫组织都可以把它的域名再分成一定数目的子域，并将这些子域委托给其他组织去管理。

### 域名服务器

域名到 IP 地址的解析是由运行在域名服务器上的程序完成的，一个服务器所负责管辖的范围称为**区**，一个区中的所有节点必须是能够连通的，每个区设置相应的权限域名服务器，用来保存该区中所有主机的域名到 IP 地址的映射。每个域名服务器不但能够进行一些域名到 IP 地址的解析，而且还必须具有连向其他域名服务器的信息。当自己不能进行域名到 IP 地址的转换时，能够知道到什么地方去找其他域名服务器。

> [!note] 域名服务器的类型
> 1. **根域名服务器**：最高层次的域名服务器，所有的根域名服务器都知道所有顶级域名服务器的域名和 IP 地址。根域名服务器是最重要的域名服务器，不管是哪个本地域名服务器，要对因特网任何一个域名进行解析，只要自己无法解析，就首先要求助于根域名服务器。
> 2. **顶级域名服务器**：这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名。收到 DNS 查询请求时，就给出相应的回答。
> 3. **权限域名服务器**：每台主机都必须在权限域名服务器处登记。权限域名服务器总能将其管辖的主机名转换为该主机的 IP 地址。
> 4. **本地域名服务器**：本地域名服务器对域名系统非常重要。每个因特网服务提供者都可以拥有一个本地域名服务器，当一台主机发出 DNS 查询请求时，这个查询请求报文就发送给该主机的本地域名服务器。*事实上，我们在 Windows 系统中配置本地连接时，就需要填写 DNS 地址，这个地址就是本地 DNS 的地址*。

### 域名解析过程

**域名解析**是指把域名转换为 IP 地址的过程。当客户端需要解析域名时，通过本机的 DNS 客户端构造一个 DNS 请求报文，以 UDP 数据报方式发往本地域名服务器。域名解析方式有两种：
1. **递归查询**：若主机所询问的本地域名服务器不知道被查询地址的 IP 地址，则本地域名服务器就以 DNS 客户的身份，向根域名服务器继续发出查询请求报文。
2. **迭代查询**：当根域名服务器收到本地域名服务器发出的迭代查询报文时，要么给出所查询的 IP 地址，要么给出下一级域名服务器的 IP 地址，然后让本地域名服务器进行后续的查询。

> [!note]
> 1. 主机向本地域名服务器的查询都采用递归查询。
> 2. 本地域名服务器向其他域名服务器采用递归查询或迭代查询。

> [!example]
> 假定某客户机想要获知域名为 `y.abc.com` 主机的 IP 地址，域名解析的过程如下：
> 1. 客户机向其本地域名服务器发出 DNS 请求报文 (递归查询)。
> 2. 本地域名服务器收到请求后，查询本地缓存。若没有该记录，则以 DNS 客户的身份向根域名服务器发出解析请求报文 (迭代查询)。
> 3. 根域名服务器收到请求后，判断该域名属于 `.com` 域，于是将对应的顶级域名服务器 `dns.com` 的 IP 地址返回给本地域名服务器。
> 4. 本地域名服务器向顶级域名 `dns.com` 发出解析请求报文 (迭代查询)。
> 5. 顶级域名服务器 `dns.com` 收到请求后，判断该域名属于 `abc.com` 域，因此将对应的权限域名服务器 `dns.abc.com` 的 IP 地址返回给本地域名服务器。
> 6. 本地域名服务器向权限域名服务器 `dns.abc.com` 发出解析请求报文 (迭代查询)。
> 7. 权限域名服务器 `dns.abc.com` 收到请求后，将查询结果返回给本地主机。
> 8. 本地域名服务器将查询结果保存到本地缓存中，并返回给客户机。

> [!tip]
> 为了提供 DNS 的查询效率，并较少因特网上的 DNS 查询报文数量，在域名服务器中广泛地使用了**高速缓存**，用来缓存最近查询过的域名的相关映射信息。这样，当另一个相同的域名查询到达该 DNS 服务器时，该服务器就能直接提供所要求的 IP 地址。
>
> 因为主机名和 IP 地址之间的映射不是永久的，所以 DNS 服务器将在一段时间后丢弃高速缓存中的信息。

## FTP

**文件传输协议**(File Transfer Protocol, FTP) 是因特网上使用最广泛的文件传输协议。FTP 提供交互式访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。它屏蔽了计算机系统细节，因而适合在异构网络中的任意计算机之间传输文件。

FTP 提供以下功能：
1. 提供不同种类主机系统之间的文件传输能力。
2. 以用户权限管理的方式提供用户对远程 FTP 服务器上的文件管理能力。
3. 以匿名 FTP 的方式提供公用文件共享的能力。

> [!note] FTP 的传输层协议
> FTP 采用 C/S 的工作方式，使用 TCP 可靠的传输服务。一个 FTP 服务器进程可同时为多个客户进程提供服务。FTP 的服务进程由两大部分组成：一个**主进程**，负责接收新的请求；若干个**从进程**，负责处理单个请求。其工作步骤如下：
> 1. 打开熟知端口 21，使客户进程能够连接上。
> 2. 等待客户进程发连接请求。
> 3. 启动从属进程处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止。
> 4. 回到等待状态，继续接收其他客户进程的请求。主进程与从进程是并发执行的。

FTP 在工作时使用两个并行的 TCP 连接，一个是控制连接 (端口 21)，一个是数据连接 (端口 20)。使用两个不同的端口号可以使协议更容易实现：
1. **控制连接**：服务器监听 21 号端口，等待客户连接，建立在这个端口上的连接称为控制连接，用来传输控制信息。FTP 客户端发出的请求连接，通过控制连接发送给服务器端的控制进程，但控制连接不用来传输文件。
2. **数据连接**：服务器端的控制进程在接收到 FTP 客户端发送来的文件传输请求后，就创建数据传送进程和数据连接。其中数据连接用来客户端和服务端的数据传送进程，数据传送进程实际完成文件的传输，在传输完毕后关闭数据传送连接并结束运行。

## 电子邮件

电子邮件是一种异步通信方式，通信时不需要双方同时在场。电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可以随时上网到自己使用的邮件服务器中进行读取。一个电子邮件系统应具有用户代理、邮件服务器和电子邮件使用协议：
- **用户代理**(User Agent, UA)：用户与电子邮件系统的接口。用户代理向用户提供一个很友好的接口来发送和接收邮件，用户代理至少具有撰写、显示和邮件处理的功能。通常情况下，用户代理就是一个运行在 PC 上的程序。
- **邮件服务器**：它的功能是发送和接收邮件，同时还要向发件人报告邮件传送的情况。邮件服务器以 C/S 模式工作，但它必须能同时充当客户和服务器。*例如，当邮件服务器 A 向邮件服务器 B 发送邮件时，A 就作为 SMTP 客户，B 是 SMTP 服务器；反之，当 B 向 A 发送邮件时，B 就是 SMTP 客户，A 作为 SMTP 服务器*。
- **邮件发送协议和读取协议**：
	- **邮件发送协议**：如 SMTP，用于用户代理向邮件服务器发送邮件或在邮件服务器之间发送邮件；
	- **邮件读取协议**：如 POP3，用于用户代理从邮件服务器中读取邮件。

> [!note] 电子邮件的收发过程
> 1. 发送人调用用户代理来撰写和编辑要发送的邮件。
> 2. 邮件撰写完后，发件人点击发送。用户代理用 SMTP 把邮件传送给发送端邮件服务器。
> 3. 发送端邮件服务器将邮件放入邮件缓存队列中，等待发送。
> 4. 发送端邮件服务器的 SMTP 客户与接收端邮件服务器的 SMTP 服务器建立 TCP 连接，然后就把邮件缓存队列中的邮件依次发送出去。
> 5. 运行在接收端邮件服务器中的 SMTP 服务器进程收到邮件后，将邮件放入收件人的用户邮箱，等待收件人在方便时进行读取。
> 6. 收件人打算收信时，调用用户代理，使用 POP3 协议将自己的邮件从接收端邮件服务器中的用户邮箱取回。

### 电子邮件格式

一个电子邮件分为**信封**和**内容**两大部分，邮件内容又分为**首部**和**主体**两部分。
- RFC 822 规定了邮件的首部格式，主体部分由用户自由编写。
- 用户写好首部后，邮件系统自动地将信封所需的信息提取出来并写在信封上，用户不需要亲自填写信封上的信息。

由于 SMTP 只能传输 7 位 ASCII 码文本邮件，许多其他非英语国家的文字就无法传送，且无法传送可执行文件及其他二进制对象，所以提供了**多用途因特网邮件扩展**(Multipurpose Internet Mail Extensions, MIME)。
- 当发送端发送的邮件中还有非 ASCII 码数据时，不能直接使用 SMTP 传送，而要通过 MIME 进行转换，将非 ASCII 码数据转换为 ASCII 码数据。
- 之后，通过 SMTP 进行传送。在接收端，对 MIME 处理的数据进行逆转换。

> [!note] MIME 内容
> - 5 个新的邮件首部字段，包括 MIME 的版本、内容描述、内容标识、传输编码和内容类型。
> - 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化。
> - 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。

> [!note] SMTP
> **简单邮件传输协议**(Simple Mail Transfer Protocol, SMTP) 是一种提供可靠且有效的电子邮件传输协议，它控制两个互相通信的 SMTP 进程交换信息。因为 SMTP 采用 C/S 模式，所以负责发送邮件的 SMTP 进程就是 SMTP 客户，而负责接收邮件的 SMTP 进程就是 SMTP 的服务器。SMTP 使用 ==TCP== 连接，端口号为 25。

> [!note] POP3 与 IMAP
> **邮局协议**(Post Office Protocol, POP) 是一种非常简单但功能优先的邮件读取协议，现在使用的版本是 POP3。POP 也采用 C/S 模式，在传输层使用 ==TCP==，端口号是 101。
>
> **因特网报文存取协议**(IMAP) 比 POP 复杂得多，它为用户提供了创建文件夹、在不同文件夹之间移动邮件及在远程文件夹中查询邮件等联机命令，为此 IMAP 维护了会话用户的状态信息。

## 万维网

**万维网**(World Wide Web, WWW) 是一个分布式、联机式的信息存储空间。在这个空间中，一个事物称为一个**资源**，并由一个全域**同一资源定位符**(URL) 标识。这些资源通过**超文本传输协议**(HTTP) 传送给使用者，而后者通过单击链接来获取资源。

万维网使用链接的方法能非常方便地从因特网上的一个站点访问另一个站点，从而主动地按需获取丰富的信息。超文本标记语言使得万维网页面的设计者可以很方便地用一个超链接从本页面的某处链接到因特网的任何一个页面，并能在自己的计算机屏幕上显示这些页面。

> [!note] HTTP 的传输层协议
> 万维网的内核部分由三个标准构成：
> 1. **统一资源定位符**(URL)：负责标识万维网上的各种文档，并使每个文档在整个万维网的范围内具有唯一的标识符 URL。
> 2. **超文本传输协议**(HTTP)：一个应用层协议，它使用 TCP 连接进行可靠的传输，HTTP 是万维网客户程序和服务器程序之间交互所必须严格遵守的协议。
> 3. **超文本标记语言**(HTML)：一种文档结构的标记语言，他使用一些约定的标记对页面上的各种信息进行描述。

URL 是对可以从因特网上得到的资源的位置和访问方法的一种简洁表述。URL 相当于一个文件名在网络范围内的扩展，URL 的一般形式是：
$$
\text{<协议>://<主机>:<端口>/<路径>}
$$
- 协议：用来指明用什么协议获取万维网文档，常见的有 `http`、`ftp` 等。
- 主机：存放资源的主机在因特网的域名或 IP 地址。
- 端口和路径又是可以省略。
- URL 不区分大小写。

> [!note] 万维网工作流程
> 万维网以 C/S 模式工作，浏览器是用户主机上的**万维网客户程序**，而万维网文档所驻留的主机则是运行服务器程序，这台主机称为**万维网服务器**。客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的万维网文档。工作流程如下：
> 1. Web 用户使用浏览器与 Web 服务器建立连接，并发送浏览请求。
> 2. Web 服务器把 URL 转换为文件路径，并返回信息给 Web 浏览器。
> 3. 通信完成，关闭连接。

### 超文本传输协议

HTTP 定义了浏览器怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器。从层次的角度来看，HTTP 是**面向事务**(Transaction-oriented) 的应用层协议，它规定了在浏览器和服务器之间的请求和响应的格式与规则，是万维网上能够可靠地交换文本的重要基础。

> [!example] 访问 Web 时的过程 (以访问清华大学的网络为例)
> 1. 浏览器分析链接指向页面的 URL `http://www.tsinghua.edu.cn/chn/index.htm`
> 2. 浏览器向 DNS 请求解析 `www.tsinghua.edu.cn` 的 IP 地址。
> 3. 域名系统 DNS 解析出清华大学服务器的 IP 地址。
> 4. 浏览器与该服务器建立 TCP 连接 (默认端口号为 80)。
> 5. 浏览器发出 HTTP 请求：`GEP /chn/index.htm`。
> 6. 服务器通过 HTTP 响应把文件 `index.htm` 发送给浏览器。
> 7. 释放 TCP 连接。
> 8. 浏览器解释文件 `index.hem`，并将 Web 显示给用户。

HTTP 是**面向文本的**(Text-Oriented)，因此报文中的每个字段都是一些 ASCII 码串，并且每个字段的长度都是不确定的。有两类 HTTP 报文：
- **请求报文**：从客户向服务器发送的请求报文。
- **响应报文**：从服务器到客户的回答。

![[image/应用层-1.png]]
两种报文都由三个部分组成，两者格式的区别就是开始行不同：
- **开始行**：在请求报文中的开始行称为**请求行**，在响应报文中的开始行称为**状态行**。开始行的三个字段之间都以空格分隔，最后的 `CRLF` 表示换行符。
- **首部行**：用来说明浏览器、服务器或报文主体的一些信息。首部可以有几行，但也可以不使用。每个首部行中都有首部字段名和它的值，整个首部行结束时，还有一个空行将首部行和后面的实体主体分开。
- **实体主体**：在请求报文中一般不使用这个字段。在响应报文中可能也没有。

> [!note] 请求报文方法
> 1. **GET**：请求读取由 URL 标识的信息。*即客户机向服务器请求信息*。
> 2. **HEAD**：请求读取由 URL 标识的信息的首部。
> 3. **POST**：给服务器添加信息，*即服务器需要客户机提供的信息*。
> 4. **CONNECT**：用于代理服务器。

> [!note] HTTP 特点
> 1. HTTP 使用 TCP 作为传输层协议，保证了数据的可靠传输。
> 2. HTTP 是无连接的，虽然 HTTP 使用 TCP 连接，但是通信的双方在交换 HTTP 报文之前不需要先建立 HTTP 连接。
> 3. HTTP 是无状态的，也就是说，同一个客户第二次访问同一个服务器上的页面时，服务器的响应与第一次访问时是相同的。(实际应用中，常使用 Cookie 来跟踪用户的活动，Cookie 存储在本地，随 HTTP 请求发送)

> [!note] HTTP 的两种连接方式
> - **非持续连接**：每个网页对象都需要单独建立一个 TCP 连接，因此每请求一个对象都导致 2×RTT 的开销。此外，每次建立新的 TCP 连接都要分配缓存和变量，使万维网服务器的负担很重。*在 HTTP/1.0 中默认使用非持续连接*。
> 	- 串行：每次只有一个 TCP 连接建立。*如果要连续发送，则需要在上一个文件发送之后重新进行三次握手。这里可以忽略挥手的耗时，因此上一次的挥手与下一次的握手是不同的 TCP 连接，因此是重叠的*。
> 	- 并行：同一时刻可以建立多个 TCP 连接，同时发送多个对象。
> - **持续连接**：万维网服务器在发送响应后仍然保持这条连接，使同一个客户和该服务器可以继续在这条 TCP 连接上传送后续的 HTTP 请求报文和响应报文。*在 HTTP/1.1 中默认使用持续连接*。此时有两种请求方式：
> 	- **非流水线方式**：客户在收到前一个响应后才能发出下一个请求，服务器在发送完一个对象后，其 TCP 连接就处于空闲状态，浪费了服务器资源。
> 	- **流水线方式**：客户可以连续地发送对各个对象的请求，服务器就可以连续地响应这些请求，每次可以发送一个发送窗口的数据。

> [!warning]
> - HTTP/1.0：**非持续连接**，每传输一个文件都要重新建立一个 TCP 连接。
> - HTTP/1.1：**持续连接流水线方式**，在一个 TCP 连接内传输完成所有文件，且每次发送数据都不需要等待确认。需要考虑发送文件的长度，使用慢开始算法进行拥塞控制。

---
< [[计算机网络/传输层|传输层]] |
