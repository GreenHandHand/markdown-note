---
tags:
  - 计算机网络
---

# 传输层

数据链路层提供链路上相邻节点之间的逻辑通信，网络层提供主机之间的逻辑通信。传输层位于网络层之上，应用层之下，它为运行在不同主机上的进程之间提供**逻辑通信**。传输层属于面向通信部分的最高层，同时也是用户功能中的最低层。显然，即使网络层协议不可靠，传输层同样能为应用程序提供可靠的服务。

> [!note] 传输层的功能
> 1. **应用进程之间的逻辑通信**；应用进程之间的通信称为**端到端的逻辑通信**，IP 协议虽然能把分组送到目的主机，但这个分组还停留在主机的网络层，而没有交付给主机中的进程。从传输层来看，通信的真正端点不是主机而是主机中的进程。
> 2. **复用和分用**：
> 	- **复用**：发送方不同的应用进程都可以使用同一传输层协议传送数据。
> 	- **分用**：接收方的传输层在剥去报文的首部后能够把这些数据正确交付到目的应用进程。
> 3. **检错检测**：传输层要对收到的报文进行差错检测。*在网络层，IP 数据报首部中的检验字段只检验首部是否出错，而不检查数据部分*。
> 	- 对于 TCP 协议，若接收方报文段出错，则要求发送方重发该报文段。
> 	- 对于 UDP 协议，若接收方发现数据报出错，则直接丢弃。
> 4. **提供面向连接和无连接的传输协议**：传输层向高层用户屏蔽了低层网络核心的细节，它使应用进程看见的是两个传输层实体之间好像有一条端到端的逻辑通信信道。
> 	- 采用面向连接的 TCP 协议时，尽管下面的网络是不可靠的，单这种逻辑通信信道就相当于一条全双工的可靠信道。
> 	- 采用面向无连接的 UDP 协议时，这种逻辑通信信道仍然是一条不可靠信道。
> 	- 网络层无法同时实现这两种协议。

## 传输层的寻址和端口

端口能让应用层的格式进程将其数据通过端口向下交付给传输层，以及让传输层知道应当将其报文段中的数据向上通过端口交付给应用层相应的进程。端口在传输层的作用类似于 IP 地址在网络层的作用，只不过 IP 标识的是主机，而端口标识的是主机中的应用进程。

### 端口号

应用进程通过端口号进行标识，端口号长度为 16 比特，能够表示 65536 个不同的端口号。端口号具有本地意义，即端口号只标识本计算机应用层中的各进程，在因特网中不同计算机的相同端口号没有联系。根据端口号范围可以将端口分为两类：
1. **服务器端使用的端口号**。
	- **熟知端口号**，数值为 0~1023，IANA 把这些端口号指派给了 TCP/IP 最重要的一些应用程序，让所有用户都知道。
	- **登记端口号**，数值为 0~49151，供没有熟知端口号的应用程序使用的，使用这类端口号必须在 IANA 登记，以防止重复。
2. **客户端使用的端口号**，数值为 49152~65535，因为这类端口号仅在客户进程运行时才动态地选择，所以又称**短暂端口号**。当服务器进程收到客户进程的报文时，就直到了客户进程所使用的端口，因为可以把数据发送给客户进程。进程结束后，刚用过的客户端口号就不复存在，这个端口号可以供其他客户进程使用。

### 套接字

在网络中通过 IP 地址来标识和区别不同的主机，通过端口号来标识和区分一台主机中的不同应用进程，端口号拼接到 IP 地址即构成**套接字**(Socket)。在网络中采用发送方和接收方的套接字来识别端点。套接字实际上就是一个通信端点，即
$$
\text{套接字(Socket)}=\text{(IP地址:端口号)}
$$
它唯一地标识网络中的一台主机上的一个应用进程。

在网络通信中，主机 A 发给主机 B 的报文包含目的端口号和源端口号，源端口号是返回地址的一部分，即当主机 A 需要发回一个报文给主机 A 时，主机 B 到主机 A 的报文中的目的端口号便是主机 A 到主机 B 的报文中的源端口号。

> [!note] TCP 与 UDP
> TCP/IP 协议族在 IP 层之上使用了两个传输协议：
> - 面向连接的传输控制协议(TCP)：采用 TCP 时，传输层向上提供的是一条全双工的可靠逻辑信道。
> - 无连接的用户数据协议(UDP)：采用 UDP 时，传输层向上提供的是一条不可靠的逻辑信道。

## UDP 协议

UDP 仅在 IP 层的数据报服务之上增加了两个最基本的功能：复用和分用，以及差错检测。

> [!note] UDP 协议的特点
> 1. UDP 无须建立连接。因此 UDP 不会引入建立连接的时延。
> 2. 无连接状态。TCP 需要在端系统中维护连接状态，此连接状态包括接收和发送缓存、拥塞控制参数和序号与确认号的参数。而 UDP 既不维护连接状态，也不跟踪这些参数。
> 3. UDP 的首部开销小。TCP 有 20B 的首部开销，而 UDP 仅有 8B 的开销。
> 4. UDP 没有拥塞控制，因此网络中的拥塞不会影响源主机的发送速率。
> 5. UDP 支持一对一、一对多、多对一和多对多的交互通信。

UDP 常用于一次性传输较少数据的网络应用，如 DNS、SNMP 等，因为对于这些应用，若采用 TCP，则将为连接创建、维护和拆除带来不少的开销。UDP 也常用于多媒体应用。显然，可靠数据传输对这些应用来说并不是重要的，但 TCP 的拥塞控制会导致数据出现较大的延迟，这时它们不可容忍的。

### UDP 的首部格式

UDP 数据报包含两部分：首部字段和用户数据字段。UDP 首部有 8B，由 4 个字段组成，每个字段的长度都是 2B。各字段意义如下：
1. **源端口**。源端口，在需要对方回信时选用，不需要时可全为 0。
2. **目的端口**。目的端口号。这在终点交付报文时必须用到。
3. **长度**。UDP 数据报的长度，单位 B，最小值为 8(仅有首部)。
4. **检验和**。检测 UDP 数据报在传输中是否有错，有错就丢弃。该字段是可选的，当源主机不想计算检验和时，则直接令该字段为全 0。

若接收方 UDP 发现收到的报文中目的端口号不正确，则丢弃该报文，并由 ICMP 发送端口不可达差错报文给对方。

### UDP 检验

在计算检验和时，要在 UDP 数据报之前增加 12B 的伪首部，伪首部并不是 UDP 的真正首部，只是在计算检验和时，临时添加在 UDP 数据报的前面，得到一个临时的 UDP 数据报。检验和就是按照这个临时的 UDP 数据报来计算的。伪首部既不向下传送也不向上递交，只是为了计算检验和。

> [!tip] 
> UDP 计算 

> [!example] 
> ![[image/传输层-1.png]]