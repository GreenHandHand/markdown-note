---
tags:
  - 计算机网络
---

# 数据链路层

数据链路层的主要任务是实现帧在一段链路上或一个网络中进行传输。数据链路层协议有多种，但是有三个基本问题是共同的，即**封装称帧、透明传输、差错检测**。

数据链路层使用的信道主要有两种：
1. **点对点信道**，使用一对一的通信方式。PPP 协议就是目前使用最广泛的点对点协议。
2. **广播信道**，这种信道上连接的主机很多，使用一对多的广播通信方式。采用共享广播信道的有线局域网普遍使用 CSMA/CD 协议，而无线局域网则使用 CSMA/CA 协议。

## 数据链路层的功能

数据链路层使用物理层提供的*比特传输*服务，为网络层提供服务，将网络层的 *IP 数据报*(分组)封装成帧，传输给下一个相邻节点。下面是一些基本概念。
- **链路**(链路)：指从一个节点到相邻节点的一段物理线路。当进行数据通信时，两台计算机之间的通信路径往往要经过多段这样的链路。也称为**物理链路**，即传输介质(0 层)与物理层(1 层)实现的相邻节点间的物理链路。
- **数据链路**(逻辑链路)：当在一条链路上传输数据时，除了需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
- **帧**：数据链路层对等实体之间进行逻辑通信的协议数据单元。数据链路层把网络层下交的数据构成帧发送到链路上，并把接受到的帧中的数据取出并上交给网络层。

### 为网络层提供服务

数据链路层通常可以为网络层提供如下三种服务：
1. **无确认的无连接服务**：源主机发送帧时不需要先建立链路连接，目的主机收到帧时不需要发回确认。数据传输的可靠性由高层负责。适用于误码率较低的信道，如以太网。
2. **有确认的无连接服务**：源主机发送帧时不需要建立链路连接，但目的主机收到帧时必须发回确认。源主机在所规定的时间内未收到确定信号时，就重传丢失的帧，以提高传输的可靠性。该服务适用于误码率较高的信道，如无线信道。
3. **有确认的面向连接服务**：帧传输过程分为三个阶段：建立链路、传输帧、释放链路。目的主机对收到的每一个帧都要返回确认。该服务适用于可靠性要求较高的场合。

### 链路管理

数据链路层连接的建立、维持和释放过程称为**链路管理**，它主要用于面向连接的服务。链路两端的节点要进行通信，必须首先确认对方以处于就绪状态，并交换一些必要的信息以对帧序号初始化，然后才能建立连接。在传输过程中要能维持连接，而在传输完毕后要释放该连接。

### 封装成帧与透明传输

封装成帧是指在一段数据的前后分别添加首部和尾部，构成帧。
- **帧**是数据链路层的数据传送单元，**帧长**等于帧的数据部分长度加上首部和尾部的长度。
- 首部和尾部中含有很多的控制信息，它们的一个重要作用就是确定帧的界限，即**帧定界**。
- 接收方能从接受到的二进制比特流中区分出帧的起始与终止，即**帧同步**。

若在数据中恰好出现与帧定界符相同的比特组合^[会误认为传输结束而丢弃后面的数据]，则要采取有效的措施来解决这个问题，即**透明传输**。更切确地说，透明传输是指不论所传的数据是什么样的比特组合，都能按照原样无差错地在这个数据链路上传输。

### 流量控制

因为链路两端节点的工作速率和缓存空间存在差异，所以发送放的发送能力可能大于接收方的接收能力，若此时不限制发送方的发送速率，前面来不及接收的帧将被后面不断发来的帧覆盖，造成帧的丢失而出错。因此，**流量控制**实际上就是限制发送放的发送速率，使之不超过接收方的接收能力。这个过程需要某种反馈机制，使发送方知道什么情况下可以接着发送下一帧，而在什么情况下必须暂停发送。

> [!note] 
> 在 OSI 体系结构中，数据链路层具有流量控制的功能，而在 TCP/IP 体系结构中，流量控制功能被移动到了传输层。它们控制的对象不同。
> - 对于数据链路层来说，控制的是相邻节点之间的数据链路上的流量。
> - 对与传输层来说，控制的是从源端到目的端之间的流量。

### 差错检测

因为信道噪声的缘故，帧在传输过程中可能会出现错误，这些错误分为位错和帧错。
- **位错**：帧中某些位出现差错，通常采用**循环冗余检验**(CRC)来发现位错。
- **帧错**：帧丢失、帧重复、帧失序等错误。

过去的 ISO 观点认为，必须让数据链路层向上提供可靠传输，因此在 CRC 检错的基础上，增加了帧编号、确认和重传机制。收到正确的帧就要向对伐发送确认，发送方在一定期限内未收到对方的确认，就认为出了差错，因此进行重传，直到收到确认为止。
- 现在，在通信质量较差的无线传输中，数据链路层依然使用确认和重传机制，向上提供可靠的传输服务。
- 对于通信质量较好的有线链路，数据链路层不再使用确认和重传机制，仅需要进行 CRC 检错，目的是将有差错的帧丢弃，保证上交的帧都是正确的。而对于出错的帧的重传任务，由高层协议(如传输层的 TCP 协议)完成。

## 组帧

发送放依据一定的规则将网络层递交的分组**封装成帧**，也称为组帧。数据链路层之所以要将比特组合成以帧为单位传输，是为了在出错时指重发出错的帧，而不必重发全部的数据，从而提高效率。组帧主要解决帧定界、帧同步、透明传输等问题。

> [!warning] 
> 组帧既要加首部，又要加尾部。原因是，在网络中信息是以帧为最小单位进行传输的，所以接收方要正确地接收帧，就必须清楚该帧在一串比特流中从哪里开始到哪里结束。接收方接收到的是一串比特流，没有首部和尾部无法正确区分帧的内容。而分组(即 IP 数据报)仅是包含在帧中的数据部分，所以不需要加尾部来定界。

### 字符计数法

字符计数法指在帧首部使用一个计数字段来记录该帧所含的字节数(包含计数字段自身所占用的 1 个字节)。当接收方读出帧首部的字节计数值时，就直到后面跟随的字节数，从而确定帧结束位置。因为帧与帧之间是连续传输的，所以也能确定下一帧开始的位置。

> [!note] 字符计数法特点
> 这种方法最大的问题在于若计数字段出错，即失去帧边界划分的依据，则接收方就无法判断所传输帧的结束位与下一帧的开始位，收发双方将失去同步，造成灾难性后果。

### 字节填充法

字节填充法使用特定字节来界定一帧的开始与结束。例如，将 SOH 控制字符放在帧的最前面，表示帧的开始，将 EOT 控制字符表示帧的结束。为了使信息为出现的特殊字符不被误判为首尾定界符，可在特出字符之前填充一个转义字符 ESC^[ESC 表示 ASCII 码中的控制字符，是一个字符] 来加以区分，以实现数据的透明传输。接收方在收到转义字符后，就直到其后面紧跟的是数据信息，而不是控制信息。

### 零比特填充法

零比特填充法允许数据帧包含任意个数的比特，它使用一个特定的比特串 01111110 来标志一个帧的开始和结束。为了不使数据字段中出现的比特流 01111110 被误判为帧的首尾标志，发送方先扫描整个数据字段，每遇到 5 个连续的 1 就自动在后面插入一个 0。经过这种比特填充后，就可以保证数据字段中不会出现 6 个连续的 1。接收方做该过程的你操作，即每收到 5 个连续的 1，就自动删除后面紧跟的 0，以恢复数据。在数据链路层早期使用的 HDLC 协议中，便采用这种比特填充的首尾标志法来实现透明传输的。

> [!note] 零比特填充法很容易用硬件来实现，性能优于字节填充法。

### 违规编码法

在物理层进行比特编码时，常采用**违规编码法**。例如，曼彻斯特编码方法将数据比特 1 编码成高-低电平对，将数据比特 0 编码成低-高电平对，而高-高电平对和低-低电平对在数据比特中是违规的，因此可以借用这些违规编码序列来界定帧的起始和终止。局域网 IEEE 802 标准就采用了这种方法。违规编码法不采用任何填充技术便能实现数据的透明传输，但是适合用于冗余编码的特殊编码环境。

> [!tip] 
> 由于字符计数法中计数字段的脆弱性和字节填充法实现上的复杂性与不兼容性，所以目前较常用的组帧方法是零比特填充法和违规编码法。

## 差错控制

实际通信链路都不是理想的，比特在传输过程中可能会产生差错，1 可能变成 0, 0 也可能变成 1，这就是**比特差错**。比特差错是传输差错的一种，本节仅讨论比特差错。

通常利用编码技术来进行差错控制，主要有两类
- **自动重传请求**(Automatic Repeat reQuest, ARQ)：当接收方检测到差错时，就设法通知发送方重发，直到收到正确的数据未知。其对应的编码技术差错控制称为**检错编码**。
- **前向纠错**(Forward Error Correction, FEC)：接收方不但能发现差错，而且能确定错误的位置并加以纠正。其对应的编码技术差错控制称为**纠错编码**。

### 检错编码

检错编码都采用冗余编码技术，核心思想是在有效数据被发送前，按某种关系附加一定的冗余位，构成一个符合某一规则的码字后发送。当要发送的有效数据变化时，相应的冗余位也随之变化，使得码字遵守不变的规则。接收方根据收到的码字是否仍符合原规则来判断是否出错。常见的检错编码有**奇偶校验码**和**循环冗余码**。

#### 奇偶检验码

奇偶校验码是奇校验码和偶校验码的统称，是一种最基本的校验码。它由 $n-1$ 位数据和 1 位检验位组成，校验位的取值将使得整个校验码中 1 的个数为奇数或偶数。
- 奇校验码：附加一个检验位后，码长为 $n$ 的码字中 1 的个数位奇数。
- 偶校验码：附加一个校验位后，码长为 $n$ 的码字中 1 的个数位偶数。

> [!example] 
> 7 位数据 1001101 对应的奇校验码为 100011011，对应的偶校验码为 10011010。它只能检测奇数位的出错情况，但不知道那些位错了，也不能发现偶数位的出错情况。

#### 循环冗余码

数据链路层广泛使用**循环冗余码**(Cyclic Redundancy Code, CRC)检错技术。其基本思想为：
1. 收发双方约定生成多项式 $G(x)$ (最高位和最低位必须是 1)。$k$ 位位串可视为阶数为 $k-1$ 的多项式的系数序列。*例如，可用多项式 $x^{3}+x^{2}+1$ 表示位串 1101*。
2. 发送方基于待发送的数据和 $G(x)$，计算出冗余码，将冗余码附加到数据后面一起发送。
3. 接收方收到数据和冗余码后，通过 $G(x)$ 来计算收到的数据和冗余码是否产生差错。

> [!note] 
> 假设一个待传送 $m$ 位的数据，CRC 运算产生一个 $r$ 位的冗余码，称为**帧检验序列**(FCS)。这样形成的帧将由 $m+r$ 位组成。在所要发送的数据后面增加 $r$ 位冗余码，虽然增大了传输开销，但是可以进行差错检测，这种代价往往是值得的。这个带检验位的帧刚好能被预先确定的多项式 $G(x)$ 整除。接收方用同样的多项式去除收到的帧，若无余数，则认为无差错。

> [!note] 循环冗余码的计算
> 假设一段 $m$ 位数据，则计算循环冗余码的步骤如下：
> 1. 加 0。假设 $G(x)$ 的阶为 $r$，在数据后面加 $r$ 个 0，相当于乘以 $2^{r}$。
> 2. 模 2 除。利用模 2 除法，用 $G(x)$ 对应的二进制串去除 1. 中计算得出的数据串，得到的余数即为冗余码(共 $r$ 位，前面的 0 不可省略)。

发送方的 FCS 生成和接收方的 CRC 检验都是由硬件实现的，处理非常迅速，不会影响数据的传输。若在传输过程中无差错，则经过 CRC 检验后得出的余数 R 肯定为 0。但是，若出现误码，则余数 R 仍为 0 的概率极低。因此，通过 CRC 检错技术，可以近似地认为凡是接收方数据链路层接受的帧均无差错。也就是说，凡是接收方数据链路层接受的帧，我们都能以非常接近 1 的概率认为这些帧在传输过程中为产生差错。而接收方丢弃的帧虽然曾经收到，但最终因为有差错而被丢弃，即未被接受。

> [!tip] 循环冗余码是具有纠错的功能的，但是在数据链路层中只使用了其检错功能，对于错误帧直接丢弃。

### 纠错编码

最常见的纠错编码是**海明码**，其实现原理是在有效信息位中加入几个检验位形成海明码，并把海明码的每个二进制位分配到几个奇偶校验组中。某一位出错后，就会引起有关的几个校验位的值发生变化，这不但可以发现错误，而且可以指出错位的位置，为自动纠错提供依据。

## 流量控制与可靠传输技术

在数据链路层中，流量控制机制和可靠传输机制是交织在一起的。

### 流量控制与滑动窗口机制

**流量控制**是指由接收方控制发送方的发送速率，使接收方由足够的缓冲空间来接收每个帧。常见的流量控制方法有两种：停止-等待协议和滑动窗口协议。数据链路层和传输层均有流量控制功能，它们都用到了滑动窗口协议，但也有所区别，主要体现在：
1. 数据链路层控制的是相邻节点之间的流量，而传输层控制的是端到端的流量。
2. 数据链路层的控制手段是接收方收不下就不返回确认。传输层的控制手段是接收方通过确认报文段中的窗口值来调整发送方的发送窗口。

#### 停止-等待流量控制

**停止-等待**流量控制是一种最简单的流量控制方法，其方式为：
- 发送方每次只允许发送一个帧，接收方每次接收一个帧就要反馈一个应答信号，表示可以接收下一个帧。
- 发送方收到应答信号后才能发送下一个帧，若发送方没有收到接收方反馈的应答信号，则需要一直等待。

停止-等待流量控制的传输效率很低。、

#### 滑动窗口流量控制

**滑动窗口**流量控制是一种更加有效的流量控制方法。
- 在任意时刻，发送方都维持一组连续的允许发送帧的序号，称为发送窗口。发送窗口表示在还未收到对方确认信息的情况下，发送放最多还能发送多少个帧和哪些帧。
- 同时，接收方也维持一组连续的允许接收帧的序号，称为接收窗口。接收窗口用于控制可以接收哪些帧和不可接收哪些帧。

发送方每收到一个按序确认的确认帧，就将发送窗口向前滑动一个位置。这样，就有一个新的序号落入发送窗口，序号落入发送窗口内的数据帧可以继续发送。当窗口内没有可以发送的帧时，发送放就停止发送。

接收方每收到一个序号落入接收窗口的数据帧，就接收该帧，然后将滑动窗口向前滑动一个位置，并发回确认。这样，就有一个新的序号落入接收窗口，序号落入接收窗口的数据帧即为准备接收的帧。若收到的数据帧落在滑动窗口外，则一律丢弃。

> [!note] 滑动窗口的特性
> 1. 只有接收窗口向前滑动了，发送窗口才可能向前滑动。
> 2. 从滑动窗口的概念上来看，停止-等待协议、后退 N 帧协议和选择重传协议只在发送窗口大小与接收窗口大小上有差异：
> 	- 停止-等待协议：发送窗口为 1，接收窗口为 1；
> 	- 后退 N 帧协议：发送窗口大于 1，接收窗口为 1；
> 	- 选择重传协议：发送窗口大于 1，接收窗口大于 1；
> 3. 当接收窗口大大小为 1 时，可以保证帧的有序接收。
> 4. 在数据链路层的滑动窗口协议中，窗口大小在传输过程中是固定的(区别于传输层)。

### 可靠传输机制

**可靠传输**指发送放发送的数据能被接收方正确地接收，通常采用确认和超时重传两种机制来实现。
- **确认**：接收方每次收到发送放发来的数据帧，都要向发送方发回一个确认帧，表示已经正确地收到该数据帧。
- **超时重传**：发送方在发送一个数据帧后就启动一个计数器，若在规定时间内没有收到所发数据帧的确认帧，则重发数据帧，直到发送成功为之。

使用这两种机制的可靠传输协议称为**自动重传请求**(ARQ)，它意味着重传是自动进行的，接收方不需要对发送放发出重传请求。在 ARQ 协议中，数据帧和确认帧都必须编号，以区分确认帧是对哪个帧进行确认，以及那些帧还没有确认。

ARQ 协议分为三种：**停止-等待**(Stop-and-Wait)协议、**后退 N 帧**(Go-Back-N)协议和**选择重传**(Selective Repeat)协议。值得注意的是，这三种可靠传输协议的基本原理并不仅限于数据链路层，还可以应用在其他层上。

> [!note] 
> 在有限网络中，链路的误码率较低，为了降低开销，并不要求数据链路层向上层提供可靠的传输服务，即使出现了误码，可靠传输的问题也由上层处理。而无线网络的链路易受干扰，误码率较高，因此要求数据链路层必须向上层提供可靠传输服务。

#### 单帧滑动窗口与停止-等待协议(S-W)

在停止-等待协议中，发送方每次只能发送一个帧，当发送方接收到接收方的确认帧后，才可以发送下一个帧。因此，在这种协议下，除了帧丢失，还可能有以下两种错误：
1. 到达接收方的帧已被破坏，接收方利用差错处理技术发现并丢弃，此时不会发送确认帧。对于这种情况，可以使用超时重传的方法，设置一个计时器。发送方发送后等待确认，当计时器超时时，发送方没有收到确认帧，则重发数据帧。
2. 数据帧正确发送，但是确认帧被破坏。此时发送方已经收到了正确的数据帧，但是发送方无法收到确认帧，将会重新发送相同的数据帧。接收方收到相同的数据帧后，直接丢弃该帧，然后重传一个确认帧。

> [!note] 停止等待协议的实现
> 发送方每发送一个数据帧就等待，因此使用 1bit 数据表示状态。发送的帧交替地用 0 和 1 标识，确认帧也使用相同的 0 和 1 来表示。当收到确认帧有误是，就重发已发送的帧。若连续收到了序号相同的数据帧，则表示发送方进行了超时重传， 