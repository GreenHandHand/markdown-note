# 网络层

## 网络层的功能

网络层提供提供主机到主机的通信服务，主要任务是将分组从源主机经过多个网络和多段链路传输目的主机。该任务可以划分为分组转发和路由选择两种重要功能。

在互联网采用的 TCP/IP 体系结构中，网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。也就说说，所传送的分组可能出错、丢失、重复、失序或超时，这就使得网络中的路由器可以做得比较简单，而且价格低廉。通信的可靠性可以由更高层的传输层来负责。采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多重应用。

### 异构网络互连

互联网是由全球范围内数以百万计的异构网络互连起来的。这些网络的拓扑结构、寻址方案、差错处理方法、路由选择机制都不尽相同。网络层要完成的任务之一就是使这些异构的网络实现互连，以构成更大的网络系统。根据所在的层次，中继系统分为以下 4 种：
1. 物理层中继系统，即转发器、集线器。
2. 数据链路层中继系统，即网桥或交换机。
3. 网络层中继系统，即路由器。
4. 网络层以上中继系统，即网关。

当使用物理层或数据链路层中继系统时，只是把一个网络扩大了，而从网络层的角度来看，它仍然是同一个网络，一般不称为网络互连。因此，**网络互连**通常是指用路由器进行网络连接和路由选择。路由器是一台专用计算机，用于在互联网中进行路由选择。

> [!tip] 在 TCP/IP 协议中，网络层的路由器也称为网关。

TCP/IP 在网络互连上采用的做法是在网络层采用标准化协议，但相互连接的网络可以是异构的。由于参与互连的计算机网络使用相同的 IP 协议，所有可以把互连后的网络视为一个虚拟 IP 网络。**虚拟互连网络**也就是逻辑互连网络，意思是互连起来的各种物理网络的异构性本来是客观存在的，但是通过 IP 协议可以使得这些性能各异的网络在网络层上看起来像是一个统一的网络。这种使用 IP 协议的虚拟互连网络可以简称为**IP 网络**。

> [!note]
> 使用 IP 网络好处是，当 IP 网上的主机进行通信时，就好像在单个网络通信一眼，而看不见互连的各个网络的具体异构细节。

### 路由与转发

路由器主要完成两个功能：
- **路由选择**：*确定哪一条路径*。根据路由协议构造路由表，同时经常或定期地与相邻路由器交换信息，获取网络最新拓扑，动态更新维护路由表，以决定分组到达目的地节点的最优路径。
- **分组转发**：*路由器根据转发表将分组从合适的端口上转发出去*。处理通过路由器的数据流，关键操作是转发表查询、转发及相关的队列管理和任务调度等。

路由表是根据选择算法得出的，而转发表是从路由表得出的。转发表的结构应当使查找过程最优化，路由表则需要最优化网络拓扑变换的计算。在讨论路由选择的原理时，往往不区分转发表和路由表，而是笼统地使用路由表一词。

### 拥塞控制

因出现过量的分组而引起网络性能下降的现象称为**拥塞**。判断网络是否进入拥塞状态的方式是，观察网络的吞吐量与网络负载的关系：
- 若随着网络负载的增加，网络的吞吐量明显小于正常吞吐量，则网络就可能已进入轻度拥塞状态。
- 若网络的吞吐量随着网络负载的增大而下降，则网络就可能已进入拥塞状态。

拥塞控制主要解决的问题是如何获取网络中发生拥塞的信息，从而利用这些信息进行控制，以避免因拥塞而出现分组的丢失。拥塞控制的两种方法：
1. **开环控制**：在设计网络时事先将有关拥塞的因素考虑周期，力求网络在工作时不产生拥塞。这是一种静态的预防方法。一旦整个系统启动并运行，中途就不再需要修改。
2. **闭环控制**：事先不考虑有关发生拥塞的各种因素，采用检测网络系统去监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。

## IPv4

IPv4 即现在普遍使用的**网际协议**(Internet Protocol, IP)。IP 定义数据传送的基本单元**IP 分组**及其确切的数据格式。IP 也包含一套规则，指明分组如何处理、错误怎样控制。特别是 IP 还包含非可靠投递的思想，以及与此关联的路由选择思想。

### IPv4 分组的格式

一个 **IP 分组**(或者称为 **IP 数据报**) 由**首部**和**数据部分**组成。
- **首部**：前一部分的长度固定，共 20B，是所有 IP 分组必须具有的。在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制。
- **数据部分**

> [!example] IP 首部
> ![[image/网络层-1.png|IP 数据报]]
> IP 首部的部分的重要字段含义如下：
> 1. **版本**。占 4 位，指 IP 的版本，IPv4 数据报中该字段值为 4。
> 2. **首部长度**。占 4 位，以 ==4B== 为单位，最大可表示的首部长度为 60B。最常用的首部长度是 20B，字段值为 5，此时不使用任何可选字段。
> 3. **总长度**。占 16 位，指首部和数据之和的长度，单位 ==1B==，因此数据报的最大长度为 $2^{16}-1=65535B$。以太网帧的最大传输单元 (MTU) 为 1500B，因此当一个 IP 数据报封装为帧时，数据报的总长度 (首部加数据) 一定不能超过下面的数据链路层的 MTU 值。
> 4. **标识**。占 16 位，它是一个计数器，每产生一个数据报就加 1，并赋值给标识字段。但它并不是序号。当一个数据报的长度超过网络的 MTU 时，必须分片，此时每个数据报片都复制一次标识号，以便能正确地重装为原来的数据报。
> 5. **标志**(Flag)。占 3 位，我们需要关注其最低位 MF 与次低位 DF。
> 	- MF：1 表示后面还有分片，0 表示后面没有分片。
> 	- DF：1 表示不允许分片^[若一个 IP 数据报的 DF=1，且其大小大于当前链路的 MTU，则该 IP 数据报无法正确发送，传输节点会直接丢弃该 IP 数据报，并向源节点发送 ICMP 差错报文。]，0 表示允许分片。
> 6. **片偏移**。占 13 位，它指出较长的数据报在分片后，某片在原数据报中的相对位置，片偏移以 8B 为偏移单位。除了最后一个分片外，每个分片的长度一定是 ==8B== 的整数倍。
> 7. **生存空间**(TTL)，占 8 位。数据报在网络中可通过的路由器的最大值，标识数据报在网络中的寿命，以确保数据报不会永远在网络中循环。路由器在转发数据报之前，先将 TTL 减 1，若 TTL 被减为 0，则该数据报必须丢弃。
> 8. **协议**。占 8 位，指出该数据报携带的数据使用何种协议，即数据报的数据部分应上交给哪个协议进行处理，如 TCP、UDP 等。其中 6 表示 TCP，17 表示 UDP。
> 9. **首部检验和**。占 16 位，它只检验数据报的首部，但不包括数据部分。这是因为数据报每经过一个路由器，都要重新计算首部检验和。不检验数据部分可减少计算的工作量。
> 10. **源地址字段**。占 4B，标识发送方的 IP 地址。
> 11. **目的地址字段**。占 4B，标识接收方的 IP 地址。

> [!note] IP 数据报分片
> 一个链路层数据帧能承载的最大数据量称为**最大传送单元**(MTU)。因为 IP 数据报被封装在链路层的帧中，因此链路层的 MTU 严格地限制了 IP 数据报的长度，而且在 IP 数据报的源与目的地路径上各段链路可能使用不同的链路层协议，有不同的 MTU。例如，以太网的 MTU 为 1500B，而许多广域网的 MTU 不超过 576B。
>
> 当 IP 数据报的总长度大于链路 MTU 时，就需要将 IP 数据报中的数据分装在多个较小的 IP 数据报中，这些较小的数据报称为**片**。在 IP 数据报中，是通过片偏移和标志位、标识位来组合片的。
> - 接收节点根据标识位来判断来自同一 IP 地址的哪些 IP 数据报是
