# 网络层

## 网络层的功能

网络层提供提供主机到主机的通信服务，主要任务是将分组从源主机经过多个网络和多段链路传输目的主机。该任务可以划分为分组转发和路由选择两种重要功能。

在互联网采用的 TCP/IP 体系结构中，网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。也就说说，所传送的分组可能出错、丢失、重复、失序或超时，这就使得网络中的路由器可以做得比较简单，而且价格低廉。通信的可靠性可以由更高层的传输层来负责。采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多重应用。

### 异构网络互连

互联网是由全球范围内数以百万计的异构网络互连起来的。这些网络的拓扑结构、寻址方案、差错处理方法、路由选择机制都不尽相同。网络层要完成的任务之一就是使这些异构的网络实现互连，以构成更大的网络系统。根据所在的层次，中继系统分为以下 4 种：
1. 物理层中继系统，即转发器、集线器。
2. 数据链路层中继系统，即网桥或交换机。
3. 网络层中继系统，即路由器。
4. 网络层以上中继系统，即网关。

当使用物理层或数据链路层中继系统时，只是把一个网络扩大了，而从网络层的角度来看，它仍然是同一个网络，一般不称为网络互连。因此，**网络互连**通常是指用路由器进行网络连接和路由选择。路由器是一台专用计算机，用于在互联网中进行路由选择。

> [!tip] 在 TCP/IP 协议中，网络层的路由器也称为网关。

TCP/IP 在网络互连上采用的做法是在网络层采用标准化协议，但相互连接的网络可以是异构的。由于参与互连的计算机网络使用相同的 IP 协议，所有可以把互连后的网络视为一个虚拟 IP 网络。**虚拟互连网络**也就是逻辑互连网络，意思是互连起来的各种物理网络的异构性本来是客观存在的，但是通过 IP 协议可以使得这些性能各异的网络在网络层上看起来像是一个统一的网络。这种使用 IP 协议的虚拟互连网络可以简称为**IP 网络**。

> [!note]
> 使用 IP 网络好处是，当 IP 网上的主机进行通信时，就好像在单个网络通信一眼，而看不见互连的各个网络的具体异构细节。

### 路由与转发

路由器主要完成两个功能：
- **路由选择**：*确定哪一条路径*。根据路由协议构造路由表，同时经常或定期地与相邻路由器交换信息，获取网络最新拓扑，动态更新维护路由表，以决定分组到达目的地节点的最优路径。
- **分组转发**：*路由器根据转发表将分组从合适的端口上转发出去*。处理通过路由器的数据流，关键操作是转发表查询、转发及相关的队列管理和任务调度等。

路由表是根据选择算法得出的，而转发表是从路由表得出的。转发表的结构应当使查找过程最优化，路由表则需要最优化网络拓扑变换的计算。在讨论路由选择的原理时，往往不区分转发表和路由表，而是笼统地使用路由表一词。

### 拥塞控制

因出现过量的分组而引起网络性能下降的现象称为**拥塞**。判断网络是否进入拥塞状态的方式是，观察网络的吞吐量与网络负载的关系：
- 若随着网络负载的增加，网络的吞吐量明显小于正常吞吐量，则网络就可能已进入轻度拥塞状态。
- 若网络的吞吐量随着网络负载的增大而下降，则网络就可能已进入拥塞状态。

拥塞控制主要解决的问题是如何获取网络中发生拥塞的信息，从而利用这些信息进行控制，以避免因拥塞而出现分组的丢失。拥塞控制的两种方法：
1. **开环控制**：在设计网络时事先将有关拥塞的因素考虑周期，力求网络在工作时不产生拥塞。这是一种静态的预防方法。一旦整个系统启动并运行，中途就不再需要修改。
2. **闭环控制**：事先不考虑有关发生拥塞的各种因素，采用检测网络系统去监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。

## IPv4

IPv4 即现在普遍使用的**网际协议**(Internet Protocol, IP)。IP 定义数据传送的基本单元**IP 分组**及其确切的数据格式。IP 也包含一套规则，指明分组如何处理、错误怎样控制。特别是 IP 还包含非可靠投递的思想，以及与此关联的路由选择思想。

