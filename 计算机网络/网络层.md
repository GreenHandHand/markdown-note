---
tags:
  - 计算机网络
---

# 网络层

> [!tip] 协议配置
> 在协议软件中给参数赋值的过程称为协议配置，一个协议软件在使用之前必须是正确配置的。具体的配置信息取决于协议栈，例如，连接到互联网的机器需要配置：
> 1. IP 地址；
> 2. 子网掩码；
> 3. 默认网关；
> 4. 域名服务器的 IP 地址。

## 网络层的功能

网络层提供提供主机到主机的通信服务，主要任务是将分组从源主机经过多个网络和多段链路传输目的主机。该任务可以划分为分组转发和路由选择两种重要功能。

在互联网采用的 TCP/IP 体系结构中，网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。也就说说，所传送的分组可能出错、丢失、重复、失序或超时，这就使得网络中的路由器可以做得比较简单，而且价格低廉。通信的可靠性可以由更高层的传输层来负责。采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多重应用。

### 异构网络互连

互联网是由全球范围内数以百万计的异构网络互连起来的。这些网络的拓扑结构、寻址方案、差错处理方法、路由选择机制都不尽相同。网络层要完成的任务之一就是使这些异构的网络实现互连，以构成更大的网络系统。根据所在的层次，中继系统分为以下 4 种：
1. 物理层中继系统，即转发器、集线器。
2. 数据链路层中继系统，即网桥或交换机。
3. 网络层中继系统，即路由器。
4. 网络层以上中继系统，即网关。

当使用物理层或数据链路层中继系统时，只是把一个网络扩大了，而从网络层的角度来看，它仍然是同一个网络，一般不称为网络互连。因此，**网络互连**通常是指用路由器进行网络连接和路由选择。路由器是一台专用计算机，用于在互联网中进行路由选择。

> [!tip] 在 TCP/IP 协议中，网络层的路由器也称为网关。

TCP/IP 在网络互连上采用的做法是在网络层采用标准化协议，但相互连接的网络可以是异构的。由于参与互连的计算机网络使用相同的 IP 协议，所有可以把互连后的网络视为一个虚拟 IP 网络。**虚拟互连网络**也就是逻辑互连网络，意思是互连起来的各种物理网络的异构性本来是客观存在的，但是通过 IP 协议可以使得这些性能各异的网络在网络层上看起来像是一个统一的网络。这种使用 IP 协议的虚拟互连网络可以简称为**IP 网络**。

> [!note]
> 使用 IP 网络好处是，当 IP 网上的主机进行通信时，就好像在单个网络通信一眼，而看不见互连的各个网络的具体异构细节。

### 路由与转发

路由器主要完成两个功能：
- **路由选择**：*确定哪一条路径*。根据路由协议构造路由表，同时经常或定期地与相邻路由器交换信息，获取网络最新拓扑，动态更新维护路由表，以决定分组到达目的地节点的最优路径。
- **分组转发**：*路由器根据转发表将分组从合适的端口上转发出去*。处理通过路由器的数据流，关键操作是转发表查询、转发及相关的队列管理和任务调度等。

路由表是根据选择算法得出的，而转发表是从路由表得出的。转发表的结构应当使查找过程最优化，路由表则需要最优化网络拓扑变换的计算。在讨论路由选择的原理时，往往不区分转发表和路由表，而是笼统地使用路由表一词。

#### 虚电路

在虚电路方式中，当两台计算机进行通信时，应当先建立网络层连接，也就是一条逻辑上的**虚电路**(Virtual Circuit, VC)。连接一旦建立，就固定了虚电路对应的物理路径。与电路交换类似，整个通信过程分为三个阶段：
1. **虚电路建立**：建立虚电路时，将一个未使用过的**虚电路号**(VCID) 分配给该虚电路，以区别于本系统中的其他虚电路。
	1. 数据传输前，主机 A 与主机 B 先建立连接，主机 A 发出呼叫请求分组，该分组通过中间节点送往主机 B，若主机 B 同意连接，则发送呼叫应答分组进行确认。
	2. 分组的首部仅在连接建立时使用完整的地址，之后的每个分组的首部只需要携带这条虚电路的编号即可。
2. **传送数据**：虚电路建立后，主机 A 和主机 B 就可以相互传送数据分组。
3. **断开连接**：传送结束后，主机 A 通过发送释放请求分组来拆除虚电路，逐段断开整个连接。

> [!note] 虚电路的特点
> 1. 虚电路通信链路的建立和拆除需要时间开销，对交互式应用和少量的短分组情况显得很浪费，但是对长时间、频繁的数据交换效率较高。
> 2. 虚电路的路由选择体现在连接建立阶段，连接建立后，就确定了传输路径。
> 3. 虚电路提供了可靠的通信功能，能保证每个分组正确且有序地到达。此外，还可对两个端点的流量进行控制，当接收方来不及接受数据时，可以通知发送方暂缓发送。
> 4. 虚电路有一个致命的缺点，即当网络中某个节点或某条链路出现故障而彻底失效时，所有经过该节点或该链路的虚电路将遭到破坏。

#### 数据报

网络在发送分组前不需要建立连接。源主机的高层协议将报文拆成若干个较小的数据段，并加上地址等控制信息后构成分组。中间节点存储分组很短一段时间，找到最佳路由后，尽快转发每个分组。

| 特点        | 数据报服务                          | 虚电路服务                        |
| --------- | ------------------------------ | ---------------------------- |
| 连接的建立     | 不需要                            | 必须有                          |
| 目的地址      | 每个分组都有完整的目的地址                  | 仅在建立连接阶段使用，之后每个分组使用长度较短的虚电路号 |
| 路由选择      | 每个分组独立地进行路由选择                  | 属于同一条虚电路的分组按照同一路由转发          |
| 分组顺序      | 不保证分组的有序到达                     | 保证分组的有序到达                    |
| 可靠性       | 不保证可靠通信，可靠性由用于主机来保证            | 可靠性由网络保证                     |
| 对网络故障的适应性 | 出故障的节点丢失分组，其他分组路径选择发生变化时可以正常传输 | 所有经过故障节点的虚电路均不能正常工作          |
| 差错处理和流量控制 | 由用户主机进行流量控制，不保证数据报的可靠性         | 可由分组交换网负责，也可由用户主机负责          |

### SDN

**软件定义网络**(Software Defined Network, SDN) 是近年来流行的一种创新网络架构，它采用集中式的控制平面和分布式的数据平面，两个平面互相分离，控制平面利用控制-数据接口对数据平面上的路由器进行集中式控制，方便软件来控制网络。

传统网络中的路由器既有转发表又有路由选择软件。而在 SDN 结构中，路由器不再需要路由选择软件，因此路由器之间不需要相互交换路由信息。在网络的控制平面由一个逻辑上的*远程控制器*(可以由多个服务器组成)。远程控制器掌握各主机和整个网络的状态，为每个分组计算出最佳路由，通过 Openflow 协议将转发表下发给路由器。路由器的工作很单纯，即收到分组、查找转发表、转发分组。

> [!note] SDN 编程接口
> SDN 的可编程性通过为开发者提供强大的编程接口，是的网络具有很好的编程行。
> 1. **北向接口**：对上层应用的开发者，SDN 提供的编程接口称为北向接口。北向接口提供了丰富的 API，开发者可以在此基础上设计自己的应用，而不必关心底层的硬件细节。*北向接口用于应用程序开发*。
> 2. **南向接口**：SDN 控制器和转发设备建立双向会话的接口称为南向接口。通过不同的南向接口协议 (如 Openflow)，SDN 控制器就可以兼容不同的硬件设备，同时可在设备中实现上层应用的逻辑。*南向接口用于控制平面与数据平面间的通信*。
> 3. **东西向接口**：SDN 控制器集群内部控制器之间的通信接口统称东西向接口，用于增强整个控制平面的可靠性和可拓展性。

> [!note] SDN 的特点
> - 优点：
> 	1. 全局集中式控制和分布式高速转发，即利于控制平面的全局优化，又利于高性能的网络转发。
> 	2. 灵活可编程与性能的平衡，控制和转发分离后，使得网络可以由专有的自动化工具以编程方式配置。
> 	3. 降低成本，控制和数据平面分离后，尤其是使用开放的接口协议后，就实现了网络设备的制造与功能软件的开发相分离，有效地降低了成本。
> - 缺点：
> 	1. 安全风险，集中管理容易受攻击，若崩溃，则整个网络都会受到影响。
> 	2. 瓶颈问题，原本分布式的控制平面集中化后，随着网络规模的扩大，控制器可能会成为网络性能的瓶颈。

### 拥塞控制

因出现过量的分组而引起网络性能下降的现象称为**拥塞**。判断网络是否进入拥塞状态的方式是，观察网络的吞吐量与网络负载的关系：
- 若随着网络负载的增加，网络的吞吐量明显小于正常吞吐量，则网络就可能已进入轻度拥塞状态。
- 若网络的吞吐量随着网络负载的增大而下降，则网络就可能已进入拥塞状态。

拥塞控制主要解决的问题是如何获取网络中发生拥塞的信息，从而利用这些信息进行控制，以避免因拥塞而出现分组的丢失。拥塞控制的两种方法：
1. **开环控制**：在设计网络时事先将有关拥塞的因素考虑周期，力求网络在工作时不产生拥塞。这是一种静态的预防方法。一旦整个系统启动并运行，中途就不再需要修改。
2. **闭环控制**：事先不考虑有关发生拥塞的各种因素，采用检测网络系统去监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。

## IPv4

IPv4 即现在普遍使用的**网际协议**(Internet Protocol, IP)。IP 定义数据传送的基本单元**IP 分组**及其确切的数据格式。IP 也包含一套规则，指明分组如何处理、错误怎样控制。特别是 IP 还包含非可靠投递的思想，以及与此关联的路由选择思想。

### IPv4 分组的格式

一个 **IP 分组**(或者称为 **IP 数据报**) 由**首部**和**数据部分**组成。
- **首部**：前一部分的长度固定，共 20 字节，是所有 IP 分组必须具有的。在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制。
- **数据部分**：承载着上层协议的数据，如 TCP、UDP 等协议的数据。

> [!example] IP 首部
> ![[image/网络层-1.png|IP 数据报]]
> IP 首部的重要字段及其含义如下：
> 1. **版本**。占 4 位，指 IP 的版本，IPv4 数据报中该字段值为 4。
> 2. **首部长度**。占 4 位，以 **4 字节** 为单位，最大可表示的首部长度为 60 字节。最常用的首部长度是 20 字节，字段值为 5，此时不使用任何可选字段。
> 3. **总长度**。占 16 位，指首部和数据之和的长度，单位 **1 字节**，因此数据报的最大长度为 $2^{16}-1=65535$ 字节。以太网帧的最大传输单元 (MTU) 为 1500 字节，因此当一个 IP 数据报封装为帧时，数据报的总长度 (首部加数据) 一定不能超过下面的数据链路层的 MTU 值。
> 4. **标识**。占 16 位，它是一个计数器，每产生一个数据报就加 1，并赋值给标识字段。但它并不是序号。当一个数据报的长度超过网络的 MTU 时，必须分片，此时每个数据报片都复制一次标识号，以便能正确地重装为原来的数据报。
> 5. **标志**(Flag)。占 3 位，主要关注其最低位 MF 与次低位 DF。
> 	- MF(More Fragment)：1 表示后面还有分片，0 表示后面没有分片。
> 	- DF(Don't Fragment)：1 表示不允许分片^[若一个 IP 数据报的 DF=1，且其大小大于当前链路的 MTU，则该 IP 数据报无法正确发送，传输节点会直接丢弃该 IP 数据报，并向源节点发送 ICMP 差错报文。]，0 表示允许分片。
> 6. **片偏移**。占 13 位，它指出较长的数据报在分片后，某片在原数据报中的相对位置，片偏移以 **8 字节** 为偏移单位。除了最后一个分片外，每个分片的长度一定是 **8 字节** 的整数倍。
> 7. **生存时间**(TTL)，占 8 位。数据报在==网络中可通过的路由器的最大值==，标识数据报在网络中的寿命，以确保数据报不会永远在网络中循环。路由器在转发数据报之前，先将 TTL 减 1，若 TTL 被减为 0，则该数据报必须丢弃。
> 8. **协议**。占 8 位，指出该数据报携带的数据使用何种协议，即数据报的数据部分应上交给哪个协议进行处理，如 TCP、UDP 等。其中 6 表示 TCP，17 表示 UDP。
> 9. **首部校验和**。占 16 位，它只检验数据报的首部，但不包括数据部分。这是因为数据报每经过一个路由器，都要重新计算首部校验和。不检验数据部分可减少计算的工作量。
> 10. **源地址字段**。占 4 字节，标识发送方的 IP 地址。
> 11. **目的地址字段**。占 4 字节，标识接收方的 IP 地址。

> [!tip] 418，首总偏

> [!note] IP 数据报分片
> 一个链路层数据帧能承载的最大数据量称为**最大传送单元**(MTU)。因为 IP 数据报被封装在链路层的帧中，因此链路层的 MTU 严格地限制了 IP 数据报的长度，而且在 IP 数据报的源与目的地路径上各段链路可能使用不同的链路层协议，有不同的 MTU。例如，以太网的 MTU 为 1500 字节，而许多广域网的 MTU 不超过 576 字节。
>
> 当 IP 数据报的总长度大于链路 MTU 时，就需要将 IP 数据报中的数据分装在多个较小的 IP 数据报中，这些较小的数据报称为**片**。在 IP 数据报中，是通过片偏移和标志位、标识位来组合片的。
> - 接收节点根据标识位来判断来自同一 IP 地址的哪些 IP 数据报是由一个 IP 数据报分片得到的。
> - 通过片偏移，计算得到每个片中数据部分在原来的 IP 数据报的起始位置。
> - 通过标志位来判断当前片之后是否还有片，若 MF=0，则当前片为最后一个片。
>
> **除了最后一个片外，其余片的数据部分都是 8 字节的整数倍，这是因片偏移是以 8 字节为单位的**。

### IPv4 地址

IP 地址是给互联网上的每台主机 (或路由器) 的每个接口分配的一个在全球范围内唯一的 32 位标识符。IP 地址由互联网名字和数字分配机构 ICANN 进行分配。

互联网早期采用的是分类的 IP 地址。无论哪种 IP 地址，都是由**网络号**和**主机号**两部分组成。
- **网络号**：标识主机 (或路由器) 连接到的网络。一个网络号在整个互联网范围内必须是唯一的。
- **主机号**：标识该主机 (或路由器)。一台主机的主机号在它前面的网络号所指明的网络范围内必须是唯一的。

> [!example] 早期 IP 地址分类
> ![[image/网络层-2.png]]

> [!tip] 一个 IP 地址在整个互联网范围内是唯一的。

> [!note] 特殊 IP 地址
> 在各类 IP 地址中，有些 IP 地址具有特殊用途，不用做主机的 IP 地址：
> - **主机号全 0**表示本网络本身，例如 202.98.174.0
> - **主机号全 1**表示本网络的广播地址，又称**直接广播地址**，如 202.98.174.255
> - ==127.x.x.x==保留为**环回自检**(Loopback Test) 地址，此地址表示任意主机本身，目的地址为环回地址的 IP 数据报永远不会出现在任何网络上。
> - **32 位全为 0**表示本网络上的主机，即 0.0.0.0
> - **32 位全为 1**表示整个 TCP/IP 网络的广播地址，又称**受限广播地址**，即 255.255.255.255
> 	- 实际使用时，由于路由器对广播域的隔离，255.255.255.255 等效为本网络的广播地址

> [!note] IP 地址的重要特点
> 1. 每个 IP 地址都由网络号和主机号组成，因此 IP 地址是一种**分等级的地址结构**。分等级的好处是
> 	1. IP 地址管理机构在分配 IP 地址时只需分配网络号，而主机号由得到该网络的单位自行分配，方便了 IP 地址的管理。
> 	2. 路由器仅根据目的的主机所连接的网络号来转发分组，从而减少了路由表所占的存储空间。
> 2. IP 地址是标志一台主机 (或路由器) 和一条链路的接口。当一台主机同时连接到两个网络时，该主机就必须同时具有两个相应的 IP 地址，其网络号必须是不同的。因此路由器至少应具有两个或两个以上的 IP 地址，每个端口都有一个不同网络号的 IP 地址。
> 3. 用转发器或桥接器连接的若干 LAN 仍然是同一个网络 (同一个广播域)，因此该 LAN 中所有主机的 IP 地址的网络号必须相同，但主机号必须不同。
> 4. 在 IP 地址中，所有分配到网络号的网络 (无论是 LAN 还是 WAN) 都是平等的。
> 5. 在同一个局域网上的主机或路由器接口的 IP 地址中的网络号必须是相同的。

### 子网划分与子网掩码

从 1985 年起，在 IP 地址中引入了子网号字段，将原本的两级 IP 地址结构扩展为三级 IP 地址结构。这一过程被称为**划分子网**。其核心思想包括：
- 划分子网是组织内部的私有操作，从外部看，该单位依然呈现为单一的网络。
- 划分子网的方法是从网络的主机号中借取若干位作为子网号。三级 IP 地址的结构为 `网络号，子网号，主机号`。
- 路由器在转发数据包时依据的是 IP 数据报的目的网络号，本单位的路由器在接收到 IP 数据报后，会根据目的网络号和子网号来定位目的子网，最终将数据报递交给目的主机。

> [!note]
> 1. 划分子网仅涉及 IP 地址的主机号部分的再划分，而不改变原有的网络号。因此，单凭一个 IP 地址本身无法判断该主机所属的网络是否进行了子网划分。
> 2. 子网中的主机号全 0 或全 1 的地址不能分配给具体主机，其中主机号全 0 的地址代表该子网的网络地址，而主机号全 1 的地址为该子网的广播地址。

> [!note] 子网掩码
> 子网掩码用于明确分类 IP 地址中网络号与子网号所占据的位数。
> - 子网掩码中，1 表示 IP 地址中的网络号及子网号部分，而 0 表示主机号部分。
> - 主机或路由器只需将 IP 地址与其对应的子网掩码进行逐位逻辑与运算，即可获得目标子网的网络地址。
>
> 根据现代互联网标准，所有网络均需使用子网掩码。对于未划分子网的网络，使用**默认子网掩码**。A、B、C 类地址的默认子网掩码分别为 255.0.0.0、255.255.0.0、255.255.255.0，分别对应 8 个 1、16 个 1、24 个 1。

> [!tip]
> 常用的子网掩码有两种表示方式，一种是与 IP 地址相同的，使用 10 进制表示。另一种是直接在 IP 地址的后面加上其网络号与子网号的长度，例如 192.168.1.1/17，这种表示方法称为 CIDR 表示方法，其后缀称为**网络前缀**。

> [!tip] 路由表中的子网掩码与主机中的子网掩码
> - **主机中的子网掩码**：主机在发送数据报前，需要先使用自己配置的子网掩码与目的 IP 地址逐位相与，判断对方是否与自己处于同一个局域网中。如果在同一个局域网中，则直接在帧中指定对方的 MAC 地址。如果不属于同一个局域网，则将帧发送到默认网关中。
> - **路由表中的子网掩码**：路由器在转发数据报时，会比较路由表中子网掩码部分的 IP 地址与目的 IP 地址，如果相同，则进行转发。

> [!example] 使用子网掩码的转发过程
> ![[image/网络层-3.png]]
> 1. 在上图中，某学校配置了两个子网，需要使用 1bit，因此子网掩码为 17 个 1（即 /17，或者 255.255.128.0）。
> 2. H3->H6：相同子网之间发送。
>     1. 网络层：H3 构造 IP 数据报，源地址为自己的 IP 地址，目的地址为 H6 的 IP 地址。使用子网掩码确认两者在同一子网。
>     2. 数据链路层：将 IP 数据报封装成 MAC 帧，指明接收地址为 H6 的 MAC 地址。数据帧通过交换机到达 H6 的广播域，H6 接收并处理该帧，H5 丢弃。
>     3. 网络层：H6 对比接收数据的目的 IP 地址与自己的 IP 地址，发现一致，完成传输。
> 3. H1->H3：不同子网之间发送。
>     1. 网络层：H1 构造 IP 数据报，源地址为自己的 IP 地址，目的地址为 H3 的 IP 地址。使用子网掩码确认两者不在同一子网。
>     2. 数据链路层：将 IP 数据报封装为 MAC 帧，指明接收地址为路由器 B3 接口的 MAC 地址。数据帧通过交换机到达路由器 B。
>     3. 网络层：路由器 B 查找路由表，确定转发接口为 B2。
>     4. 数据链路层：将 IP 数据报重新封装为 MAC 帧，指明接收地址为 H3 的 MAC 地址，从 B2 接口发出，通过交换机到达 H3。
>     5. 网络层：H3 检查 IP 数据报中的目的 IP 地址与自己的 IP 地址，发现一致，完成传输。
> 4. H1->H7：不同网络之间发送。
>     1. 网络层：H1 构造 IP 数据报，源地址为自己的 IP 地址，目的地址为 H7 的 IP 地址。使用子网掩码确认两者不在同一网络。
>     2. 数据链路层：将 IP 数据报封装为 MAC 帧，指明接收地址为路由器 B3 接口的 MAC 地址。数据帧通过交换机到达路由器 B。
>     3. 网络层：路由器 B 查找路由表，确定转发接口为 B0。
>     4. 数据链路层：将 IP 数据报重新封装为 MAC 帧，指明接收地址为路由器 C0 接口的 MAC 地址，从 B0 接口发出。
>     5. 网络层：路由器 C 查找路由表，确定转发接口为 C2，因为某公司使用的是 C 类地址（24 位网络号）。
>     6. 数据链路层：将 IP 数据报重新封装为 MAC 帧，指明接收地址为 H7 的 MAC 地址，从 C2 接口发出，通过交换机到达 H7。
>     7. 网络层：H7 检查 IP 数据报中的目的 IP 地址与自己的 IP 地址，发现一致，完成传输。

### 无分类编址

**无分类域间路由选择**(Classless Inter-Domain Routing, CIDR) 是在变长子网掩码的基础上，提出的一种消除传统 A、B、C 类地址及划分子网的概念。CIDR 使用**网络前缀**的概念代替网络的概念，与传统分类 IP 地址最大的区别是，网络前缀的位数不是固定的，可以任意选取。

> [!note] 变长子网划分
> - 定长子网划分：采用定长子网掩码划分子网时，所划分的每个子网使用相同的子网掩码，并且每个子网所分配的 IP 地址数量也相同，因此容易造成地址资源的浪费。
> - 变长子网划分：采用变长子网掩码划分子网时，所划分的每个子网可以使用不同的子网掩码，并且每个子网所分配的 IP 地址数量可以不同，这样就尽可能减少了对地址资源的浪费。
> 	- 构造变长子网掩码的过程就是从根节点开始构造 [[数据结构与算法/树与二叉树#哈夫曼树|哈夫曼树]]，树的每个叶子都对一个子网，深度越深，子网中的地址越少。

> [!warning]- 不论使用什么划分方法，全 0 和全 1 地址都不允许使用。
> 由于全 0 地址和全 1 地址不允许被使用，因此最小的子网需要 2bit 进行编码。

> [!note] 路由聚合
> 由于一个 CIDR 地址块中有很多地址，所以在路由表中就可以利用 CIDR 地址块来查找目的网络。这种地址块称为**路由聚合**，也称构成**超网**，它使得路由表中的一个项目可以表示多个原来传统分类地址的路由，有利于减少路由器之间的信息交换，从而提高网络性能。
>
> 加入路由聚合后，使用 CIDR 时路由表中的个项由网络前缀与下跳地址组成。此时查找路由表时可能会得到不止一个匹配结果。此时，应当从匹配结构中选择具有**最长匹配网络前缀的路由**，因为网络前缀越长，其地址块越小，路由越具体。
>
> 为了更有效地查找最长前缀匹配，通常将无分类编址的路由表使用一个层次式数据结构 (通常为 [[数据结构与算法/树与二叉树#线索二叉树|线索二叉树]]) 中，然后自上而下地按层次进行查找。

> [!tip] 默认网关
> 由于使用路由聚合网络中允许使用多个路由器，因此在每个计算机中，除了要配置 IP 地址、子网掩码外，还有配置默认网关。在该计算机发送数据到路由器时，会发送给默认网关的路由器。*如果默认网关接受到的 IP 数据报需要从原来的窗口再次转发出去，则默认网关会直接丢弃该数据，不是将该数据转发回去*。

### NAT

**网络地址转换**(Network Address Translation, NAT) 是指通过将专用网络地址 (如 Intranet) 转换为公用地址 (如 Internet)，从而对外隐藏内部管理的 IP 地址。它使得整个专用网本地 IP 地址是可重用的，所以 NAT 大大节省了 IP 地址的消耗。同时，它隐藏了内部网络结构，从而降低了内部网络受到攻击的风险。

> [!note] 私有 IP 网段
> 为了网络安全，划分出了部分 IP 地址为私有 IP 地址。私有 IP 地址只用于 LAN，不用于 WAN 连接^[私有 IP 地址不能直接用于 Internet，必须通过网关利用 NAT 把私有 IP 地址转换为 Internet 中合法的全球 IP 地址后才能出现在 Internet 上]，并且允许私有 IP 地址被 LAN 重复使用。这有效地解决了 IP 地址不足的问题。私有 IP 网段如下：
> - 1 个 A 类网段，即 10.0.0.0 ~ 10.255.255.255
> - 16 个 B 类网段，即 172.16.0.0 ~ 172.31.255.255
> - 256 个 C 类网段，即 192.168.0.0 ~ 192.168.255.255
>
> 在互联网中的所有路由器，对目的地址是私有地址的数据一律不进行转发。这种采用私有地址的互联网称为**专用互联网**或**本地互联网**。私有 IP 地址也称**可重用地址**。

在可以使用 NAT 的路由器中，保存了一个 NAT 转换表，该表保存了
- 将外网端口转换为内网端口的映射
- 将外网 IP 地址转换为内网 IP 地址的映射。一般而言，多个内网 IP 对应一个外网 IP，而内网不同 IP 的不同端口被转换为外网 IP 的不同端口。
- 在发送数据时，具有 NAT 功能的路由器会自动修改传输层协议中的源端口与网络层协议中的源 IP，将内网端口与 IP 转换为外网端口与 IP。
- 在接收数据时，具有 NAT 功能的路由器会自动修改接收数据中的目的端口与目的 IP，从而发送到内网的对应设备上。

> [!tip] NAT 路由器改变的内容
> 普通路由器在转发 IP 分组时，其源 IP 地址和目的 IP 地址都不会改变。而 NAT 路由器在转发 IP 分组时，一定要更换其 IP 地址。因此，普通路由器仅工作在网络层，而 NAT 路由器工作在传输层和网络层。当 IP 数据报经过 NAT 路由器时，会发生改变的内容有：
> 1. IP 数据报的源地址
> 2. IP 数据报的首部校验和
> 3. IP 数据报的生存周期
> 4. TCP/UDP 端口号

### ARP

无论网络层使用什么协议，在实际网络的链路上传输数据帧时，最终必须使用硬件地址。所以需要一种方法来完成 IP 地址到 MAC 地址的映射，这就是**地址解析协议**(Address Resolution Protocol, ARP)。每台主机都设有一个 **ARP 高速缓存**，用来存放本地局域网上各主机和路由器的 IP 地址到 MAC 地址的映射表，称**ARP 表**。使用 ARP 来动态维护 ARP 表。

ARP 工作在网络层，其工作原理如下：
1. 主机 A 欲向本局域网上的某台主机 B 发送 IP 数据报时，先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。
	- 若有，则直接查出其对应的硬件地址，然后将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。
	- 若没有，则广播发出一个 ARP 请求分组。主机 B 在收到 ARP 请求后，向主机 A 返回一个 ARP 响应分组。
2. **ARP 请求分组**：包含请求方的 IP 地址与 MAC 地址，被请求方的 IP 地址。==广播帧==。
3. **ARP 响应分组**：包含被请求方的 MAC 地址。==单播帧==。

> [!tip] ARP 是双向的，发送方与接收方都会保存对方的 MAC 地址。

> [!tip]
> ARP 工作在网络层，其与 IP 协议相同，在发送 ARP 数据时，会被包裹在数据链路层的 [[计算机网络/数据链路层#组帧|帧]] 中，靠帧中的协议位进行区别。

### DHCP

**动态主机配置协议**(Dynamic Host Configuration Protocol, DHCP) 常用于给主机动态地分配 IP 地址，它提供了即插即用的连网机制，这种机制允许一台计算机加入新的网络和自动获取 IP 地址而不用手工参与。==DHCP 是应用层协议，它是基于 UDP 的==。

DHCP 的工作过程如下：
1. DHCP 客户广播 **DHCP 发现**(discovery) 消息，试图找到网络中的 DHCP 服务器，以便从 DHCP 服务器中获得一个地址。
	- 应用层：DHCP 发现报文，包含客户的 MAC 地址
	- 传输层：UDP 数据报，包含发送端口 67 与接收端口 68，这两个是保留端口。
	- 网络层：IP 数据报，源地址 0.0.0.0，目的地址 255.255.255.255(广播)
	- 数据链路层：MAC 帧，源地址为客户的 MAC 地址，接收地址为全 1(广播)
2. 只有 DHCP 服务器收到 discovery 后会接收，其他的设备会在传输层被拒绝。DHCP 服务器收到 discovery 后，广播 **DHCP 提供**(offer) 消息，其中包括提供给 DHCP 客户机的 IP 地址。
	- 应用层：DHCP 提供报文，包含提供的 IP 地址，租用期，子网掩码和默认网关。
	- 传输层：UDP 数据报，包含发送端口 68 与接收端口 67。
	- 网络层：IP 数据报，源地址为 DHCP 地址，目的地址为 255.255.255.255(广播)
	- 数据链路层：MAC 帧，源地址为 DHCP 地址，目的地址为客户机的 MAC 地址。
3. DHCP 客户收到 offer 后，若接收该 IP 地址，则广播 **DHCP 请求**(request) 消息向所有 DHCP 服务器描述其接收的 IP 地址。
	- 应用层：DHCP 请求报文，包含客户接受的 IP 地址。
	- 传输层：UDP 数据报，包含发送端口 67 与接收端口 68。
	- 网络层：IP 数据报，源地址为 0.0.0.0，目的地址为 255.255.255.255(广播)
	- 数据链路层：MAC 帧，源地址为客户的 MAC 地址，接收地址为全 1(广播)
4. DHCP 服务器广播 **DHCP 确认**(acknowledge) 消息，将 IP 地址分配给 DHCP 客户。
	- 应用层：DHCP 确认报文，包含确认 IP 地址、租用期、子网掩码和默认网关。
	- 传输层：UDP 数据报，包含目的端口号 68 和源端口号 67。
	- 网络层：IP 数据报，源地址为 DHCP 地址，目的地址为 255.255.255.255(广播)
	- 数据链路层：MAC 帧，源地址为 DHCP 地址，目的地址为客户机的 MAC 地址。

> [!tip]
> DHCP 除了配置 IP 地址、默认网关、子网掩码外，还会配置局域网的默认 DNS 服务器地址。在第一次请求 DNS 服务时，还需要利用 ARP 协议请求 DNS 主机的 MAC 地址。

### ICMP

为了有效地转发 IP 数据报和提高交付成功的机会，在网络层使用了**网际控制报文协议**(Internet Control Message Protocol, ICMP)，让主机或路由器报告差错和异常情况。ICMP 报文被封装在 IP 数据报中发送，但是 ICMP 不是高层协议，而是网络层协议。

ICMP 报文有两种，分别是**ICMP 差错报文**和**ICMP 询问报文**。

> [!note] ICMP 差错报文
> 1. **终点不可达**：当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。
> 2. **源点抑制**：当路由器或主机因为拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。
> 3. **时间超过**：当路由器收到生存时间 TTL 为零的数据报时，除了丢弃数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内服务收到一个数据报的全部数据时，就把已收到的数据报片丢弃，然后向源点发送时间超过报文。
> 4. **参数问题**：当路由器或目的主机收到的数据报的首部中有字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
> 5. **改变路由**(重定向)：路由器把改变路由的报文发送给主机，让主机知道下次数据报发送给另外的路由器。

> [!tip] 以下情况不应发送 ICMP 差错报文
> 1. 对 ICMP 差错报文，不再发送 ICMP 差错报文。
> 2. 对第一个分片的数据报片的所有后续数据报片，都不发送 ICMP 差错报文。
> 3. 对具有多播地址的数据报，都不发送 ICMP 差错报文。
> 4. 对具有特殊地址 (127.0.0.0 或 0.0.0.0) 的数据报，不发送 ICMP 差错报文。

> [!note] ICMP 询问报文
> 1. 回送请求和回答报文。
> 2. 时间戳请求和回答报文。
> 3. 地址掩码请求和回答报文。
> 4. 路由器询问和通告报文。

> [!warning]
> ICMP 报文的两个常见的应用是**分组网间探测**(PING) 和 **Traceroute**。其中：
> - PING：工作在应用层，但是直接使用了网络层的 ICMP 回答请求和回答报文。
> - Traceroute：工作在网络层，使用了 ICMP 的时间超过报文。

## IPv6

目前广泛使用的 IPv4 是在 20 世纪 70 年代设计的，互联网经过几十年的发展，到 2011 年 2 月，IPv4 地址已经耗尽，为了解决地址耗尽的问题，有以下三种措施：
1. 采用无类别编址 CIDR，使 IP 地址的分配更加合理。
2. 采用网络地址转换 (NAT) 方法以节省全球的 IP 地址。
3. 采用具有更大地址空间的新版本 IPv6。

前两种方法都只能延长 IPv4 的寿命，只有第三种方法可以从根本上解决 IP 地址耗尽的问题。

> [!note] IPv6 的特点
> 1. **更大的地址空间**。IPv6 将地址从 IPv4 的 32 位增大到 128 位，从长远来看，这些地址是绝对够用的。
> 2. **扩展的地址层次结构**。IPv6 因为地址空间很大，所以可以划分更多的层次。
> 3. **灵活的首部格式**。IPv6 定义了许多可选的扩展首部，不仅可提供比 IPv4 更多的功能，而且能提高路由器的处理效率，这是因为路由器对扩展首部不进行处理。
> 4. **改进的选项**。IPv6 首部的长度是固定的，其选项放在有效载荷中，选项是灵活可变的。而 IPv4 所规定的选项是固定不变的。
> 5. **允许协议继续扩充**。IPv6 允许不断扩充功能，而 IPv4 的功能是固定不变的。
> 6. **支持即插即用**。IPv6 支持自动配置，不需要 DHCP。
> 7. **支持资源的预分配**。
> 8. IPv6 只有源主机才能分片，是端到端的，不允许类似 IPv4 传输路径中的路由分片。
> 9. IPv6 首部是固定的 40B，则 IPv4 首部的长度是可变的。

> [!tip]
> 虽然 IPv6 与 IPv4 不兼容，但是它与所有其他互联网协议兼容，如 TCP、UDP、ICMP、IGMP 和 DNS 等，只是在少数地方做了必要的修改。

> [!note] 从 IPv4 向 IPv6 过渡
> 从 IPv4 向 IPv6 过渡可以采用下列两种策略：
> 1. **双协议栈**，指在同一个台设备上同时装有 IPv4 和 IPv6 两个协议栈，分别配置一个 IPv4 地址和 IPv6 地址，因此这台设备既能和 IPv4 网络通信，也能和 IPv6 网络通信。
> 2. **隧道技术**，指在 IPv6 数据报要进入 IPv4 网络时，把整个 IPv6 数据报封装为 IPv4 数据报的数据部分，使得原来的 IPv6 数据报就好像在 IPv4 网络的隧道传输一样。在 IPv4 数据报离开 IPv4 网络时，再将其数据部分交给主机的 IPv6 协议。

## 路由算法

路由选择协议的核心是**路由算法**，即需要何种算法来获得路由表中的各个项目。路由算法的目的很简单，即给定一组路由器及连接路由器的链路，路由算法要找到一条从源路由器到目的路由器的最佳路径。通过，最佳路径指具有最低费用的路径。

路由器转发分组是通过路由表转发的，而路由表是通过各种算法得到的。从能够随网络的通信量或拓扑自适应地进行调整变化来划分，路由算法可以分为：
- **静态路由算法**。指由网络管理员手工配置每一条路由。
	- 优点：算法简单，开销小。
	- 缺点：不能及时适应网络状态的变化，适用于简单的小型网络。
- **动态路由算法**。根据网络流量载荷和拓扑结构的变换来动态调整自身的路由表。
	- 优点：能较好地适应网络的变化。
	- 缺点：实现复杂，开销大，适用于较复杂的大型网络。

常用的动态路由算法有距离-向量路由算法和链路状态路由算法。
- **距离-向量路由算法**：基于 Bellman-Ford 算法的单源最短路径算法。典型的例子是 RIP 算法。
- **链路状态路由算法**：基于 Dijkstra 算法的单元最短路径算法。典型的例子是 OSPF 算法。

|    协议    |     RIP     |   OSPF    |          BGP           |
| :------: | :---------: | :-------: | :--------------------: |
|  **类型**  |     内部      |    内部     |           外部           |
| **路由算法** |    距离-向量    |   链路状态    |          路径向量          |
| **传递协议** |     UDP     |    IP     |          TCP           |
| **路径选择** |    跳数最少     |   代价最低    |         较好的路径          |
| **交换节点** | 和本节点相邻的路由器  | 网络中的所有路由器 |       和本节点相邻的路由器       |
| **交换内容** | 所有已知信息，即路由表 | 相邻节点的链路状态 | 第一次：整个路由表<br>之后：有变化的部分 |

### 分层次的路由选择协议

互联网采用的是自适应的、分布式路由选择协议。因为互联网的规模非常大，许多联网单位不愿让外界了解自己单位网络的布局细节，所有互联网采用分层次的路由选择协议。

为此，可以把整个互联网划分为许多较小的**自治系统**(Autonomous System, AS)。自治系统是在单一技术管理下的一组路由器，这些路由器使用一种 AS 内部的路由选择协议和共同的度量。一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略。
1. **内网网关协议**(Interior Gateway Protocol, IGP)：在一个自治系统内部使用的路由选择协议，它与在互联网中的其他自治系统选用什么路由选择协议无关。目前这类路由选择协议使用得最多，如 RIP 和 OSPF。
2. **外部网关协议**(External Gateway Protocol, EGP)：若源主机和目的主机处在不同的自治系统中 (两个自治系统可以使用不同的 IGP)，则当数据报传到一个自治系统的边界时，就需要使用 EGP 将路由选择信息传递到另一个自治系统中。目前使用最多的外部网关协议是 BGP-4。

> [!note]
> 自治系统之间的路由选择协议也称**域间路由选择**，自治系统内部的路由选择也称**域内路由选择**。

### RIP

**路由信息协议**(Routing Information Protocol, RIP) 是内部网关协议 IGP 中最先得到广泛应用的协议。RIP 是一种分布式的基于距离向量的路由选择协议，基于 Bellman-Ford 算法。
1. 网络中的每个路由器都要维护从它自身到其他每个目的网络的距离记录，即**距离向量**。
2. RIP 使用**跳数**来衡量到达目的网络的距离。规定从一路由器到直接连接网络的距离为 1，每经过一个路由器，距离就加 1。
3. RIP 认为好的路由就是它通过的路由器数目少，即距离短或跳数少。
4. RIP 运行一条路径最多只能包含 15 个路由器，即距离向量等于 16 时表示网络不可达。因此 RIP 只适用于小型互联网。
5. 每个路由表中都有三个关键字：`<目的网络N，距离d，下一跳路由器地址X>`。

> [!note] RIP 距离向量算法
> 每经过 30 秒，相邻节点交换一次 RIP 报文。对每个相邻路由器发来的 RIP 报文，执行如下步骤：
> 1. 对地址为 X 的相邻路由器发来的 RIP 报文时，先将下一跳中的地址修改为 X，然后将距离加 1。
> 2. 对于修改后的 RIP 报文中的每个项目，执行：
> 	1. 若原来的路由表中没有目的网络 N，则将该项目添加到路由表中。
> 	2. 若原来的路由表中有目的网络，且下一跳的地址为 X，则更新 X 的路由表项。
> 	3. 若原来的路由表中有目的网络，但下一跳的地址不为 X，则取距离较小的一项。
> 3. 若 180 秒还没有收到相邻路由器的更新路由表，则把此相邻路由器标记为不可达路由器，将其距离设置为 16。

> [!tip]
> RIP 中每个节点会保存上一次邻居节点发来的距离向量。当节点周围的信息突变，会从本地的缓存中寻找一个合适的下一跳节点。例如，A 与 B 向量，B 与 C 网络相连。
> 1. 当 RIP 收敛时，A->C 为 2，B->C 为 1。
> 2. 若此时 B 与 C 之间的连接断开，则 B 会寻找上一次的缓存，发现可以从 A 到达 C，距离为 2，则修改自己的路由表为 B->C 为 3。下一跳地址为 A。
> 3. 经过一次交换后，A->C 的距离更新为 4，下一跳为 B。
> 4. 再经过一次交换后，B->C 的距离更新为 5，下一跳为 A。
> 5. 以此往复，直到两个节点到 C 的距离都为 16，此时 C 不可达。
>
> 由此可见，在 RIP 中，需要经过较长的时间才能将故障传遍网络。

> [!warning]
> RIP 是==应用层==协议，它使用 UDP 传送数据 (端口 520)，RIP 选择的路径不一定是时间最短的，但是一定是具有最少的路由跳数。

> [!note] RIP 的特点
> - 优点：
> 	1. 实现简单，开销小，收敛快
> 	2. 若一个路由器发现了更短的路由，则这种更新信息就传播得很快，在较短时间内便可被传至所有路由器。
> - 缺点：
> 	1. RIP 限制了网络的规模，他能使用的最大距离为 15。
> 	2. 路由器之间交换的是完整的路由表，因此网络规模越大，开销越大。
> 	3. 当网络出现故障时，路由器之间需要反复多次交换信息才能完成收敛，要经过较长时间才能将故障信息传送到所有路由器 (**慢收敛现象**)。

### OSPF

**开放最短路径优先**(OSPF) 协议是使用分布式链路状态路由算法的典型代表，也是 [[#分层次的路由选择协议|IGP]] 的一种。OSPF 协议有以下特点：
1. OSPF 允许对每条路由设置成不同的代价，对于不同类型的业务可计算出不同的路由。
2. 若到同一个目的网络有多条相同代价的路径，则可将通信量分配给这几条路径。
3. OSPF 分组具有鉴别功能，从而保证仅在可信赖的路由器之间交换链路信息。
4. OSPF 支持可变长度的子网划分 CIDR。
5. 每个链路状态都带上一个 32 位的序号，序号越大，状态越新。

> [!note] OSPF 与 RIP 的区别
> 1. OSPF 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法。而 RIP 仅仅向自己相邻的几个路由器发送信息。
> 2. 发送的信息是与本路由器相邻的所有路由器的链路状态。在 RIP 中，发送的信息是本路由的所有已知信息，即路由表。
> 3. 只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息，并且更新过程收敛得快，不会出现 RIP 坏消息传得慢的问题。在 RIP 中，不管网络拓扑是否发生变化，路由器之间都要定期交换路由表的信息。
> 4. OSPF 是网络层协议，直接使用 IP 数据报传送。而 RIP 是应用层协议，它在传输层使用 UDP。

OSPF 的基本工作原理如下：
1. 每个路由器都保存了全网的拓扑结构图，在发送数据时，利用自身链路状态数据库中的数据，通过 Dijkstra 算法计算自己到各目的网络的最优路径，构造出自己的路由表，然后根据路由表转发。
2. 当链路状态发送变化时，每个路由器重新计算到达各目的网络的最优路径，构造出新的路由表，包含目的 IP、子网掩码和下一跳。

> [!note] 洪泛法
> 1. 当网络检测到自己相邻节点的链路状态变化时，该节点会向所有相邻节点转发 OSPF 链路状态报文 (IP 数据报)。
> 2. 当节点收到其他节点发送的 OSPF 链路状态报文，则向除了发送节点外的所有其他相邻节点转发。
> 3. 当节点重复收到相同的 OSPF 链路报文时，直接丢弃。
>
> 洪泛法类似 BFS 算法的遍历，但是每个节点都可以独立的发送 OSPF 报文。传播过程就像洪水，可以快速的传遍整个网络。

> [!note] OSPF 分组类型
> 1. 问候分组：用来发现和维持邻站的可达性。*网络中通常传送的是问候分组，两个相邻路由器通常每隔 10 秒就要交换一次问候分组，以便知道哪些站可达，若 40 秒没有收到路由器发来的问候分组，则认为该路由器不可达*。
> 2. 数据库描述分组：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
> 3. 链路状态请求分组：向对方请求发送某些链路状态项目的详细信息。
> 4. 链路状态更新分组：用洪泛法对全网更新链路状态，它是 OSPF 的核心。
> 5. 链路状态确认分组：对链路更新分组的确认。

### BGP

**边界网关协议**(Border Gateway Protocol, BGP) 是不同自治系统 AS 的路由器之间交换路由信息的协议，是一种外部网关协议。边界网关协议 BGP 常用于互联网的网关之间。BGP 主要是设法使数据报在一个 AS 中尽可能有效地从源站传送到目的站。

BGP 只能力求找到一条能够到达目的网络且较好的路由，而并非寻找最优路由。BGP 采用的是**路径向量**路由选择协议，它与距离向量协议与链路状态协议都有很大的区别。BGP 是应用层协议，基于 TCP。它的工作原理如下：
1. 配置 BGP 时，每个 AS 的管理员要选择至少一个路由器，作为该 AS 的边界路由器。
2. 一个边界路由器要与其他 AS 中的边界路由器交换路由信息，就要建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话，在利用 BGP 会话交换路由信息。
	- 使用 TCP 连接交换路由信息的两个边界路由器，彼此称为对方的**邻站**或**对等站**。
	- 每个 GBP 边界路由器除了要运行 BGP 协议外，还要运行本 AS 所用的内部网关协议。
3. BGP 交换网络可达性的信息，即要达到某个网络要经过的一系列自治系统。当边界路由器相互交换网络可达性信息后，各边界路由器就根据所用的策略，从收到的路由信息中找出到达各自制系统中较好的路由。

> [!note] BGP 的特点
> 1. BGP 交换路由信息的节点数量级是 AS 个数，这比 AS 中的网络要少得多。
> 2. 寻找一条较好的路径，取决于找到正确的边界路由器，而 AS 中的边界路由器是很少的。这使得 AS 之间的路由选择不至于过分复杂。
> 3. BGP 支持 CIDR，因此 BGP 的路由表也包含目的网络前缀、下一跳路由器和到达该目的网络所要经过的各个自治系统序列。
> 4. 当 BGP 刚运行时，BGP 的邻站交换整个 BGP 路由表。但以后只需要在发送变化时更新有变化的部分。

> [!note] BGP 报文
> 1. 打开 (Open) 报文：用来与相邻的另一个 BGP 边界路由器建立关系，使通信初始化。
> 2. 更新 (Update) 报文：用来通知某一路由器的信息，以及列出要撤销的多条路由器。
> 3. 保活 (Keepalive) 报文：用来周期性地证实邻站的连通性。
> 4. 通知 (Notification) 报文：用来发送检测到的差错。

---
< [[计算机网络/数据链路层|数据链路层]] | [[计算机网络/传输层|传输层]] >
