---
aliases: 
  - file system
tags:
  - 操作系统
---

# 文件管理

## 文件的属性

一个文件包括下面的重要属性：
1. 文件名：由创建文件的用户决定文件名，主要是为了方便用户找到文件，**同一目录下不允许有重名文件**。
2. 标识符：一个系统内的各文件标识符唯一，对用户来说毫无可读性，因此标识符只是操作系统用于区分各个文件的一种内部名称。
3. 类型：指名文件的类型。
4. 位置：文件存放的路径(让用户使用)、在外存中的地址 (操作系统使用，对用户不可见)。
5. 大小：指名文件的大小。
6. 创建时间、上次修改时间、文件所有者的信息。
7. 保护信息：对文件进行保护的访问控制信息。

## 文件的逻辑结构

所谓逻辑结构，就是指在用户看来，文件内存的数据应该是如何组织起来的。而物理结构指在操作系统开来，文件中的数据是如何放在外存中的。

### 文件内部数据的组织方式

- 无结构文件：由一些二进制或字符流组成，又称为流式文件。例如文本文件。
- 有结构文件：由一组相似的记录组成，又称记录式文件。例如数据库表。根据各条记录的长度 (占用存储空间) 是否相等，又可以分文定长记录和可变长记录两种。

### 有结构文件的逻辑结构

#### 顺序文件

顺序文件：文件中的记录一个接一个顺序排列 (逻辑上)，记录可以是定长或者可变长的。各个记录在物理上可以顺序存储或链式存储。
- 串结构：记录之间的顺序与关键词无关。
- 顺序结构：记录之间的顺序按关键词顺序排列。

顺序结构只有采用顺序存储的文件可以实现随机存取，但是增加或者删除一个记录比较困难：
- 链式存储：无论是定长、可变长记录，都无法实现随机存取，每次只能从第一个记录开始一次往后查找。
- 顺序存储：
	- 可变长记录：无法实现随机存取。每次只能从第一个记录开始一次往后查找。
	- 定长记录：可实现随机存取。记录长度为 L，则第 i 个记录存放的相对位置是 $i*L$。
		- 若采用串结构，无法快速找到某关键字对应的记录。
		- 若采用顺序结构，可以快速找到关键字对应的记录。

#### 索引文件

对于可变长记录，通过建立一张索引表以加快文件索引速度，每条记录对应一个索引项。索引表本身是定长记录的顺序文件，因此可以快速找到索引项。

每当要增加、删除一个记录时，需要对索引表进行修改。由于索引文件有很快的检索速度，因此主要用于对信息处理的及时性要求比较高的场合。此外，可以用不同的数据项建立多个索引表。

缺点：每个记录对应一个索引表项，因此索引表可能会很大。

#### 索引顺序文件

索引顺序文件时索引文件和顺序文件思想的结合。索引顺序文件中，同样会为文件建立一张索引表，但不同的是，并不是每个记录对应一个索引表项，而是一组记录对应一个索引表项。

索引顺序文件还可以多层重叠，以减少索引查找的平均时间。

### 文件间的组织方式

用户可以自己创建一层一层的目录 (文件夹)，各层目录中存放相应的文件。系统中的各个文件就通过一层一层的目录合理有序的组织起来了。目录也是一种特殊的有结构文件 (由记录组成)。

操作系统需要向上提供：
1. 创建文件：图形化界面在创建文件时需要调用，即 create 系统调用。
2. 读文件：即 read 系统调用。将文件数据读入内存，才能让 CPU 处理。
3. 写文件：即 write 系统调用。将更改过的文件数据写回外存。
4. 删除文件：即 delete 系统调用，将文件从外存中删除。
5. 打开文件：open 系统调用，读写文件之前需要打开文件。
6. 关闭文件：close 系统调用，读写文件结束之后需要关闭文件。

## 文件目录

### 文件控制块

目录本身就是一种有结构的文件，由一条条记录组成。每条记录对应一个放在该目录下的文件。目录文件中的一条记录就是一个文件控制块 (FCB)。
- FCB 的有序集合称为文件目录，一个 FCB 就是一个文件目录项。
- FCB 中包含了**文件的基本信息** (文件名、物理地址、逻辑结构、物理结构等)，存取控制信息 (是否可读、可写，静止访问的用户名单等)，使用信息 (如文件的建立时间、修改时间等)

为了控制目录，操作系统需要提供：
1. 搜索：当用户要使用一个文件时，系统根据文件名搜索目录，找到该文件对应的目录项
2. 创建文件：创建一个新文件时，需要在其所属的目录中增加一个目录项
3. 删除文件：当删除一个文件时，需要在目录中删除对应的目录项
4. 显示目录：用户可以请求显示目录的内容，如显示目录中的所有文件及相应属性
5. 修改目录：某些文件属性保存在目录中，因此这些属性变化时需要修改相应的目录项

### 目录结构

#### 单级目录结构

早期操作系统并不支持多级目录，整个系统中只建立一张目录表，每个文件占一个目录项。

单级目录实现了按名存取，但是不允许文件重名。因此单级目录不适用于多用户操作系统。

#### 两级目录结构

早期的多用户操作系统采用两级目录结构，分为主文件目录和用户文件目录。

两级目录结构允许不同用户的文件重名，也可以在目录上实现访问限制。但是两级目录结构依然缺乏灵活性，用户不能对自己的文件进行分类。

#### 多级目录结构

也称为树形目录结构。用户要访问某个文件时要用文件路径名标识文件，文件路径名是一个字符串。各级目录之间使用 "/" 隔开，从根目录出发的路径称为绝对路径。

系统根据绝对路径一层一层地找到下一级目录。显然，每次都从根目录开始查找是很低效的，因此可以设置一个当前目录。从当前目录出发找到的路径称为相对路径。

树形目录结构可以很方便的对文件进行分类，层次结构清晰，也能够更有效地进行文件的管理和保护。**但是树形结构不便于实现文件的共享**，为此，提出了无环图目录结构。

#### 无环图目录结构

在树形结构的基础上，增加一些指向同一个节点的有向边，使整个目录称为一个有向无环图。可以更加方便的实现多个用户间的文件共享。

可以用不同的文件名指向同一个文件，甚至可以指向同一个目录。

需要为每个共享节点设置一个共享计数器，用于记录此时有多少个地方在共享节点。用户提出删除节点的请求时，只是删除该用户的 FCB，并使共享计数器减 1，并不会直接删除共享节点。

### 索引节点

索引节点是对 FCB 的改进。由于查找各级目录的过程中，只需要用到文件名这一个信息，因此可以将文件的其他信息保存在索引节点中，目录表中只保存文件名与指向索引节点的指针。

这样做可以通过让目录瘦身来提升效率。

存放在外存中的索引节点称为磁盘索引节点，当索引节点放入内存后称为内存索引节点。相比之下内存索引节点中需要增加一些信息，比如文件是够被修改，此时有几个进程正在访问文件等。

## 文件物理结构 (文件分配方式)

本节即探讨文件数据应该怎样存放在外存中这个问题。

### 文件块、磁盘块

类似于内存分页，磁盘中的存储单元也被分为一个个块。在很多的操作系统中，磁盘块的大小与内存块、页面的大小相同。

内存与磁盘之间的数据交换 (即读写操作、磁盘 IO) 都是以块为单位进行的。即每次读入一块，或每次写出一块。

于是文件的逻辑地址也可以表示为 (逻辑块号，块内地址) 的形式。用户通过逻辑地址来操作自己的文件，操作系统要负责实现从逻辑地址到物理地址的映射。

#### 文件分配方式

##### 连续分配

连续分配方式要求每个文件在磁盘上占有一组连续的块。

在这种方式中，文件目中需要记录存放的起始块号、长度 (总共占用几个块)。通过这种方式，用户给出要访问的逻辑块号，操作系统找到该文件对应的目录项 (FCB)，于是可以计算：物理块号=起始块号+逻辑块号。当逻辑块号大于长度时，不合法。

优点：
1. 由于可以直接算出逻辑块号对应的物理块号，因此连续分配支持顺序访问和直接访问 (随机访问)。
2. 且连续分配的文件在顺序读写时速度最快。

缺点：
1. 物理上采用连续分配的文件不方便拓展。
2. 物理上采用连续分配，存储空间利用率低，会产生难以利用的磁盘碎片。可以用紧凑来处理碎片，但是需要耗费很大的时间代价。

##### 链接分配

链接分配采用离散分配的方式，可以为文件分配离散的磁盘块，分为隐式链接和显式链接两种。
- 隐式链接：目录中记录了文件存放的起始块号和结束块号。对于 i 号逻辑块，隐式链接通过顺序读取 1 到 i-1 块从而找到低 i 号逻辑块。
	- 优点：很方便文件拓展。不会有碎片文件，外存利用率高。
	- 缺点：采用链式分配 (隐式链接) 方式的文件只支持顺序访问，不支持随机访问，查找效率低。此外，指向下一个盘块的指针页需要耗费少量的存储空间。
- 显示链接：把用于链接文件各物理块的指针显示地存放一张表中，即文件分配表 (FAT)，记录每一个物理块的下一个物理块号。目中只需要记录文件的起始块号。
	- 一个磁盘仅设置一个 FAT，开机时读入内存，并常驻内存。FAT 的各个表项在物理上连续存储，并且长度相同，因此物理块号是隐含的。
	- 支持顺序访问、随机访问 (FAT 常驻内存，因此不需要一个个磁盘块读取)。
	- 优点：方便文件拓展，不会产生外部碎片。
	- 缺点：文件分配表需要占用一定的存储空间。

##### 索引分配

索引分配允许文件离散地分配在各个磁盘块中，系统会为每个文件建立一张索引表，索引表中记录了文件的各个逻辑块对应的物理块 (类似 [[内存管理#页表]])。索引表存放的磁盘块称为索引块，文件数据存放的磁盘块称为数据块。目录中需要记录文件的索引块是几号磁盘块。
- 可以使用固定长度表示物理块号，因此索引表中的逻辑块号可以是隐含的。
- 优点：支持随机访问、文件拓展也很容易实现。
- 缺点：索引表占用一定的存储空间。

> 如果一个文件的索引项在一个磁盘块中装不下？
> 1. 链接方案：将多个索引块链接起来存放。对于大文件。缺点：若文件很大，索引表很长，就需要将很多的索引块链接起来。查找效率低下。
> 2. 多级索引：建立多层索引。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层。缺点：即使是小文件，访问一个数据块也需要多次读磁盘。
> 3. **混合索引**：多种索引分配方式的结合。即一个文件的顶级索引表中，即包含了直接地址索引，又包含一级间接索引，还包含二级间接索引。优点：对于小文件来说，访问一个数据块所需的读磁盘的次数更少。

## 文件存储空间管理

### 存储空间的划分和初始化

存储空间的划分指将物理磁盘划分为一个个文件卷。存储空间的初始化将各个文件卷划分为了目录区和文件区。
- 目录区：存放文件目录信息 (FCB)，用于磁盘存储空间管理的信息。
- 文件区：用于存放文件数据。

### 管理方法

#### 空闲表法

适用于连续分配方式。

使用空闲表记录每个空闲盘块的起始号与空闲盘块的数量。与 [[内存管理#动态分区分配]] 类似，为一个文件分配连续的存储空间。采用 [[内存管理#动态分区分配算法]]，即首次适应、最佳适应、最坏适应等算法来决定要为文件分配哪个区间。

回收方式同 [[内存管理#动态分区分配]]，分为四种情况：
1. 回收区前后都没有相邻空闲区
2. 回收区前后都是空闲区
3. 回收区前是空闲区
4. 回收区后是空闲区

#### 空闲链表法

##### 空闲盘块链

适用于离散分配的物理结构。

以盘块为单位组成一条空闲链。操作系统保链头、链尾指针。
- 分配：若文件申请 K 个盘块，则从链头开始一次摘下 K 个盘块分配，并修改空闲链的链头指针。
- 回收：回收的盘块依次挂到链尾，并修改空闲链的链尾指针。

##### 空闲盘区链

适用于连续分配和离散分配两种物理结构。为一个文件分配多个盘块时效率更高。

空闲盘区链：以盘区为单位组成一条空闲链。盘区指连续的空闲盘块组成的一个区域。操作系统保存链头、链尾指针。
- 分配：若某文件申请 K 个盘块，则可以采用首次使用、最佳适应等算法，从链头开始检索，按照算法规则找到一个大小符合要求的空闲盘区分配。若没有合适的连续空闲块，也可以将不同盘区的盘块分配给同一个文件。
- 回收：若回收区和某个空闲盘区相邻，则需要将回收区合并到空闲盘区中。若回收区没有和任何空闲区相邻，将回收区作为单独的一个空闲盘区挂到链尾。

#### 位示图法

适用于连续分配和离散分配两种物理结构。

位示图：每一个二进制对应一个盘块。例如，用 0 表示盘块空闲，用 1 表示盘块已分配。位示图一般使用连续的字表示，字中的每一位对应一个盘块，因此可以使用 (字号，位号) 对应一个盘块号。
- 分配：若文件需要 K 个块，首先，顺序扫描位示图，找到 K 个相邻或者不相邻的 0。然后根据字号、位号算出对应的盘块号，将相应盘块分配给文件。最后将相应位设置为 1。
- 回收：首先，根据回收的盘块号计算出对应的字号、位号。然后，将相应二进制为设置为 0。

#### 成组链接法

空闲表法和空闲链表法不适用于大型文件系统，因为空闲表或者空闲链表可能过大。

成组链接法：文件卷的目录区中专门用一个磁盘块作为超级块，当系统启动时需要将超级块读入内存，并且要保证内存与外存中超级块数据一致。在超级块中，保存了下一组的空闲盘块数、每个空闲块号，并且第一个空闲块号指向的空闲块中保存了下一组的超级块的信息。
- 分配：检查第一个分组块数是够足够，如果够，则分配第一个分组中的空闲块。当分配满时，将下一组中的信息分配到超级块中，接着分配。
- 回收：如果分组块没有满，则将回收的空闲块插入分组中。如果分组块满了，则将超级块中的内容复制到新的回收块中，并使用超级块重新记录性回收的块。

## 文件的基本操作

- 创建文件：调用操作系统 Create 系统调用，需要提供所需的外存空间大小、文件存放路径、文件名。操作系统主要做了：
	- 在外存中找到文件所需的空间
	- 根据文件存放路径信息找到该目录对应的目录文件，在目录中创建该文件对应的目录项。
- 删除文件：调用操作系统 Delete 系统调用，需要提供文件存放路径，文件名。操作系统主要做了：
	- 根据文件存放路径找到相应的目录文件，从目录中找到文件名对应的目录项
	- 根据该目录项记录的文件在外存的存放位置、文件大小等信息，回收文件占用的磁盘块。
	- 从目录表中删除目录项。
- 打开文件：使用 open 系统调用打开文件，提供文件存放路径、文件名、对文件的操作类型。操作系统在处理 open 系统调用时，主要做了：
	- 根据文件存放路径找到相应的目录文件，从目录中找到文件名对应的目录项，并检查该用户是否有指定的操作权限。
	- 将目录项复制到内存中的打开文件表中，并将对应表目的编号返回给用户。之后用户使用打开文件表的编号来指明要操作的文件。
	> 打开文件表包括系统打开文件表 (记录了所有的打开文件) 与进程的打开文件表 (记录了该进程打开的文件)。
- 关闭文件：调用 Close 系统调用关闭打开的文件，主要做了：
	- 将进程的打开文件表相应项删除。
	- 回收分配给该文件的内存空间等资源。
	- 系统打开文件表的打开计数器 count 减 1，若 count=0，则删除对应表项。
- 读文件：调用 read 系统调用，将文件数据从外存读入内存，并显示在屏幕上。需要指明文件 (打开文件表中的序号，也称为**文件描述符**) 、读入多少数据、读入的数据放在内存中的什么位置。
- 写文件：调用 write 系统调用，将文件数据从外存写回内存。需要指明文件 (打开文件表中的序号，也称为**文件描述符**)、写回多少数据、写回外存的数据放在内存中的什么位置。

## 文件共享

### 基于索引节点的共享方式 (硬链接)

使用 [[#索引节点]] 的共享方式，由于检索文件时只需要用到文件名，因此可以将除了文件名之外的其他信息放到索引节点中。这样目录项就只需要包含文件名、索引节点指针。

在索引节点中设置一个链接计数变量 count 用于链接到本索引节点上的用户目录项数。若某个用户决定删除这个文件，则只需要将 count 值减 1。只有 count=0 时，才会真正删除文件。

### 基于符号链接的共享方式 (软链接)

软链接创建了一个新的 link 型的文件，类似于快捷方式。该文件会根据其中记录的路径，层层查找目录，最终找到索引节点。

对于软链接，删除原来的文件会导致软链接失效。软链接访问速度慢于硬链接。

## 文件保护

### 口令保护

为一个文件设置一个口令，用户请求访问时必须提供口令。

- 优点：保存口令的空间开销不多，验证口令的时间开销也很小。
- 缺点：正确的口令存放在系统内部，不够安全。

### 加密保护

使用某个密码对文件进行加密，在访问文件时需要提供正确的密码才能对文件进行正确的解密。

- 优点：保密性强，不需要在操作系统中存储密码。
- 缺点：编码、译码需要花费一定的时间。

### 访问控制

在每个文件的 FCB 中增加一个访问控制列表 (ACL)，该表中记录了各个用户可以对该文件执行哪些操作。

精简的访问列表：以组为单位，标记各组用户可以对文件执行哪些操作。当某些用户想要访问文件时，系统会检查该用户所属的分组是否有相应的访问权限。

优点：实现灵活，可以实现复杂的文件包含功能。