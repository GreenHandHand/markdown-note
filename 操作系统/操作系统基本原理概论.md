---
aliases:
  - operator system
  - os
tags:
  - 操作系统
  - 概述
---

# 操作系统基本原理概论

计算机系统自上而下可以大致分为 4 部分；硬件、操作系统、应用程序和用户。操作系统管理各种硬件，为应用程序提供基础，并且充当计算机硬件与用户之间的中介。

**操作系统**(Operating System, OS) 是指控制和管理整个计算机系统的硬件和软件资源，合理地组织、调度计算机的工作和资源的分配，进而为用于和其他软件提供方便接口与环境的程序集合。操作系统是计算机系统中最基本的系统软件。

## 操作系统的特征

操作系统是一种系统软件，但是与其他的系统软件和应用软件有很大的不同，具有自己的特殊性。操作系统的基本特征包括**并发、共享、虚拟和异步**。

> [!example] 操作系统的功能
> 为了给多道程序提供良好的运行环境，操作系统应该具有以下功能：处理机管理、存储器管理、设备管理和文件管理。同时，为了方便用户使用操作系统，还必须向用户提供接口。具体的，操作系统应该具有如下能力
> 1. 管理系统资源：
> 	- 处理机管理：即对进程进行管理，包括进程控制、进程同步、进程通信、死锁处理、处理机调度等。
> 	- 存储器管理：为了给多道程序的运行提供良好的环境，方便用户使用及提高内存的利用率，包括内存的回收与分配、地址映射、内存保护和共享、内存扩充等。
> 	- 文件管理：计算机中的信息都是以文件的形式存在的，操作系统负责文件管理的部分称为文件系统，包括文件存储空间的管理、目录管理、文件读写管理和保护等。
> 	- 设备管理：完成用户的 IO 请求，方便用户使用各种设备，提高设备的利用率，包括缓冲管理、设备分配、设备处理和虚拟设备等。
> 2. 作为用户与计算机硬件系统之间的接口：
> 	- 命令接口：用户利用这些操作系统命令来组织和控制作业的执行。主要方式有联机控制方式和脱机控制方式，按照作业控制方式的不同还可以将命令分为联机命令接口和脱机命令接口。
> 	- 程序接口：编程人员可以使用程序接口来请求操作系统服务。
> 3. 实现对计算机资源的扩充：
> 	- 没有任何软件支持的计算机称为裸机，它仅是构成计算机系统的物质基础，而实际呈现在用户面前的计算机系统是经过若干层软件改造的计算机。我们通常将覆盖软件的机器称为扩充机器或者虚拟机。

> [!note] 操作系统提供的接口
> - 联机命令接口，又称为交互式命令接口，适合用于分时或者实时系统的接口，由一组键盘操作命令组成。我们常见的终端就是一个使用联机命令接口的软件。
> - 脱机命令接口，又称为批处理命令接口，适合用于批处理系统，它由一组作业控制命令组成，脱机用户不能直接干预作业的运行，而是事先用相应的作业控制命令写成一份作业控制命令序列。我们常见的就是 bash 脚本。

### 并发

> [!definition|Definition] 并发
> 两个或者多个事件在同一时间间隔内发生。这些事件在*宏观上是同时发生的*，但是在*微观上是交替发生的*。

> [!note] 与并发相近的概念还有**并行**，是并行是指两个或者多个事件在同一时刻同时发生。

操作系统的并发性指计算机系统中同时运行着多个程序，这些程序在宏观上是同时运行着的，而微观上看是交替运行的。实现操作系统并发性的一个重要的方式是通过 [[进程管理]]。

> [!example] 从并行与并发的定义可以看出
> 1. 对于单核 cpu，同一时刻只能执行一个程序，多个程序只能并发的执行。
> 2. 对于多核的 cpu，同一时刻可以同时执行多个程序，即多个程序可以并行的执行。每个程序在不同的核心上同时执行。

### 共享

> [!definition|Definition] 共享
即资源共享，是指系统中的资源可供内存中多个并发执行的进程共同使用。

资源共享可以分为互斥共享和同时共享两种方式：
- 互斥共享方式：系统中的某些资源，虽然可以提供给多个进程使用，但是一个时间段内只允许一个进程访问该资源。
- 同时共享方式：系统中的某些资源，允许同一时间段内由多个进程同时对它们进行访问。

> [!note] 临界资源
> 我们将同一段时间只允许一个进程访问的资源称为**临界资源**。计算机系统中大多数的物理设备及某些软件使用的栈、变量和表格都属于临界资源。

> [!warning] 微观上的区别
> - 互斥共享要求一种资源在一段时间内 (哪怕是很短的一段时间) 只能满足一个请求，*例如打印机在开始打印一个文档后，直到这次打印完成都不能满足其他的请求*。
> - 同时共享方式允许多个进程并发的进行访问，而在微观上仍然是交替的访问资源。*例如，一个资源可以分为多个时间片间隔的进行访问，其效果与连续完成的效果相同*。

> [!note] 共享性和并发性
> 并发和共享是操作系统最基本的两个特征，两者之间互为存在的条件。
> 1. 资源共享是以程序的并发为条件的。
> 2. 若系统不能对资源进行有效的管理，则难以执行并发。

### 虚拟

> [!definition|Definition] 虚拟
把一个物理上的实体变为若干个逻辑上的对应物。物理实体（前者）是实际存在的，而逻辑上对应物（后者）是用户感受到的。

用于实现虚拟的技术称为**虚拟技术**，操作系统中的虚拟技术主要有两种：
- 时分复用技术：如虚拟处理器，通过多道程序设计技术，让多道程序并发执行，来分时使用一个处理器。
- 空分复用技术：如虚拟存储器，将一台机器的物理存储器变为虚拟存储器，以便从逻辑上扩充存储器的容量。

> [!seealso] 虚拟设备技术
> 虚拟设备技术将一台物理 IO 设备虚拟为多台逻辑上的 IO 设备，并允许每个用户占用一台逻辑上的 IO 设备，使原来仅允许在一段时间内由一个用户访问的设备变为在一段时间内允许多个用户同时访问的共享设备。

### 异步

> [!definition|Definition] 异步
在多道程序环境下，运行多个程序并发执行，但是由于资源有限，进程的执行不是一贯到底的，而是走走停停，以不可预知的速度向前推进，这就是进程的异步性。

由于并发运行的程序会争抢着使用系统资源，而系统中的资源有限，因此进程的执行不是一贯到底的，可能由于其他的进程被阻塞。

> [!note] 异步与并发的关系
> 进程以不可预知的速度向前推进。何时执行、何时暂停、何时完成都是未知的，这就造成了系统的异步性。同样，异步建立在并发的基础上的。

## 操作系统的发展

### 手工操作阶段

程序员通过在纸带上打孔的方式编写程序，计算机通过读取纸带的方式运行程序，并将输出结果也打印到纸带上得到运行的结果。*这个阶段没有形成操作系统*。

> [!note] 手工操作阶段的特点
> 1. 用户独占全机，资源利用率极低。
> 2. CPU 等待手工操作，CPU 利用不充分。

### 批处理系统

为了解决人机矛盾以及 CPU 和 IO 设备之间速度不匹配的问题，出现了处理系统。

#### 单道批处理系统

为了实现对作业的连续处理，需要先将一批作业以脱机的方式输入磁带，并在系统中配上*监督程序*(Monitor)，在监督程序的控制下，这批作业可以一个接一个的处理。

> [!note] 单道批处理系统的特点
> 1. 自动性：在顺利的情况下，磁带上的一批作业能够自动地逐个运行。
> 2. 顺序性：磁带上的各道作业顺序进入内存，先调入内存的作业先完成。
> 3. 单道性：内存中仅有一道程序运行，当程序完成或者发生异常时，才换入其后继程序进入内存运行。

相比于手工操作阶段，单道批处理系统缓解了一定程度的人机速度矛盾，资源利用率有所提升。但是内存中仅能有一道程序运行，只有该程序运行结束后才能调用下一道程序，CPU 有大量的时间是在等待 IO 完成，资源利用率仍然很低。

#### 多道批处理系统

用户提交的作业都先存放在外存上排成一个队列，作业调度程序按一定的算法从后备队列中选择若干作业调入内存，它们在管理程序的控制下相互穿插地运行，共享系统重的各种资源。

> [!tip] 
> 在多道批处理系统中，某个程序由于请求 IO 操作而暂停运行时，CPU 便立即转去处理另一道程序。具体的实现方式可以参考[[操作系统/进程管理#进程控制|进程管理]]。这种方式让系统的各个组成部分都尽可能的忙，因为切换任务所花费的时间很少，因此可以实现系统各个部件之间的并行工作。

> [!note] 多道批处理系统的特点
> 1. 多道：计算机内存中同时存放多道相互独立的程序。
> 2. 宏观上并行：同时进入系统的多道程序都处理运行过程中，但是都未运行完毕。
> 3. 微观上串行：内存中的多道程序轮流占用 CPU，交替执行。

> [!note] 多道批处理系统的优缺点
> 

### 分式操作系统

在分时操作系统中，计算机以时间片为单位轮流为各个用户、作业服务，各个用户可以通过终端与计算机交互。

用户的请求可以被即使响应，解决了人机交互的问题，运行多个用户同时使用一台计算机，并且用户对计算机的操作独立，感受不到其他人的存在。

分式操作系统的设计导致了不能优先处理一些紧急任务，操作系统对每个用户、作业都是完全公平的，循环地为每个用户、作业服务一个时间片，不区分任务的紧急性。
### 实时操作系统

在一些特定的情景下，需要优先响应一些紧急任务，因此提出了实时操作系统。实时操作系统能够优先响应一些紧急任务，某些紧急任务不需要时间片排队。

在实时操作系统的控制下，计算机系统接受到外部信号后及时进行处理，并且要在严格的时限内处理完事件，实时操作系统的主要特点是及时性和可靠性。

实时操作系统有分为两种：
1. 硬实时操作系统：必须在绝对严格的规定时间内完成
2. 软实时操作系统：能接受偶尔违反时间

### 其他操作系统

现在还发展出来网络操作系统、分布式操作系统，用于针对不同的情景。

## 操作系统的运行机制

### 内核程序与应用程序

操作系统的程序分为内核程序和应用程序。
- 其中应用程序就是我们平时所见到的软件程序。
- 内核程序是用于实现操作系统的控制功能的程序，很多的内核程序组成了**操作系统内核**，简称为**内核**。内核是操作系统中最核心的部分，也是最接近硬件的部分，甚至可以说，一个操作系统只需要有内核就可以了。

操作系统的内核作为管理者，有时可以让 CPU 执行一些特权指令，例如内存清零指令。这些指令影响重大，只允许操作系统的内核来使用。

### 内核态与用户态

CPU 有两种状态：
- 内核态：处于内核态，说明此时正在运行的是内核程序，此时可以执行特权指令。
- 用户态：处于用户态时，说明此时正在运行的是应用程序，此时只能执行非特权指令。

在 CPU 中，有一个寄存器叫做程序状态字寄存器（PSW），其中有一个二进制位，1 表示内核态，0 表示用户态。用户态也称为目态，内核态也称为核心态或者管态。

内核态与用户态的切换过程一般如下：
- 在内核态切换为用户态时，执行一条特权指令，并修改 PSW 的标志位为用户态，这个动作意味着操作系统将主动让出 CPU 使用权。
- 用户态切换为内核态一般由中断信号触发，硬件自动完成变态过程，触发终端信号意味着操作系统将强行夺回 CPU 的使用权。

### 操作系统的中断

在合适的情况下，操作系统内核会将 CPU 的使用权主动让给应用程序。中断时让操作系统内核夺回 CPU 使用权的唯一途径。中断会使 CPU 由用户态变为内核态，是操作系统重新夺回对 CPU 的控制权。

> 如果没有中断机制，那么一旦应用程序在 CPU 上运行，CPU 就会一直运行这个应用程序

中断分为内中断与外中断：
- 内中断（异常、例外）：若当前执行的指令是非法的，则会引发一个中断信号。或者应用程序执行了陷入指令。

> 应用程序执行陷入指令，意味主动将 CPU 的控制权还给了操作系统内核，系统调用就是通过陷入指令完成的。

- 外中断（中断）：与当前执行的指令无关，中断信号来源于 CPU 外部。例如时钟中断、IO 设备发来的中断信号。

一般我们说的中断指的是狭义的中断，而将内中断称为异常。

### 系统调用

应用程序通过系统调用请求操作系统的服务。系统中的各种共享资源都由操作系统内核统一掌管，因此**凡是与共享资源有关的操作，都必须通过系统调用的方式向操作系统内核提出服务请求**，由操作系统代为完成。这样可以保证系统的稳定性和完整性，防止用户非法操作。

将系统调用按照功能分类，可以分为：
1. 设备管理：完成设备的 请求/释放/启动 等功能。
2. [[操作系统/文件管理|文件管理]]：完成文件的 读/写/创建/删除 等功能。
3. 进程控制：完成进程的 创建/撤销/阻塞/唤醒 等功能。
4. 进程通信：完成进程之间的 消息传递/信号传递 等功能。
5. [[操作系统/内存管理|内存管理]]：完成内存的 分配/回收 等功能。

系统调用的过程：
1. 当应用程序需要进行系统调用时，需要先执行传参指令，将相关的参数存入寄存器中，接着执行陷入指令，该陷入指令的执行引发了一个内中断，然后cpu就会暂停执行应用程序，转入相应的中断处理程序，即系统调用的入口程序。
2. 系统调用的入口程序显然是需要在内核态进行的程序。该程序将会检查寄存器中的参数，其中第一个参数指明系统调用的类型，还可以由更多的参数用于其他功能。
3. 入口程序选择对应的系统调用执行，其他参数将作为这个系统调用程序的参数输入。
4. 系统调用执行完毕后，cpu转为用户态，交给应用程序计算。

需要注意，陷入指令是在用户态下执行，执行陷入指令后将会引发一个内中断，是cpu进入核心态。发出系统调用请求是在用户态中，而对系统调用的相应处理是在核心态中。

> 陷入指令也可称为trap指令或者访管指令。
