---
tags:
  - 计算机图形学
aliases:
  - transformation
---

# Transformation

在图形学中，常见的几种基本变换包括：**平移**、**旋转** 和 **缩放**。

>[!note] 仿射变换（Affine Transformation）
>平移、旋转、缩放等操作统称为**仿射变换**。仿射变换是一类保持直线、保持平行关系、保持比例的变换，但**不保留角度和长度**。它们在图形学中的重要性体现在能够用统一的矩阵框架进行组合与处理，此外还包括**错切（Shear）**等操作。

三维空间中的图像需要经过三个关键步骤的变换，才能最终呈现在摄像机视角中。
- **模型变换**（*Model transformation*）是将物体从其局部坐标系转换到世界坐标系的过程。
	- 在这个阶段，我们可以通过平移、旋转或缩放等操作调整物体的位置、方向和大小，使其适应整个场景的布局。
	- 例子：在照相的过程中，我们需要调整自己的位置与姿势。
- **视图变换**（*View transformation*）是将世界坐标系下的所有物体重新映射到摄像机坐标系中。简单来说，就是把整个场景“搬到”摄像机的观察视角下。
- **投影变换**（*Projection transformation*）模拟真实世界中光线穿过镜头形成图像的过程，将三维信息投射到摄像机的成像平面上。投影变换通常分为两种类型：
	- **正交投影**：适用于工程制图等需要保持比例一致的场合，
	- **透视投影**：贴近人眼的视觉感受，能够产生近大远小的效果。

## 基本变换操作

### 二维缩放与旋转

在图形学中，我们通常使用矩阵对坐标点进行变换。例如，进行二维缩放：

![[image/变换.png]]

设原始点为 $(x, y)$，缩放系数为 $s$，则缩放后的坐标为：
$$
\begin{aligned}
x' &= s \cdot x \\
y' &= s \cdot y
\end{aligned}
$$
我们可以使用矩阵的形式表示这个变换：
$$
\begin{bmatrix}
x' \\
y'
\end{bmatrix} = \begin{bmatrix}
s & 0 \\
0 & s
\end{bmatrix} \begin{bmatrix}
x \\
y
\end{bmatrix}
$$

更加一般的，下面的矩阵称为**缩放矩阵**：
$$
S = \begin{bmatrix}
s_{x} & 0 \\
0 & s_{y}
\end{bmatrix}
$$

类似的，还可以定义**旋转矩阵**：
$$
R(\theta) = \begin{bmatrix}
\cos(\theta) & \sin(\theta) \\
-\sin(\theta) & \cos(\theta)
\end{bmatrix}
$$
上述矩阵将图像逆时针方向旋转 $\theta$。

>[!note]- 错切 (Share) 变换
>将缩放矩阵的零项修改，那么图像就会在对应的轴上发生偏移，称为错切。
>![[image/变换-1.png]]

### 齐次坐标

根据旋转矩阵和平移矩阵，我们可以将二维空间中的任意仿射变换表示为：
$$
\begin{bmatrix} x' \\ y' \end{bmatrix} =
S \cdot R(\theta)\cdot\begin{bmatrix} x \\ y \end{bmatrix} + \begin{bmatrix}
x_{t} \\ y_{t}
\end{bmatrix}
$$
这样引入的额外项导致整个运算不再是线性运算。齐次坐标系通过引入额外的一个维度来统一解决平移的问题。在齐次坐标系中，一个点的坐标可以表示为：
$$
P = \begin{bmatrix}
x & y & 1
\end{bmatrix}^T
$$
这样表示有诸多好处。在这里，我们可以改写旋转矩阵与缩放矩阵：
$$
R(\theta) = \begin{bmatrix}
\cos(\theta) & \sin(\theta) & 0 \\
-\sin(\theta) & \cos(\theta) & 0 \\
0 & 0 & 1
\end{bmatrix}\quad S = \begin{bmatrix}
s_{x} & 0 & 0 \\
0 & s_{y} & 0 \\
0 & 0 & 1
\end{bmatrix}
$$
同时还可以写出**平移矩阵**：
$$
T=\begin{bmatrix}
1 & 0 & x_{t} \\
0 & 1 & y_{t} \\
0 & 0 & 1
\end{bmatrix}
$$

于是，二维空间中的任意仿射变换可以组合表示为矩阵点乘的形式：
$$
P' = T \cdot R(\theta) \cdot S \cdot P
$$

>[!note] 规约（Normalization）
>齐次坐标中，$\begin{bmatrix}x \\ y \\ w\end{bmatrix}$ 和 $\begin{bmatrix}x/w \\ y/w \\ 1\end{bmatrix}$ 表示同一个点，只要 $w \ne 0$。这种不唯一性允许我们对坐标进行归一化。

>[!note] 向量与点的表示
>在齐次坐标中：
> - 点表示为 $\begin{bmatrix}x & y & 1\end{bmatrix}^{T}$
> - 向量表示为 $\begin{bmatrix}x & y & 0\end{bmatrix}^{T}$
>
>区分点和向量的重要性体现在变换语义：
> - 向量 + 向量 = 向量
> - 点 + 向量 = 点
> - 点 - 点 = 向量
> - 点 + 点 = 中点

>[!tip] 旋转矩阵的性质
>旋转矩阵是一个 [[线性代数/向量组#正交矩阵|正交矩阵]]。最常用的一个性质：$A^T=A^{-1}$。

### 推广到三维

在三维空间中，一个点的齐次坐标表示为
$$
P = \begin{bmatrix}
x & y & z & 1
\end{bmatrix}^T
$$
我们可以直接写出相对应的缩放矩阵与平移矩阵：
$$
S=\begin{bmatrix}
s_{x} & 0 & 0 & 0 \\
0 & s_{y} & 0 & 0 \\
0 & 0 & s_{z} & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
\quad
T = \begin{bmatrix}
1 & 0 & 0 & x_{t} \\
0 & 1 & 0 & y_{t} \\
0 & 0 & 1 & z_{t} \\
0 & 0 & 0 & 1
\end{bmatrix}
$$

相对于二维空间，三维的旋转要复杂得多。在三维空间中，我们可以绕任意轴进行旋转，比较容易求出的是绕三个坐标轴旋转时的旋转矩阵：
$$
\begin{align}
R_{x}(\theta)&=\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & \cos(\theta) & \sin(\theta) & 0 \\
0 & -\sin(\theta) & \cos(\theta) & 0 \\
0 & 0 & 0 & 1
\end{bmatrix} \\
R_{y}(\theta)&=\begin{bmatrix}
\cos (\theta) & 0 & \sin(\theta) & 0 \\
0 & 1 & 0 & 0 \\
-\sin(\theta) & 0 & \cos(\theta) & 0 \\
0 & 0 & 0 & 1 \\
\end{bmatrix} \\
R_{z}(\theta)&=\begin{bmatrix}
\cos(\theta) & -\sin(\theta) & 0 & 0 \\
\sin(\theta) & \cos(\theta) & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
\end{align}
$$

上面给出的旋转方向是从对应正半轴看下去的逆时针方向。对于其他形式的旋转，我们可以通过欧拉角来描述：
$$
R_{xyz}(\alpha,\beta,\gamma)=R_{x}(\alpha)R_{y}(\beta)R_{z}(\gamma)
$$

>[!note] 欧拉角与飞行姿态
>欧拉角广泛用于飞行模拟，其中：
> - 横滚 (roll) → 绕 $x$ 轴
> - 俯仰 (pitch) → 绕 $y$ 轴
> - 偏航 (yaw) → 绕 $z$ 轴

>[!tip] 罗德里格斯公式（Rodrigues' Rotation Formula）
>绕单位向量 $\mathbf{n}$ 旋转角度 $\alpha$ 的旋转矩阵：
> $$
> \mathbf{R}(\mathbf{n}, \alpha) =
> \cos\alpha \cdot \mathbf{I} +
> (1 - \cos\alpha)\cdot \mathbf{n} \mathbf{n}^T +
> \sin\alpha \cdot \begin{bmatrix}
> 0 & -n_z & n_y \\
> n_z & 0 & -n_x \\
> -n_y & n_x & 0
> \end{bmatrix}
> $$

## 视图变换

**视图变换**将场景中的物体从世界坐标转换到以相机为中心的**相机坐标系**。在标准图形管线中，相机默认位于原点 $(0,0,0)$，面朝负 $z$ 轴，$y$ 轴为上方向。

设在世界坐标系下的相机位置为 $\vec{e}=\begin{bmatrix}x_{e} & y_{e} & z_{e} & 1\end{bmatrix}^T$，为了确定相机的朝向，还需指定：
- **前向向量（gaze）**：$\hat{g}$，表示相机朝向
- **上方向向量（up）**：$\hat{t}$，决定相机的「头部朝上」方向

视图变换实际上就是求出一个变换矩阵，将世界坐标转换为相机坐标。我们希望得到变换矩阵 $M_{view}$：
$$
\begin{bmatrix}
\mathbf{x} & \mathbf{y} & -\mathbf{z} & \begin{bmatrix}
0 \\ 0 \\ 0 \\ 1
\end{bmatrix}
\end{bmatrix} =
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & -1 & 0 \\
0 & 0 & 0 & 1
\end{bmatrix} = M_{view}\cdot\begin{bmatrix}
(\hat{g} \times \hat{t}) & \hat{t} & \hat{g} & \vec{e}
\end{bmatrix}\tag{1}
$$

我们可以将变换拆成下面几部分：
1. 将 $\vec{e}$ 移动到原点 $O$
2. 将 $\hat{g}$ 旋转到 $-\mathbf{z}$
3. 将 $\hat{t}$ 旋转到 $\mathbf{y}$
4. 将 $\hat{g}\times \hat{t}$ 旋转到 $\mathbf{x}$

平移是简单的，我们可以直接写出平移矩阵：
$$
T_{view}=\begin{bmatrix}
1 & 0 & 0 & -e_{x} \\
0 & 1 & 0 & -e_{y} \\
0 & 0 & 1 & -e_{z} \\
0 & 0 & 0 & 1
\end{bmatrix}
$$

现在可以将前面的式子拆分：
$$
M_{view}=R_{view}T_{view}
$$

旋转比较麻烦，我们无法直接写出未知角度的旋转。但是我们可以求其逆变换，即将三个基向量旋转为 $\hat{g},\hat{t},\hat{g}\times \hat{t}$。将式 $(1)$ 展开：
$$
\begin{align}
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & -1 & 0 \\
0 & 0 & 0 & 1
\end{bmatrix} &= R_{view}T_{view}\cdot\begin{bmatrix}
(\hat{g} \times \hat{t}) & \hat{t} & \hat{g} & \vec{e}
\end{bmatrix} \\
&=R_{view}\begin{bmatrix}
x_{g\times t} & x_{t} & x_{g} & 0 \\
y_{g\times t} & y_{t} & y_{g} & 0 \\
z_{g\times t} & z_{t} & z_{g} & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
\end{align}
$$
于是可以得到：
$$
\begin{align}
R_{view}^{-1}&=
\begin{bmatrix}
x_{g\times t} & x_{t} & x_{g} & 0 \\
y_{g\times t} & y_{t} & y_{g} & 0 \\
z_{g\times t} & z_{t} & z_{g} & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & -1 & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}^{-1} \\
&= \begin{bmatrix}
x_{g\times t} & x_{t} & -x_{g} & 0 \\
y_{g\times t} & y_{t} & -y_{g} & 0 \\
z_{g\times t} & z_{t} & -z_{g} & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
\end{align}
$$
由于 $R_{view}$ 是旋转矩阵，因此 $R_{view}$ 是正交矩阵，根据正交矩阵的性质有：
$$
R_{view}=(R_{view}^{-1})^T=
\begin{bmatrix}
x_{g\times t} & y_{g\times t} & z_{g\times t} & 0 \\
x_{t} & y_{t} & z_{t} & 0 \\
-x_{g} & -y_{g} & -z_{g}  & 0\\
0 & 0 & 0 & 1
\end{bmatrix}
$$

## 投影变换

我们的屏幕是一个二维平面，若想在其上显示三维物体，需要通过**投影**将三维场景转换为二维图像。常见的投影方式有两种：

- **正交投影** (*Orthographic Projection*)：视线彼此平行，相机处于无限远处，物体不随距离变化而缩放，常用于工程制图。
- **透视投影** (*Perspective Projection*)：符合人眼视觉规律，表现“近大远小”，平行线相交于消失点，广泛应用于绘画、摄影和游戏图形渲染等场景。

在经过视图变换（即将世界坐标转换为以摄像机为中心的视图坐标）后，我们可以默认摄像机位于坐标系原点 $(0, 0, 0)$，朝向 $-z$ 轴方向。

---

### 正交投影

正交投影是一种较为简单的投影方式，其思想是在忽略视角收缩的情况下将三维空间直接“压缩”到二维。

为了使其适用于图形管线中的统一处理，正交投影并非简单地去除 $z$ 坐标，而是将定义好的观察立方体（视景体）映射到一个标准的立方体空间 $[-1,1]^3$，称为 *canonical view volume*（标准视景体）。

其步骤如下：

1. 定义观察区域为长方体 $[l, r] \times [b, t] \times [n, f]$
2. 将该立方体中心平移至原点。
3. 对坐标轴分别进行缩放，使其范围变换为 $[-1, 1]^3$。

![[image/变换-2.png]]

对应的投影矩阵 $M_{ortho}$ 为：
$$
M_{ortho} =
\underbrace{
\begin{bmatrix}
\frac{2}{r-l} & 0 & 0 & 0 \\
0 & \frac{2}{t-b} & 0 & 0 \\
0 & 0 & \frac{2}{n-f} & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
}_{\text{缩放矩阵}}
\cdot
\underbrace{
\begin{bmatrix}
1 & 0 & 0 & -\frac{r+l}{2} \\
0 & 1 & 0 & -\frac{t+b}{2} \\
0 & 0 & 1 & -\frac{n+f}{2} \\
0 & 0 & 0 & 1
\end{bmatrix}
}_{\text{平移矩阵}}
\tag{2}
$$

这个组合变换首先将视景体的中心平移到原点，然后缩放成一个边长为 $2$ 的标准立方体。变换完成后仍保留 $z$ 坐标，用于深度测试与遮挡判断。

---

### 透视投影

透视投影相比正交投影更复杂，但其更符合人类视觉感知。在透视投影中，观察区域形状为一个**截头四棱锥**（Frustum），视锥体远离摄像机逐渐扩大。

![[image/变换-3.png]]

透视投影的基本思路是：**将视锥体通过非线性变换转化为一个类似正交投影的立方体空间**，从而使用统一的管线处理方式进行渲染。

这一变换必须满足以下两个条件：

- 变换后的近平面（$z = n$）应保持投影点的空间位置不变。^5c03d5
- 变换后的远平面（$z = f$）应确保深度 $z$ 值正确反映远近顺序。^189719

我们以 $zoy$ 平面为例分析该变换过程。设相机位于原点，朝向 $-z$ 轴方向：

![[image/变换-1.jpeg]]

对于任意一点 $(x, y, z)$，其在近平面（$z = n$）上的投影点 $(x', y')$ 可通过相似三角形关系得到：
$$
y' = \frac{n}{z}y, \quad x' = \frac{n}{z}x
$$

在齐次坐标下表示为：
$$
\begin{bmatrix}
x \\ y \\ z \\ 1
\end{bmatrix}
\longrightarrow
\begin{bmatrix}
nx/z \\ ny/z \\ ? \\ 1
\end{bmatrix}
\equiv
\begin{bmatrix}
nx \\ ny \\ ? \\ z
\end{bmatrix}
$$

于是，我们希望构造一个透视变换矩阵 $M_{persp\to ortho}$，使其满足：
$$
M_{persp\to ortho}
\cdot
\begin{bmatrix}
x \\ y \\ z \\ 1
\end{bmatrix}
=
\begin{bmatrix}
nx \\ ny \\ ? \\ z
\end{bmatrix}
$$

根据上述投影规律与线性关系，我们可以设该矩阵形式为：
$$
M_{persp\to ortho} =
\begin{bmatrix}
n & 0 & 0 & 0 \\
0 & n & 0 & 0 \\
0 & 0 & a & b \\
0 & 0 & 1 & 0
\end{bmatrix}
$$

为了求出参数 $a, b$，我们带入两个特例点进行求解：

1. 对于近平面 $z = n$，要求投影点不变：
$$
\begin{bmatrix}
x \\ y \\ n \\ 1
\end{bmatrix}
\mapsto
\begin{bmatrix}
nx \\ ny \\ an + b \\ n
\end{bmatrix}
\Rightarrow an + b = n^2
$$

2. 对于远平面 $z = f$，则有 $af + b = f^2$

联立可得：
$$
\begin{cases}
an + b = n^2 \\
af + b = f^2
\end{cases}
\Rightarrow
\begin{cases}
a = n + f \\
b = -nf
\end{cases}
$$

因此，
$$
M_{persp\to ortho} =
\begin{bmatrix}
n & 0 & 0 & 0 \\
0 & n & 0 & 0 \\
0 & 0 & n+f & -nf \\
0 & 0 & 1 & 0
\end{bmatrix}
$$

最后，将其与正交投影矩阵 $M_{ortho}$ 相乘，得到透视投影矩阵：
$$
M_{persp} = M_{ortho} \cdot M_{persp\to ortho}
$$

---

>[!note] 相机内参与投影视锥构造
>在实际应用中，我们通常通过相机内参数来间接构造投影视锥区域，而非直接指定视景体边界。
>
> - **fov**（Field of View）：摄像机视野的开口角，决定了视锥的张角，通常指垂直方向的视场角。*实际上垂直与水平方向的 fov 可以通过宽高比相互转换*。
> - **aspect ratio**：视口宽高比，定义为图像宽度除以高度。
>
>给定 fov、宽高比 $r$，以及近平面/远平面距离 $n, f$，我们可计算近平面的宽高如下：
> $$
> h = 2n \cdot \tan\left(\frac{\mathrm{fov}}{2}\right), \quad w = h \cdot r
> $$
>对应视景体范围为：
> $$
> [ -w/2, w/2 ] \times [ -h/2, h/2 ] \times [ n, f ]
> $$
>
>进一步带入这些值，即可构造最终的正交投影矩阵。下面直接给出化简结果：
> $$
> \begin{bmatrix}
> \frac{\text{ratio}}{\tan (\text{fov}/2) }  & 0 & 0 & 0 \\
> 0 & \frac{1}{\tan(\text{fov}/2)} & 0 & 0 \\
> 0 & 0 & -\frac{z_{\text{far}} + z_{\text{near}}}{z_{\text{far}}-z_{\text{near}}} & \frac{2z_{\text{far}}z_{\text{near}}}{z_{\text{far}}-z_{\text{near}}} \\
> 0 & 0 & 1 & 0
> \end{bmatrix}
> $$

---

| [[计算机图形学/光栅化|光栅化]] >
