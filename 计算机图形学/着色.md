---
tags:
  - 计算机图形学
---

# 着色

 着色 (*Shading*) 在计算机图形学中表示为片元添加纹理与材质 (*materials*) 的过程。

>[!note]
>shading 与 shadow 不同，shading 虽然会为物体添加上明暗细节，但是不会添加阴影。具体来说，shading 不会考虑不同物体之间的相互作用，只会考虑物体与光源的相互作用。

## Blinn-Phong 反射模型

Blinn-Phong 反射模型 (Blinn-Phong Reflectance Model) 是一个效果不错的经验模型。在该模型中，我们将光线抽象为以下五大要素：
1. 着色点 (Shading point)：对于每一个平面，我们将其抽象为一系列 Shading point 的集合。
2. 观察方向 (View direction)：观察者所在的方向，使用方向向量 $\vec{v}$ 表示。
3. 法线方向 (Surface normal)：平面的法线方向，使用方向向量 $\vec{n}$ 表示。
4. 光照方向 (Light direction)：光照方向，使用方向向量 $\vec{l}$ 表示。
5. 表面参数 (Surface parameter)：照射平面的各种参数，例如颜色、粗糙程度等。

>[!example]-
>![[image/着色.png]]

通过观察现实世界中的光照，我们可以简单的认为一个物体的光照由下面三种光照组成：
- 漫反射 (*Diffuse reflection*)
- 镜面反射、高光 (*Specular highlight*)
- 环境光 (*Ambient lighting*)

### 漫反射

从一个简单的例子开始，对于一个粗糙的物体，我们从任何角度观察都不会改变这个物体的颜色。但是对于物体的不同位置，颜色的明暗程度却有所区别。

产生上述现象的原因，是因为对于一个现实中的物体，它的表面总是凹凸不平的。因此光照射到该物体表面时，在任意的方向上都会有反射的光。但是由于物体表面相对于光源的角度不同，导致接收到的光照面积不同，因此造成了明暗区别。

因此，我们将其进行简单的抽象，认为一个光照射到 Shading Point 上时，在任意方向上都会产生一个漫反射光照。而接收的光照数量，我们使用光照强度来表示。

>[!info] 光照强度
>光照强度是物理学中用于描述光照强弱和物体表面积被照射程度的量。光照强度的定义是单位面积上所接收的光通量的大小，简称为照度。照度的大小取决于光源的发光强度，以及被照体与光源之间的距离，呈现平方反比的规律。
> $$
> I_{r} = k\dfrac{I}{r^{2}}
> $$

>[!note] 朗伯余弦定理
>朗伯余弦定理 (Lambert’s cosine law) 定量描述了角度与光照强度的关系。
>
>![[image/着色-1.png]]
>
> 1. 当垂直照射时，平面会接收到照度 $I$ 的光照。
> 2. 当入射角度为 60° 时，平面会接收到照度 $0.5I$ 的光照。
> 3. 一般而言，当入射角度为 $\theta$ 时，每单位面积接收到的照度 $I$ 满足关系：$I\cos \theta=\vec{I}\cdot \vec{n}$

根据朗伯余弦定理，我们可以得到下面的经验公式：
$$
L_{d}=k_{d}(I/r^{2})\max(0, \mathbf{n}\cdot \mathbf{l})
$$
其中：
- $k_{d}$ 表示漫反射系数。对于灰度图，使用标量，越大的漫反射系数越明亮。对于彩色图像，通常使用一个三维向量，表示 RGB 三种颜色的漫反射系数，通过不同的组合可以使得物体呈现出不同的颜色。
- $I/r^{2}$ 表示光照强度，其中 $I$ 是光源发出的光照强度，$r$ 是 Shading Point 与光源的距离。对于多个光源，求和即可。
- $\vec{n}\cdot \vec{l}$ 就是余弦角度，其中 $\vec{n}$ 时法线向量，$\vec{l}$ 是入射方向向量，当余弦角度为正的时候，根据朗伯余弦定理，光照强度与夹角的余弦成正比。当余弦角度为负时，我们认为此时物体背朝光源，因此没有光线照射到物体上，不存在漫反射。
- 从上述公式可以看出，漫反射与观察方向无关，只有数值大小。

### 镜面反射

也从一个例子开始：当我们看向光滑的物体时，根据我们观察的角度不同，物体上会出现一个非常亮的小点，这就是镜面反射导致的高光。

我们在中学时学习过镜面反射相关的知识，当光线照射到镜面上时，会沿着相同的角度反射，即「入射角等于出射角」。高光的形成原因就是在这一片区域上的光线通过镜面反射后，正好反射到了观察者的方向。由于镜面反射对于光照强度的损耗较小，因此出现了一个局部亮度远高于其他区域的高光。

因此，在 Blinn-Phong 反射模型中，我们认为，当观察方向距离镜面反射的出射光越近时，我们观察到的高光越明显。我们使用余弦相似度来进行衡量。

![[image/着色-4.png]]

但是，直接计算出射方向向量 $\vec{R}$ 是非常麻烦的，因此在 Blinn-Phong 反射模型中，我们不计算出射向量与观察向量的余弦，而是计算半程向量 (half vector) 与法线向量的余弦。它们在几何上的角度是相同的，但是半程向量的计算要简单得多。

![[image/着色-3.png]]

我们使用下面的公式计算半程向量 (这是一个方向向量，模长为 1)：
$$
\mathbf{h} = \frac{\mathbf{l} + \mathbf{v}}{\lVert \mathbf{l}+\mathbf{v} \rVert }
$$
在计算出半程向量后，我们使用下面的公式计算高光：
$$
\begin{aligned}
L_{s} &= k_{s}(I/r^{2})\max(0, \cos \alpha)^{p} \\
&= k_{s}(I/r^{2})\max(0, \mathbf{n}\cdot \mathbf{h})^{p}
\end{aligned}
$$
其中：
- $k_{s}$ 表示镜面反射系数，一般要远高于漫反射系数。
- $\vec{n}\cdot \vec{h}$ 表示半程向量与法线向量的余弦相似度。

>[!note] $p$ 的含义
>通过增大指数 $p$，可以让反射的高光在边缘处衰减得更快，高光区域更小。
>![[image/着色-5.png]]
>
>通过调整 $k_{s}$ 和 $p$，我们可以得到不同材质需要的高光效果：
>![[image/着色-6.png]]

### 环境光

除了之前使用的漫反射和镜面反射以外，还有很多没有考虑到的因素，但是这些光照一般强度都比较弱，因此在 Blinn-Phong 反射模型中，我们将其概括为环境光，并使用一个常数表示。在任何情况下，物体表面都存在微小的环境光照射：
$$
L_{a}=k_{a}I_{a}
$$
其中 $k_{a}$ 是物体的环境光反射系数，$I_{a}$ 是环境光强度。

---

Blinn-Phong 反射模型就是上述三种光照的求和：
$$
\begin{aligned}
L&=L_{d}+L_{s}+L_{a} \\
&=k_{d}(I/r^{2})\max(0, \mathbf{n\cdot l}) + k_{s}(I/r^{2})\max(0, \mathbf{n\cdot h}) + k_{a}I_{a}
\end{aligned}
$$

## 着色频率

着色公式可以计算出空间中每一个点对应显示的颜色。但是根据现实中的计算成本考虑，我们会选择不同的方式计算着色。
- 对每一个三角形着色 (Flat shading, Face)：认为一个三角形的颜色唯一，对每一个三角形进行一次着色。
- 对每一个顶点着色 (Gouraud shading, Vertex)：计算出每一个顶点的法线向量，对每一个顶点进行着色，并使用插值的方式计算每一个三角形的颜色。
- 对每一个像素点进行着色 (Phong shading, Pixel)：使用插值的方式计算出每一个像素点对应位置的法线向量，然后为每一个像素点进行单独着色。

三种着色方式所需要的计算量不同，对于不同面数的几何体的着色效果也不尽相同。面数越多的几何体，三种着色方式的效果越接近。

![[image/着色-8.png]]

>[!note] 计算顶点的法线向量
>使用顶点进行着色时，我们需要使用顶点的法线向量。对于顶点的交汇处，我们通常采用插值的方式计算，简单来说就是将相邻的所有法线向量求均值：
> $$
> N_{v} = \frac{\sum_{i}N_{i}}{\left\lVert  \sum_{i}N_{i}  \right\rVert }
> $$

>[!note] 计算每一个像素的法线向量
> 通常采用重心坐标插值方法 (Barycentric interpolation)。

## 渲染管线

在渲染的每一个过程中，我们都有明确的输入与输出，因此在实践中，我们将其抽象为了一系列的渲染管线。一个渲染管线是从空间坐标开始，将其一步一步转换为显示器上的像素点的过程。

一般而言，一个图像渲染管线包括：
1. 顶点处理 (Vertex Processing)：模型变换，[[计算机图形学/变换#视图变换|视图变换]]，[[计算机图形学/变换#投影变换|投影变换]]。
2. 三角形处理 (Triangle Processing)：将模型转换为三角形图元。
3. [[计算机图形学/光栅化|光栅化]] (Rasterization)：采样三角形。
4. 片元处理 (Fragment Processing)：处理光栅化计算得到的「像素点」，包含 [[计算机图形学/光栅化#深度缓冲|深度测试]]、着色和材质映射 (Texture mapping)。
5. 显示帧处理 (Framebuffer Operations)：显示之前的一些处理。


> [!info] 着色器 Shader
> 在顶点处理与片元处理阶段，我们通常使用着色器 (*Shader*) 进行描述。着色器是一种强大的工具，它通过并行化的方式描述顶点与片元的处理过程，