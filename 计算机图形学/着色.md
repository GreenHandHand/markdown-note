---
tags:
  - 计算机图形学
---

# 深入理解着色：从基础模型到渲染管线

在计算机图形学领域，**着色 (Shading)** 是赋予三维模型生动色彩与质感的关键技术。它不仅仅是简单地填充颜色，而是模拟光线与物体表面复杂的物理作用，从而为虚拟世界中的物体带来明暗、高光和纹理等视觉细节。

> [\!note] 着色与阴影
> **着色 (Shading)** 与 **阴影 (Shadow)** 是两个相关但本质不同的概念。着色主要处理的是光源与物体表面自身之间的相互作用，决定了物体表面的亮度和颜色分布。而阴影则描述了不同物体之间或物体自身遮挡光线所产生的效果。一个没有阴影的场景，其物体表面依旧可以通过着色来呈现丰富的明暗变化。

## Blinn-Phong 反射模型：一种经验性光照模型

**Blinn-Phong 反射模型 (Blinn-Phong Reflectance Model)** 是一种在实时渲染中广泛应用的、高效且效果出众的**局部光照模型**。它并非基于严谨的物理定律，而是通过一个简洁的经验公式，将物体表面的光照效果分解为三个相互独立的组成部分：漫反射、镜面反射和环境光。

该模型的核心思想是抽象出影响着色的几个关键要素，并通过它们之间的几何关系来计算最终的颜色：

1.  **着色点 (Shading Point):** 物体表面上进行着色计算的特定点。在实践中，这通常是三角形的顶点或像素的中心。
2.  **法线方向 (Surface Normal):** 垂直于物体表面指向外部的单位向量 $\\vec{n}$，它决定了光线与表面的入射角度。
3.  **光照方向 (Light Direction):** 从着色点指向光源的单位向量 $\\vec{l}$。
4.  **观察方向 (View Direction):** 从着色点指向观察者的单位向量 $\\vec{v}$。
5.  **表面参数 (Surface Parameters):** 描述物体材质属性的各种参数，如颜色、粗糙度、反射率等。

> [\!example]- Blinn-Phong 模型中的几何关系
> 上图直观地展示了 Blinn-Phong 模型中所涉及的几个关键向量及其相互关系。

### 漫反射 (Diffuse Reflection)

**漫反射**是光照模型中最基础的组成部分。它模拟了光线照射在**粗糙**物体表面时，向各个方向均匀反射的现象。因此，从任何角度观察一个纯粹的漫反射物体（如一张粗糙的纸），其颜色都不会发生改变，但不同位置的亮度会有所差异。

这种亮度差异的根源在于：当光源与物体表面法线之间的夹角发生变化时，单位面积上接收到的光通量也会改变。当光线垂直照射时，单位面积接收到的能量最多；而当光线几乎与表面平行时，单位面积接收到的能量则趋近于零。

> [\!info] 朗伯余弦定理 (Lambert's Cosine Law)
> 朗伯余弦定理定量地描述了光照角度与光照强度之间的关系。该定律指出，物体表面接收到的辐照度（单位面积上的光通量）与光源方向 $\\vec{l}$ 和表面法线 $\\vec{n}$ 之间夹角的余弦值成正比。
>

> 我们可以通过向量点积 $\\mathbf{n} \\cdot \\mathbf{l}$ 来高效地计算这个余弦值。当夹角为钝角时（即 $\\mathbf{n} \\cdot \\mathbf{l} \< 0$），意味着着色点背对着光源，因此不接收任何光照。

结合光源强度会随距离衰减的**平方反比定律**，我们可以得出漫反射光的经验性公式：

$$L_{d}=k_{d} \left( \frac{I}{r^{2}} \right) \max(0, \mathbf{n}\cdot \mathbf{l})$$

其中：

  * $L\_{d}$ 表示漫反射的最终光照强度。
  * $k\_{d}$ 是**漫反射系数**，它代表了物体表面对漫反射光的吸收和反射能力。对于彩色物体，通常使用一个三维向量 $(R, G, B)$ 来表示，其分量值在 $[0, 1]$ 之间。
  * $I/r^{2}$ 描述了光源在距离 $r$ 处的**光照强度衰减**。$I$ 是光源的初始强度。
  * $\\max(0, \\mathbf{n} \\cdot \\mathbf{l})$ 确保了只有当光线照射在表面正面时，才产生漫反射。

值得注意的是，**漫反射的光照强度与观察方向无关**，无论观察者从哪个角度看，着色点上的漫反射光照亮度都是相同的。

### 镜面反射 (Specular Highlight)

**镜面反射**，也称**高光反射**，是光照在**光滑**物体表面所产生的现象。就像中学物理所学，当光线照射到镜面时，会遵循“入射角等于反射角”的定律，沿着特定方向反射。

高光的形成正是源于此：当观察者的视线方向恰好与光线的镜面反射方向非常接近时，大量集中反射的光线进入人眼，便会在物体表面形成一个局部亮度极高的亮点。

在 Blinn-Phong 模型中，我们并不直接计算反射向量 $\\vec{R}$ 与观察向量 $\\vec{v}$ 的夹角，而是引入一个更为巧妙且计算高效的**半程向量 (half-vector)** $\\mathbf{h}$。

> [\!info] 半程向量
> 半程向量 $\\mathbf{h}$ 是光照方向 $\\mathbf{l}$ 与观察方向 $\\mathbf{v}$ 的单位化向量和：
> $$
> \\mathbf{h} = \\frac{\\mathbf{l} + \\mathbf{v}}{\\lVert \\mathbf{l}+\\mathbf{v} \\rVert }
> $$
>

> 从几何角度可以证明，当半程向量 $\\mathbf{h}$ 与表面法线 $\\mathbf{n}$ 对齐时，光线的镜面反射方向恰好与观察方向重合。因此，我们可以使用 $\\mathbf{n}$ 和 $\\mathbf{h}$ 之间的点积来衡量高光的强度。

镜面反射光的计算公式如下：

$$
\begin{aligned}
L_{s} &= k_{s}(I/r^{2})\max(0, \cos \alpha)^{p} \\
&= k_{s}(I/r^{2})\max(0, \mathbf{n}\cdot \mathbf{h})^{p}
\end{aligned}
$$其中：

* $L\_{s}$ 表示镜面反射的最终光照强度。
* $k\_{s}$ 是**镜面反射系数**，它决定了高光的颜色和强度。
* $\\max(0, \\mathbf{n} \\cdot \\mathbf{h})$ 表示法线与半程向量的余弦值，反映了光线对齐的程度。
* **指数 $p$** 是 Blinn-Phong 模型中一个非常重要的参数，也被称为**高光指数 (shininess)** 或**高光系数 (specular exponent)**。它控制着高光区域的大小与衰减速度。$p$ 值越大，高光区域越小、越集中，模拟了更光滑的材质；$p$ 值越小，高光区域越大、越分散，模拟了更粗糙的材质。

> [\!note] 调整高光效果
> 通过调整 $k\_s$ 和 $p$ 这两个参数，我们可以灵活地模拟出不同材质表面的高光效果，从金属般锐利的光斑到塑料般柔和的高光。
> ![image/着色-6.png](image/着色-6.png)

### 环境光 (Ambient Lighting)

在真实世界中，光线经过多次反射和散射，会形成一种无处不在的微弱光照，即使是背光区域也能被微弱地照亮。Blinn-Phong 模型将这种复杂的全局光照简化为一个**环境光 (Ambient Lighting)** 常量。

环境光的计算非常简单，它与光源方向、观察方向和表面法线都无关，仅仅取决于环境光的强度和物体自身的对环境光的反射系数：

$$L_{a}=k_{a}I_{a}$$

其中 $k\_{a}$ 是物体的**环境光反射系数**，$I\_{a}$ 是**环境光强度**。

### Blinn-Phong 模型的最终公式

将以上三种光照分量叠加，我们就得到了完整的 Blinn-Phong 反射模型公式：

$$\\begin{aligned}
L&=L\_{d}+L\_{s}+L\_{a} \\
&=k\_{d}(I/r^{2})\\max(0, \\mathbf{n}\\cdot \\mathbf{l}) + k\_{s}(I/r^{2})\\max(0, \\mathbf{n}\\cdot \\mathbf{h})^{p} + k\_{a}I\_{a}
\\end{aligned}
$$\#\# 着色频率：性能与效果的权衡

虽然着色公式可以计算出空间中任意一点的颜色，但出于性能考虑，我们并不会对模型表面的每一个点都进行独立的着色计算。根据计算着色点的粒度不同，我们通常将着色过程分为以下几种频率：

  * **对每个面着色 (Flat Shading):** 假设每个三角形的颜色是唯一的。通常选取三角形的中心点作为着色点，计算一次颜色后，将整个三角形填充为该颜色。这种方法计算量最小，但效果最差，会产生明显的分面感。
  * **对每个顶点着色 (Gouraud Shading):** 对每个顶点独立进行着色计算。首先，需要为每个顶点定义一个法线向量（通常是其相邻面法线的平均值）。然后，在光栅化过程中，利用重心坐标插值方法对顶点的颜色进行插值，得到三角形内部每个像素的颜色。这种方法效果优于平面着色，但由于颜色是线性插值的，高光区域会显得失真。
  * **对每个像素着色 (Phong Shading):** 这是效果最好的方法。在光栅化阶段，我们首先对每个顶点的法线向量进行插值，得到每个像素点对应的法线向量。然后，在每个像素点上独立运行着色公式进行着色。这种方法能产生最真实的光照效果，特别是对于高光区域的平滑过渡，但计算量也是最大的。

> [\!info] 着色频率对渲染效果的影响
> 几何体网格的复杂度会影响着色频率的效果。对于面数较多的光滑几何体，这三种着色方式的效果会越来越接近。
>

> [\!note] 法线向量的插值
> 在 Gouraud 和 Phong 着色中，法线向量的计算至关重要。对于顶点法线，我们通常将共享该顶点的所有三角形的法线向量进行加权平均。对于像素法线，我们则使用重心坐标插值来获得其插值后的法线向量。

## 渲染管线与可编程着色器

在计算机图形学实践中，一个三维场景从原始几何数据到最终屏幕像素的过程被组织为一系列离散的步骤，这便是**渲染管线 (Rendering Pipeline)**。它是一种高度并行化的数据处理流程。

一个典型的渲染管线通常包括以下阶段：

1.  **顶点处理 (Vertex Processing):** 对三维模型中的每个顶点执行变换操作，如模型变换、视图变换和投影变换，将顶点从模型空间转换到裁剪空间。
2.  **图元组装 (Primitive Assembly):** 将独立的顶点组合成几何图元（如点、线、三角形）。
3.  **几何处理 (Geometry Processing):** 可选阶段，用于生成新的几何体。
4.  **光栅化 (Rasterization):** 将几何图元投影到屏幕二维平面，并对其进行采样，生成一系列**片元 (Fragments)**。每个片元都对应一个可能成为最终像素的点。
5.  **片元处理 (Fragment Processing):** 对每个片元执行各种计算，如**深度测试**、**着色**和**纹理映射**等，以确定其最终颜色。
6.  **帧缓冲操作 (Framebuffer Operations):** 将片元的颜色写入帧缓冲区，并进行最终的混合、抖动等处理，最终显示在屏幕上。

> [\!info] 可编程着色器 (Shaders)
> 在渲染管线的顶点处理和片元处理阶段，我们通常使用**可编程着色器 (Shader)** 来描述其处理逻辑。着色器是一种在 GPU 上运行的微型程序，因其高度的并行性而能高效地对成千上万个顶点或片元进行独立处理。常见的着色器语言包括 OpenGL 的 GLSL 和 DirectX 的 HLSL。

## 纹理：为模型赋予细节

**纹理 (Texture)** 是一种依附在模型表面的二维图像，它为模型提供了丰富的细节和外观。在渲染过程中，我们通过将 2D 纹理的像素（即 **texels**）映射到 3D 模型表面的特定位置，从而在渲染时为模型赋予颜色、法线、粗糙度等属性。

纹理映射通常使用一个独立的二维坐标系 $(u, v)$ 来描述。在建模时，我们为模型的每个顶点指定一个对应的纹理坐标 $(u, v)$，渲染时便可以据此在纹理上查找对应的参数。

### 重心坐标插值 (Barycentric Coordinates)

要将纹理正确地应用到三角形的内部，我们必须解决一个关键问题：如何确定光栅化后得到的每个像素点在纹理上的对应位置？**重心坐标插值 (Barycentric Interpolation)** 便是解决这一问题的强大工具。

对于三角形 $\\triangle ABC$ 内部的任意一点 $P$，我们可以将其表示为三个顶点的加权平均，其权重和为 1：

$$
P = \alpha A + \beta B + \gamma C \\
\text{其中} \quad \alpha + \beta + \gamma = 1
$$这里的 $(\\alpha, \\beta, \\gamma)$ 就是点 $P$ 的重心坐标。它们不仅描述了 $P$ 在三角形中的相对位置，也为我们提供了一种通用的插值方法。

> [\!note] 重心坐标的几何意义
> 重心坐标本质上是基于面积的比值来定义的。对于三角形内部的点 $P$，其重心坐标可以通过 $P$ 与三角形顶点 $A,B,C$ 构成的三个子三角形面积比来计算。
> $$
> \\alpha = \\frac{\\text{Area}(\\triangle PBC)}{\\text{Area}(\\triangle ABC)} \\quad \\beta = \\frac{\\text{Area}(\\triangle PCA)}{\\text{Area}(\\triangle ABC)} \\quad \\gamma = \\frac{\\text{Area}(\\triangle PAB)}{\\text{Area}(\\triangle ABC)}
> $$
>
> ![image/着色-9.png|重心坐标的几何意义](image/着色-9.png)

在渲染管线中，我们通常已知三角形的三个顶点坐标和像素点坐标。通过求解线性方程组，可以高效地计算出该像素点的重心坐标。一旦得到 $(\\alpha, \\beta, \\gamma)$，我们就可以对任何顶点属性（如颜色、法线、纹理坐标、深度值等）进行插值：

$$V_{P} = \alpha V_{A} + \beta V_{B} + \gamma V_{C}$$

> [\!warning] 投影后的深度插值
> 重心坐标插值在**屏幕空间**中是非线性的。因此，直接使用屏幕空间的重心坐标插值深度值会产生不准确的结果，尤其是在处理近大远小的透视投影时。为了实现正确的深度插值，必须使用**透视修正 (perspective-correct)** 的插值方法。

### 纹理放大 (Texture Magnification)

当纹理的分辨率小于屏幕上被它覆盖的像素数量时，就会发生**纹理放大 (Texture Magnification)**。此时，一个纹素 (texel) 可能需要被映射到多个像素上。为了避免出现块状的像素化效果，我们需要对纹理进行**重采样**。常见的重采样算法包括：

1.  **最近邻插值 (Nearest Neighbor):** 对于每个像素点，直接使用与其纹理坐标最接近的那个纹素的颜色。这是一种最简单的算法，但会导致明显的锯齿和块状感。
2.  **双线性插值 (Bilinear Interpolation):** 对于每个像素点，取其纹理坐标周围最近的 4 个纹素，并进行**线性插值**来计算最终颜色。效果平滑，计算成本适中。
3.  **三立方插值 (Bicubic Interpolation):** 效果更好，但计算量更大，它使用周围 16 个纹素进行更复杂的插值。

> [\!note] 双线性插值详解
> 双线性插值本质上是在两个维度上连续执行三次线性插值 (lerp)。
>
> 假设我们需要在二维坐标系中插值点 $(s, t)$ 的值，我们可以先在 $u$ 方向上对两行进行线性插值，得到两个中间值 $u\_0$ 和 $u\_1$，最后再在 $v$ 方向上对这两个中间值进行线性插值，得到最终结果。
>
> $$
> \\begin{aligned}
> \\text{lerp}(x, v\_0, v\_1) &= v\_0 + x(v\_1 - v\_0) \\
> u\_0 &= \\text{lerp}(s, u\_{00}, u\_{01}) \\
> u\_1 &= \\text{lerp}(s, u\_{10}, u\_{11}) \\
> f(s, t) &= \\text{lerp}(t, u\_0, u\_1)
> \\end{aligned}
> $$
>
> ![image/着色-10.png|双线性插值示意图](image/着色-10.png)

-----
$$

# 着色

 着色 (*Shading*) 在计算机图形学中表示为片元添加纹理与材质 (*materials*) 的过程。

>[!note]
>shading 与 shadow 不同，shading 虽然会为物体添加上明暗细节，但是不会添加阴影。具体来说，shading 不会考虑不同物体之间的相互作用，只会考虑物体与光源的相互作用。

## Blinn-Phong 反射模型

Blinn-Phong 反射模型 (Blinn-Phong Reflectance Model) 是一个效果不错的经验模型。在该模型中，我们将光线抽象为以下五大要素：
1. 着色点 (Shading point)：对于每一个平面，我们将其抽象为一系列 Shading point 的集合。
2. 观察方向 (View direction)：观察者所在的方向，使用方向向量 $\vec{v}$ 表示。
3. 法线方向 (Surface normal)：平面的法线方向，使用方向向量 $\vec{n}$ 表示。
4. 光照方向 (Light direction)：光照方向，使用方向向量 $\vec{l}$ 表示。
5. 表面参数 (Surface parameter)：照射平面的各种参数，例如颜色、粗糙程度等。

>[!example]-
>![[image/着色.png]]

通过观察现实世界中的光照，我们可以简单的认为一个物体的光照由下面三种光照组成：
- 漫反射 (*Diffuse reflection*)
- 镜面反射、高光 (*Specular highlight*)
- 环境光 (*Ambient lighting*)

### 漫反射

从一个简单的例子开始，对于一个粗糙的物体，我们从任何角度观察都不会改变这个物体的颜色。但是对于物体的不同位置，颜色的明暗程度却有所区别。

产生上述现象的原因，是因为对于一个现实中的物体，它的表面总是凹凸不平的。因此光照射到该物体表面时，在任意的方向上都会有反射的光。但是由于物体表面相对于光源的角度不同，导致接收到的光照面积不同，因此造成了明暗区别。

因此，我们将其进行简单的抽象，认为一个光照射到 Shading Point 上时，在任意方向上都会产生一个漫反射光照。而接收的光照数量，我们使用光照强度来表示。

>[!info] 光照强度
>光照强度是物理学中用于描述光照强弱和物体表面积被照射程度的量。光照强度的定义是单位面积上所接收的光通量的大小，简称为照度。照度的大小取决于光源的发光强度，以及被照体与光源之间的距离，呈现平方反比的规律。
> $$
> I_{r} = k\dfrac{I}{r^{2}}
> $$

>[!note] 朗伯余弦定理
>朗伯余弦定理 (Lambert’s cosine law) 定量描述了角度与光照强度的关系。
>
>![[image/着色-1.png]]
>
> 1. 当垂直照射时，平面会接收到照度 $I$ 的光照。
> 2. 当入射角度为 60° 时，平面会接收到照度 $0.5I$ 的光照。
> 3. 一般而言，当入射角度为 $\theta$ 时，每单位面积接收到的照度 $I$ 满足关系：$I\cos \theta=\vec{I}\cdot \vec{n}$

根据朗伯余弦定理，我们可以得到下面的经验公式：
$$
L_{d}=k_{d}(I/r^{2})\max(0, \mathbf{n}\cdot \mathbf{l})
$$
其中：
- $k_{d}$ 表示漫反射系数。对于灰度图，使用标量，越大的漫反射系数越明亮。对于彩色图像，通常使用一个三维向量，表示 RGB 三种颜色的漫反射系数，通过不同的组合可以使得物体呈现出不同的颜色。
- $I/r^{2}$ 表示光照强度，其中 $I$ 是光源发出的光照强度，$r$ 是 Shading Point 与光源的距离。对于多个光源，求和即可。
- $\vec{n}\cdot \vec{l}$ 就是余弦角度，其中 $\vec{n}$ 时法线向量，$\vec{l}$ 是入射方向向量，当余弦角度为正的时候，根据朗伯余弦定理，光照强度与夹角的余弦成正比。当余弦角度为负时，我们认为此时物体背朝光源，因此没有光线照射到物体上，不存在漫反射。
- 从上述公式可以看出，漫反射与观察方向无关，只有数值大小。

### 镜面反射

也从一个例子开始：当我们看向光滑的物体时，根据我们观察的角度不同，物体上会出现一个非常亮的小点，这就是镜面反射导致的高光。

我们在中学时学习过镜面反射相关的知识，当光线照射到镜面上时，会沿着相同的角度反射，即「入射角等于出射角」。高光的形成原因就是在这一片区域上的光线通过镜面反射后，正好反射到了观察者的方向。由于镜面反射对于光照强度的损耗较小，因此出现了一个局部亮度远高于其他区域的高光。

因此，在 Blinn-Phong 反射模型中，我们认为，当观察方向距离镜面反射的出射光越近时，我们观察到的高光越明显。我们使用余弦相似度来进行衡量。

![[image/着色-4.png]]

但是，直接计算出射方向向量 $\vec{R}$ 是非常麻烦的，因此在 Blinn-Phong 反射模型中，我们不计算出射向量与观察向量的余弦，而是计算半程向量 (half vector) 与法线向量的余弦。它们在几何上的角度是相同的，但是半程向量的计算要简单得多。

![[image/着色-3.png]]

我们使用下面的公式计算半程向量 (这是一个方向向量，模长为 1)：
$$
\mathbf{h} = \frac{\mathbf{l} + \mathbf{v}}{\lVert \mathbf{l}+\mathbf{v} \rVert }
$$
在计算出半程向量后，我们使用下面的公式计算高光：
$$
\begin{aligned}
L_{s} &= k_{s}(I/r^{2})\max(0, \cos \alpha)^{p} \\
&= k_{s}(I/r^{2})\max(0, \mathbf{n}\cdot \mathbf{h})^{p}
\end{aligned}
$$
其中：
- $k_{s}$ 表示镜面反射系数，一般要远高于漫反射系数。
- $\vec{n}\cdot \vec{h}$ 表示半程向量与法线向量的余弦相似度。

>[!note] $p$ 的含义
>通过增大指数 $p$，可以让反射的高光在边缘处衰减得更快，高光区域更小。
>
>![[image/着色-5.png]]
>
>通过调整 $k_{s}$ 和 $p$，我们可以得到不同材质需要的高光效果：
>
>![[image/着色-6.png]]

### 环境光

除了之前使用的漫反射和镜面反射以外，还有很多没有考虑到的因素，但是这些光照一般强度都比较弱，因此在 Blinn-Phong 反射模型中，我们将其概括为环境光，并使用一个常数表示。在任何情况下，物体表面都存在微小的环境光照射：
$$
L_{a}=k_{a}I_{a}
$$
其中 $k_{a}$ 是物体的环境光反射系数，$I_{a}$ 是环境光强度。

---

Blinn-Phong 反射模型就是上述三种光照的求和：
$$
\begin{aligned}
L&=L_{d}+L_{s}+L_{a} \\
&=k_{d}(I/r^{2})\max(0, \mathbf{n\cdot l}) + k_{s}(I/r^{2})\max(0, \mathbf{n\cdot h}) + k_{a}I_{a}
\end{aligned}
$$

## 着色频率

着色公式可以计算出空间中每一个点对应显示的颜色。但是根据现实中的计算成本考虑，我们会选择不同的方式计算着色。
- 对每一个三角形着色 (Flat shading, Face)：认为一个三角形的颜色唯一，对每一个三角形进行一次着色。
- 对每一个顶点着色 (Gouraud shading, Vertex)：计算出每一个顶点的法线向量，对每一个顶点进行着色，并使用插值的方式计算每一个三角形的颜色。
- 对每一个像素点进行着色 (Phong shading, Pixel)：使用插值的方式计算出每一个像素点对应位置的法线向量，然后为每一个像素点进行单独着色。

三种着色方式所需要的计算量不同，对于不同面数的几何体的着色效果也不尽相同。面数越多的几何体，三种着色方式的效果越接近。

![[image/着色-8.png|三种着色频率与几何体面数对着色结果的影响]]

>[!note] 计算顶点的法线向量
>使用顶点进行着色时，我们需要使用顶点的法线向量。对于顶点的交汇处，我们通常采用插值的方式计算，简单来说就是将相邻的所有法线向量求均值：
> $$
> N_{v} = \frac{\sum_{i}N_{i}}{\left\lVert  \sum_{i}N_{i}  \right\rVert }
> $$

>[!note] 计算每一个像素的法线向量
> 通常采用重心坐标插值方法 (Barycentric interpolation)。

## 渲染管线

在渲染的每一个过程中，我们都有明确的输入与输出，因此在实践中，我们将其抽象为了一系列的渲染管线。一个渲染管线是从空间坐标开始，将其一步一步转换为显示器上的像素点的过程。

一般而言，一个图像渲染管线包括：
1. 顶点处理 (Vertex Processing)：模型变换，[[计算机图形学/变换#视图变换|视图变换]]，[[计算机图形学/变换#投影变换|投影变换]]。
2. 三角形处理 (Triangle Processing)：将模型转换为三角形图元。
3. [[计算机图形学/光栅化|光栅化]] (Rasterization)：采样三角形。
4. 片元处理 (Fragment Processing)：处理光栅化计算得到的「像素点」，包含 [[计算机图形学/光栅化#深度缓冲|深度测试]]、着色和材质映射 (Texture mapping)。
5. 显示帧处理 (Framebuffer Operations)：显示之前的一些处理。

> [!info] 着色器 Shader
> 在顶点处理与片元处理阶段，我们通常使用着色器 (*Shader*) 进行描述。着色器是一种强大的工具，它通过并行化的方式描述顶点与片元的处理过程，一种常见的 Shader 语言是 GLSL。

## 纹理

纹理 (Texture) 是一种附着在模型表面的图像，在渲染时表现出不同的颜色。通过将 2D 的纹理映射到 3D 的模型的顶点上，从而将对应的区域显示到对应的三角形上。

纹理通常使用 `(u,v)` 坐标系。当我们要将一个纹理映射到模型的表面时，会将模型的每一个顶点对应到纹理坐标上的一个坐标位置，从而在渲染时快速查找对应的渲染参数。

### 重心坐标插值

要将纹理映射到三角形上，我们首先需要计算出三角形中的每一个点对应纹理中的哪一个位置。为了节约内存，我们通常只记录三角形的三个顶点，如果要使用三角形的内部点，我们需要进行插值。

重心坐标插值 (Barycentric Coordinates) 是一种广泛应用的三角形插值方式。根据三角形的性质，我们可以使用下面的公式表示三角形内部的任何点：
$$
\begin{aligned}
(x, y) = &\alpha A + \beta B + \gamma C \\
&\alpha + \beta + \gamma = 1
\end{aligned}
$$
其中，$\alpha,\beta,\gamma>0$。对于三角形 ▲ABC 内部的任意一个点 $(x, y)$，我们可以利用三角形的重心坐标系 $(\alpha, \beta, \gamma)$ 表示。

> [!note] 重心坐标的几何意义
> 三角形的重心坐标可以利用面积的比值计算：
> $$
> \begin{aligned}
> \alpha &= \dfrac{A_{A}}{A_{A} + A_{B} + A_{C}} \\ 
> \beta &= \dfrac{A_{B}}{A_{A} + A_{B} + A_{C}} \\ 
> \gamma &= \dfrac{A_{C}}{A_{A} + A_{B} + A_{C}} \\ 
> \end{aligned}
> $$
>
> ![[image/着色-9.png|重心坐标的几何意义]]

在计算机图形学中，我们通常已知三角形的三个顶点和其内部的点。要计算出对应的 $\alpha,\beta,\gamma$ 参数，可以利用下面的公式：
$$
\begin{aligned}
\alpha &= \dfrac{-(x-x_{B})(y_{C}-y_{B})+(y-y_{B})(x_{C}-x_{B})}{-(x_{A}-x_{B})(y_{C}-y_{B})+(y_{A}-y_{B})(x_{C}-x_{B})} \\
\beta &= \dfrac{-(x-x_{C})(y_{A}-y_{C})+(y-y_{C})(x_{A}-x_{C})}{-(x_{B}-x_{C})(y_{A}-y_{C})+(y_{B}-y_{C})(x_{A}-x_{C})} \\
\gamma &= 1 - \alpha - \beta
\end{aligned}
$$

对于三个顶点的任意属性 $(V_{A}, V_{B}, V_{C})$，我们可以利用重心坐标计算出对应点的值：
$$
V=\alpha V_{A} + \beta V_{B} + \gamma V_{C}
$$
这里的 $V$ 可以是任何值，包括纹理、位置、颜色、坐标、属性等。

> [!warning]
> 重心坐标在经过投影操作后会发生变形，因此不能直接用于插值计算深度。在深度测试中，我们通常需要使用修正的重心坐标插值公式。

> [!example] 应用纹理
> 要将纹理应用在光栅化得到的片元上，我们可以通过下面的方式：
> 1. 计算每一个像素坐标 $(x, y)$ 对应的纹理坐标 $(u, v)$
> 2. 使用重心坐标插值采样得到对应的颜色
> 3. 根据颜色设置对应的片元参数 (例如 Blinn-Phong 反射模型中的 $k_{d}$)

### 材质放大

当材质较小，无法覆盖整个模型表面空间时，我们需要将其*放大*。这实际上就是将材质图像先还原到原始空间，再对其进行重新采样。常用的方法有三种：
1. 最近邻 (Nearest)：对于每一个采样点，使用材质中最接近的点。
2. 双线性插值 (Bilinear)：对于每一个采样点，使用材质中最接近的 4 个点的双线性插值。
3. 三立方插值 (Bicubic)：对于每一个采样点，使用材质中最接近的 16 个点的三立方插值。

> [!note] 双线性插值
> 双线性插值在计算机图像处理中广泛应用于放大图像。对于一个图像坐标系中的一个点 $(x, y)$，我们选择其周围的 4 个点 $u_{01}, u_{11}, u_{00}, u_{10}$，进行如下操作：
> 1. 在水平方向上进行两次插值。
> 2. 利用水平方向的插值结果，在竖直方向上插值得到结果。
> 
> 我们通常定义如下操作为一维线性插值：
> $$
> \text{lerp}(x,v_{0},v_{1}) = v_{0} + x(v_{1} - v_{0})
> $$
>
> 而双线性插值实际上就是进行了三次插值：
> $$
> \begin{aligned}
> u_{0} &= \text{lerp}(s, u_{00}, u_{01}) \\
> u_{1} &= \text{lerp}(s, u_{01}, u_{11}) \\
> f(x, y) &= \text{lerp}(t, u_{0}, u_{1})
> \end{aligned}
> $$
>
> ![[image/着色-10.png|双线性插值示意图]]

## 材质缩小

当材质过大，我们需要对其采样之后再进行渲染。此时，又会引出一个经典的走样问题。
