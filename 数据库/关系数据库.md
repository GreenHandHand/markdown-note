---
tags:
  - 数据库
---

# 关系数据库

关系模型的构成：

* 数据模型通常由数据结构、数据操作、完整性约束构成。
* 对应关系模型就是关系数据结构，关系操作集合，关系完整性约束
* 静态数据结构、动态数据操作、完整性约束是学习本章的目标

## 一、关系模型的基本概念

关系理论是以集合代数理论为基础的，一次，我们可以用集合代数给出二维表的“关系”定义。

### 1. 域

> 域是一组具有相同数据类型的值的集合

#### 笛卡尔积

> 给定一组集合$D_1,D_2,\cdots,D_n$，则他们的笛卡尔积为$\{(d_1,d_2 \cdots, d_n)|d_i \in D_i, i=1,2,\cdots, n\}$，笛卡尔积中的元素不能重复。

#### 元组

> 笛卡尔积中每个元素叫做一个n元元组，简称元组

#### 分量

> 笛卡尔积元素$(d_1,d_2,\dots,d_n)$的每一个值叫做一个分量。

### 2. 关系

> 关系是笛卡尔积的子集，$D_1 \times D_2 \times \dots \times D_n$的任意一个子集称为$D_1,D_2,\dots,D_n$上的一个关系

* 关系中的每一行对应一个元组，通常用t表示
* 每一列对应一个域。$t[A_i]$表示元组t在属性$A_i$上的值
* 当n=1时，称该关系为一元关系；当n=2时，称该关系为二元关系
* 在数据库中，我们规定：
  * 无限关系在数据库中无意义，因此限定关系代数数据模型中的关系必须是有限集合
  * 通过为关系的每列增加一个属性名的方法取消元组的有序性。

#### 规范化的关系的性质

1. 列是同质的
   * 每一列的分量是统一类型的数据，来自同一个域
2. 不同的列可出自同一个域
   * 其中的每一列称为一个属性，不同的属性要给予不同的属性名
3. 列的顺序无所谓
   * 列的次序可以任意交换
4. 各个元组是不同的，即关系中不允许出现重复元组
5. 行的顺序无所谓，即行的次序可以任意交换
6. 分量必须取原子值
   * 这是规范条件中最基本的一条

#### 关系模式与关系数据库

* **关系模式**是对关系的描述
  * 关系模式一般简记为关系名和属性名的集合$R(A_1,A_2,\dots,A_n)$或仅用关系名$R$表示，如图书关系模式可以描述为$图书(书号，书名，作者，单价，出版社)$
* 关系的值是元组的集合，称为关系
* 关系模式和关系统称为关系，通过上下文加以区别
* 关系数据库
  * 关系模式的集合称为**关系数据库模式**，是对数据库中所有数据逻辑结构的描述，表示为$R=\{R_1,R_2,\dots,R_p\}$
  * 关系数据库模式中的每个关系模式上的关系的集合称为关系数据库，表示为$d=\{r_1,r_2,\dots,r_p\}$，其中$r_i$是对应关系模式$R_i$上的一个关系

### 3. 键

为了区分不同元组，用其中一个或者多个属性值标识，能够唯一标识元组的属性或属性组称为关系的**键**

> 设关系模式$R(U),K\subset U$，r是R上的任意一种关系，若对r中任意两个不同的元组t1，t2，满足：
>
> * $t_1[K] \neq t_2[K]$
> * 不存在$K'\subset K$而使得$t_1[K]\neq t_2[K]$
>
> 则称K是R的键。若第二个条件成立，则称K是R的超键。

* 关系中能够起标识作用的键称为**候选键**
  * 在一个关系中，如果有多个候选键，选其中一个键作为**主键**
  * 若关系的键由多个属性组成，称为**联合键**
  * 关系的所有属性构成该关系的键，称为**全键**
* **外建：一个关系中的一般属性或者组成键的部分属性，又同时是另一个关系的键**

### 4. 完整性约束

为了维护数据库中数据与现实世界的一致性，对关系数据库的插入、删除和修改操作必须有一定的约束条件，这就是关系模型的三类完整性

#### 实体完整性约束

实体完整性指主键的值不能为空或者部分为空

> 若属性(指一个或一组属性)A是基本关系R的主属性，则属性A不能去**空值**

如果一个元组的键为空值，或部分为空，则该元组将不可标识，不能表示任何实体，因而无意义

#### 参照完整性约束

参照完整性约束是对关系中作为外键的值的约束。规定：

> 如果关系$R_1$中属性A是另一个关系$R_2$中的主键，则对于关系$R_1$中的任一个元组在属性A上的值或者为空值，或者为另一个关系$R_2$中某个元组的主键的值

> 设F是基本关系R的一个或一组属性，但不是关系R的键(码)。如果F与基本关系S的主键Ks相对应，则称F是基本关系R的外码(外键)
>
> * 基本关系R被称为参照关系，基本关系S称为被参照关系或者目标关系

* 关系R和S不一定是不同的关系
* S的主键Ks和R的外键F必须定义在同一个或组域上
* 外键并不一定要与相应的主键同名

#### 用户定义的完整性

不同的关系数据库系统由于应用环境的不同，往往还需要一些特殊的约束条件，这就是用户定义完整性。

* 用户定义的完整性是针对某一具体关系数据库的约束条件，反映某一具体应用所涉及的数据必须满足的语义要求
* 关系模型应该提供定义和检验这类完整性的机制，以便用统一的、系统的方法处理它们，而不要由应用程序承担这一功能

## 二、关系代数（本章重点）

### 关系代数概述

> 关系代数是一种抽象的查询语言，是以关系为运算对象的一组运算的集合

关系代数运算的三个要素：

* 运算对象：关系
* 运算结果：关系
* 运算符

### 传统的集合运算

> 并、交、差、笛卡尔积

下面以R op S 为例：

* 并(union)：属于R或者S的所有元素
* 交(intersection)：既属于R又属于S的元素
* 差(difference)：属于R但不属于S的元素
* 笛卡尔积：R中所有元组和S中所有元组的拼接

![[image/关系数据库.png]]

### 专门的关系运算

> 这里补充一些常用的记号：
>
> * 设R是关系，t是元组，则:
>   * 设关系模式为$R(A_1,A_2,\cdots,A_n)$，它的一个关系为R
>   * $t\in R$表示t是R的一个元组
>   * $t[A_i]$表示元组t中相对应属性$A_i$的一个分量
> * 若$A=\{A_{i1},A_{i2},\cdots, A_{ik}\}$，其中$A_{i1},A_{i2},\cdots,A_{ik}$是$A_1,A_2,\cdots,A_n$中的一部分，则称A为属性列或域列
>   * $t[A]=(t[A_{i1}],t[A_{i2}],\cdots,t[A_{ik}])$表示元组t在属性列A上诸分量的集合
>   * $\overline{A}$则表示$\{A_1,A_2,\cdots,A_n\}$在去掉$A=\{A_{i1},A_{i2},\cdots, A_{ik}\}$或剩余的属性组
> * $\overset{\frown}{t_rt_s}$称为元组的连接，它是一个n+m列的元组，前n个分量为R中的一个n元组，后m个分量为S中的一个m元组

#### 选择(Selection)

选择运算是关系上的一元运算，是从关系中选择满足一定条件的元组子集：

$$
\sigma_F(R)=\{t|r\in R \wedge t(F)\}
$$

* F是限定条件的布尔表达式
* 上式表示在关系R中选择使t(F)为真的所有元组
* 选择运算是从行的角度进行的运算

#### 投影(Projection)

在模式R上的投影运算表示为：

$$
\Pi_X(R)=\{t[X]\,|\,t\in R\}
$$

* 其中，$\Pi$是投影算符，X是模式R属性的子集，t[X]表示R中元组在属性集X上的值，或为元组t在X上的投影
* 从R中选择出若干属性列组成新的关系
* 投影操作主要从列的角度进行运算（但是投影后会消除重复行）

#### 连接(Join)

连接运算是把两个关系中的元组按条件连接起来，形成一个新关系

* 条件连接
  条件连接也称$\theta$连接，是将两个关系中满足$\theta$条件的元组拼接起来形成新元组的集合。
  * 设属性A和B分别是关系R和S上的属性，且定义在同一个域上，R和S的连接记为：

    $$
    R \underset{{A\,\theta\, B}}{\bowtie}S=\{t|t=\overset{\frown}{t_rt_s},t_r\in R \wedge t_s\in S\wedge t_r[A]\,\theta\, t_s[B]\}
    $$
  * 其中，$\bowtie$是连接符，$A\,\theta\,B$为连接条件。$\theta$是比较符
  * 从R和S的笛卡尔积$R\times S$中选取R关系在A属性组上的值与S关系在B属性组上值满足比较条件的元组
  * 最常用的连接时两个属性值的相等比较

    * $\theta$为“$=$”的连接运算称为等值连接
* 自然连接
  * 自然连接是一种特殊的等值连接，它要求两个关系中进行比较的分量必须是相同的属性组，并且在结果中把重复的属性列去掉。即自然连接会将对应分量相同的元组进行拼接，且只会保留一组相同的分量。
  * $$
    R\bowtie S=\{t|t=\overset{\Large\frown}{t_rt_s[\overline{A}]},t_r\in R\wedge t_s\in S \wedge t_r[A]=t_s[A]\}
    $$
  * 一般的连接操作是从行的角度进行运算
  * 自然连接还需要取消重复列，所以使同时从行和列的角度进行运算。

#### 除运算(Division)

除法运算是一个二元运算，用$\div$表示

* 若$R\div S$，要求R和S有定义在同一域上的属性或属性组
* $R\div S$的结果生成一个新关系R'，R'的属性是R的属性中去掉与具有公共域属性的其他属性

设$R(X,Y),S(Y),R'(X)$。则$R\div S$记为：

$$
R\div S=R'=\{t_r[X]|t_r\in R\wedge t_r[X]\times S\subseteq R\}
$$

* $R\div S$是$\Pi_X(R)$的最大的子集R'，使得$R'\times S$包含在R中
* 除运算可以使用其他关系运算表示：
  * $R\div S=\Pi_X(R)-\Pi_X(\Pi_X(R)\times S - R)$
  * 除操作是同时从行和列的角度进行运算的

象集$Z_x$：给定一个关系$R(X,Z)$，X和Z是属性组。当$t[X]=x$时，x在R中的象集为：

$$
Z_x=\{t[Z]|t\in R, t[X]=x\}
$$

* 它表示R中属性组X上的值为x时对应的其他分量构成的元组的所有值的集合。
* 给定关系$R(X,Y)$和$S(Y,Z)$，其中X，Y，Z为属性组。R中的Y与S中的Y可以有不同的属性名，但必须出自相同的域集。R与S的除运算得到一个新的关系$P(X)$，P是R中满足下列条件的元组在X属性列上的投影：

  $$
  R\div S=\{t_r[X]|t_r\in R \wedge \Pi_Y(S)\subseteq Y_x\}
  $$

  * $Y_x$：x在R中的象集，$x=t_r[X]$
  * 它表示元组在X上分量值x的象集$Y_x$包含S在Y上投影的集合
* 使用象集进行除运算的步骤：

  1. 写出$Y_x$：x在R中的象集
  2. 写出S中与R相同的属性的投影
  3. 若x的象集包含了投影，则结果包含x

### 扩充的关系运算

#### 属性重命名

* 设r是模式R上的一个关系，A是R的一个属性
* B为属性名，B不是R中的属性，B和A具有相同的域
* 则将属性A重命名为B，记为：

$$
\delta_{A\to B}(r)=\{t'|t\in r \wedge t'[R-A]=t[R-A]\wedge t'[B]=t[A]\}
$$

* 通过属性重命名运算，可以
  * 在同一个关系上做自然连接运算
  * 做同一个关系的笛卡尔积
  * 将两个关系的等值连接方便地表示为自然连接

#### 外连接

**外连接(outer join)** 是对自然连接运算的拓展。外连接结果中除了满足连接条件的元组外，包含没有被连接的元组

* 左外连接：
  * 左外连接的连接结果中包含了关系R（左边关系）中不满足连接条件的元组，在这些元组对应关系S属性上的值为空值，记为$R\bowtie_L S$
* 右外连接：
  * 右外连接的连接结果中包含了关系S（右边关系）中不满足连接条件的元组，在这些元组对应关系R属性上的值为空值，记为$R\bowtie_R S$
* 完全外连接：
  * 完全外连接的连接结果中包含了关系R中不满足连接条件的元组，同时也包含了关系S中不满足连接条件的元组。即连接结果是左外连接和右外连接结果的并，记为：$R⋈_FS$。

## 三、元组关系演算

关系代数语言：用对关系的运算来表达查询要求

关系演算语言：用谓词来表达查询要求

按谓词变元的基本对象的不同分为：

* 元组关系演算语言
  * 谓词变元的基本对象是元组变量
* 域关系演算语言
  * 谓词变元的基本对象是域变量

### 元组关系演算语言ALPHA

操作语句 工作空间名(表达式)：操作条件

* 表达式用于指定语句的操作对象，它可以是关系名或属性名，一条语句可以同时操作多个关系或多个属性
* 操作条件是一个逻辑表达式，用于将操作结果限定在满足添加的元组中，操作条件可以为空
* 除此之外，还可以在基本格式的基础上加上排序要求，定额要求等

#### 检索语句GET

例：查询所有被选修的课程号码：GET W (SC.Cno)

#### 更新语句PUT, HOLD, UPDATE, DELETE, DROP

修改操作步骤：

1. 用HOLD语句将要修改的元组从数据库中读到工作空间中
2. 用宿主语言修改工作空间中元组的属性
3. 用UPDATE语句将修改后的元组送回数据库中

插入操作步骤：

1. 用宿主语言在工作空间中建立新元组
2. 用PUT语句把该元组存图指定关系中

删除操作步骤：

1. 用HOLD语句把要删除的元组从数据库中读到工作空间中
2. 用DELETE语句删除该元组

## 四、域关系演算

* 一种典型的与关系演算语言
* QBE：Query By Example
  * 基于屏幕表格的查询语言
  * 查询要求L：以填写表格的方式构造查询
  * 用示例元素（域变量）来表示查询结果可能的情况
  * 查询结果：以表格形式显示

### 检索操作

1. 用户提出要求
2. 屏幕显示空白表格
3. 用户在最左边一栏输入要查询的关系名，例如Student
4. 系统显示该关系的属性名
5. 用户在上面构造查询要求
6. 屏幕显示查询结果
