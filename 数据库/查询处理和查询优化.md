---
tags:
  - 数据库
---

# 查询处理和查询优化

对于同一个[[数据库/SQL|SQL]]查询，通常有多个等价的关系代数表达式，由于存取路径不同，每个关系代数的查询代价和效率也是不同的。

## 关系数据库系统的查询处理

查询过程：![[image/关系处理与查询优化.png|center]]

数据库对查询语句的具体实现可以分为：
* 解释方式
  * 具有灵活、应变性强的特点，但是开销较大，效率较低，主要使用与不重复使用的偶然查询。
* 编译方式
  * 执行效率高、系统开销小。

### 执行查询操作的基本算法

#### 选择操作

##### 顺序扫描法

按照关系中元组的物理顺序扫描每一个元组，检查该元组是否满足选择条件，如果满足则输出。

对于规模大的表进行顺序扫描，当选择律较低时，该算法的效率很低。

##### 二分查找法

如果选择条件涉及相等比较，并且物理文件时按照选择字段有序组织的，可以使用二分查找法来定位符合选择条件的元组。

##### 索引扫描法

如果选择条件的属性上有索引，可以通过索引先找到满足条件的元组指针，然后通过该指针直接在查询的基本表上找到元组。

当选择律较低时，索引扫描法要优于顺序扫描法。但若选择律较高或者要查找的元组均匀的分布在基本表中，此时索引扫描法的性能就不如顺序扫描法。

索引扫描法——复合选择（逻辑合取）：
* 组合索引：如果合取条件中的相等条件包含两个或两个以上的属性，且在组合字段上存在组合索引，可以直接使用该组合索引
* 单独索引：通过索引找到符合与该属性有关的查询条件的元组，再检查其余查询条件是否满足
* 多个索引：分别检索满足单个条件的元组指针集，这些指针集的交集就是满足合取条件的元组指针

索引扫描法——复合选择（逻辑析取）：
* 只要任意一个条件涉及的属性没有索引，就只能使用其他方法

#### 连接操作

连接操作是查询处理中最耗时的操作之一，操作本身开销大，并且可能产生很大的中间结果。

##### 嵌套循环法

* 对外层循环的每一个元组，检索内层循环中的每一个元组
* 检查这两个元组在连接属性上是否相等，如果相等，则拼接或作为结果输出
* 循环执行，直到外层循环表中的元组处理完为止

##### 索引嵌套循环法

在嵌套循环法中，如果两个连接属性中的一个属性上存在索引，可以使用索引扫描替代顺序扫描。

##### 排序合并法

连接的诸表已经排好序，可以使用排序合并法。这个方法所有排序的表都只用扫描一次。

##### 散列连接(Hash Join)法

把连接属性作为hash码，用同一个hash函数把两个表中的元组散列到hash表中。
* 划分阶段/创建阶段：
  * 对包含较少元组的表（如R表）进行一遍处理
  * 把它的元组按hash函数分散到hash表的桶中
* 试探阶段/连接阶段
  * 把另一个表的元组按同一个hash函数散列到适当的hash桶中
  * 把这些S中的元组与桶中所有来自R并与之匹配的元组连接起来。

#### 投影操作

消除重复元组的方法：
* 排序法：先对操作结果进行排序，对于重复的元组，只保留一个，去掉多余的副本。
* 散列法：把投影结果中的每条元组散列到相应的桶中，然后检查是否与该桶中已存在的元组重复。如果重复，则去掉这个元组，否则把该元组插入桶中。最终所有桶中的元组均为不重复的

#### 集合运算

并、差、交运算的实现常用方法类似排序合并法：
* 首先对参加运算的两个关系分别按照主键属性排序
* 排序后只需同时对两个关系执行一次扫描就可以生成计算结果

笛卡尔积通常使用嵌套循环法，操作代价非常高

## 关系数据库系统的查询优化

查询优化：对于相同的查询请求，有不同的查询策略。查询优化就是选择相对高效的查询策略。

关系系统的查询优化的优点：
* 用户不必考虑如何最好的表达查询以获得较高的效率
* 系统可以比用户程序的优化做的更好

RDBMS通过某种代价模型计算出各种查询执行策略的执行代价，然后选择代价最小的执行方案。

### 查询优化技术

查询优化的总目标：选择有效策略，求得给定关系表达式的值，使查询代价较小。
* 代数优化：是关系代数表达式的优化。按照一定的规则，改变代数表达式中操作的次序和组合，是查询执行更高效。
* 物理优化：选择高效合理的操作算法或存取路径，求得优化的查询计划
  * 基于存取路径的优化：基于启发式规则
  * 基于代价估算的优化：对于多个可选的查询策略，估算执行代价

## 代数优化

代数优化策略：通过对关系代数表达式的等价变换提高查询效率

关系代数表达式等价是指用相同的关系代替两个表达式中相应的关系所得到的结果是相同的，两个关系表达式$E_1$和$E_2$是等价的，可记为$‘E_1≡E_2$

### 关系代数的等价变换规则：

1. 连接、笛卡尔积交换律
2. 连接、笛卡尔积结合律：多个关系进行连接、笛卡尔积时顺序无关
3. 投影的串接定律：对同一个关系代数表达式的多个投影可以转换成其中最小的属性集的投影
4. 选择的串接定律：选择条件可以合并，一次选择可以检查所有条件（使用逻辑表达式）
5. 选择与投影的交换律：投影操作后的选择操作可以转换为选择操作后的投影操作
6. 选择与笛卡尔积的交换律：根据F可以将笛卡尔积放在选择操作的外面
7. 选择与并运算的分配律
8. 选择与差运算的分配律
9. 选择对自然连接的分配律
10. 投影与笛卡尔积的分配律
11. 投影与并的分配律

### 代数优化策略

1. 在关系代数表达式中尽可能早地执行选择操作
2. 投影运算和选择运算同时进行
3. 将投影运算与其前面或后面的双目运算结合
4. 把某些选择同在它前面要执行的笛卡尔积结合起来成为一个连接运算
5. 找出公共子表达式
   * 如果这种重复出现的子表达式的结果不是很大的关系并且从外存中读入这个关系比计算该子表达式的时间少得多，则先计算一次公共子表达式并把结果写入中间文件
   * 定义视图的表达式就是公共子表达式的情况

遵循这些启发式规则，应用关系代数等价变换公式来优化关系表达式的算法：

> * 算法：关系表达式的优化
> * 输入：一个关系表达式的查询树
> * 输出：优化的查询树
> * 方法：
>   1. 利用等价变换规则4把形如$\sigma_{F_1\wedge F_2\dots\wedge F_n}(E)$变换为$\sigma_{F_1}(\sigma_{F_2}(\dots(\sigma_{F_n}(E))\dots))$
>   2. 对每一个选择，利用等价变换规则4~9尽可能把它移到树的顶端
>   3. 对每一个投影利用等价变换规则3，5，10，11中的一般形式尽可能把它移向树的叶端
>      注：规则3使一些投影消失，规则5把一个投影分裂成两个，其中一个可能被移向树的叶端
>   4. 利用等价变换规则3~5把选择和投影的串接合并称单个选择，单个投影或一个选择后跟一个投影。使多个选择或投影能同时执行，或在一次扫描中全部完成
>   5. 把上述得到的语法树的内节点分组。每一双目运算和它所有的直接祖先为一组
>      如果其后代直到叶子全是单目运算，则也将他们并入该组
>      当双目运算是笛卡尔积，而且后面不是与它组成等值连接的选择时，则不能把选择与这个双目运算组成同一组，而是单独分为一组。

### 物理优化

物理优化就是要选择高效合理的操作算法或存取路径，求得优化的查询计划。

#### 基于存取路径的优化

1. 选择操作的启发式规则
   小关系：使用全表顺序扫描，即使选择列上有索引
   大关系：
   1. 对于选择条件是“主键=值”的查询，查询结果最多是一个元组，可以选择主键索引
   2. 对于选择条件是“非主属性=值”的查询，并且选择列上有索引
   3. 对于选择条件是属性上的非等值查询或者范围查询,并且选择列上有索引，与(2)类似
   4. 用AND连接的合取选择条件：
      如果有涉及这些属性的组合索引：优先采用组合索引扫描方法；
      如果某些属性上有一般的索引：则可以使用相应的索引扫描方法
      否则使用全表顺序扫描
   5. 用OR连接的析取选择条件，一般使用全表顺序扫描
2. 连接操作的启发式规则
